/*!
 * Player: Core of player routine.
 * Copyright (c) 2012-2016 Martin Borik <mborik@users.sourceforge.net>
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom
 * the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS
 * OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF
 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
var pMode={PM_NOT:0,PM_SONG:1,PM_POSITION:2,PM_SONG_OR_POS:3,PM_SAMPLE:4,PM_LINE:8,PM_SAMP_OR_LINE:12},pTone=function(){function a(){this.cent=0,this.oct=0,this.txt="---"}return Object.defineProperty(a.prototype,"word",{get:function(){return 255&this.cent|(7&this.oct)<<8},set:function(a){this.cent=255&a,this.oct=a>>8&7},enumerable:!0,configurable:!0}),a}(),pVolume=function(){function a(){this.L=0,this.R=0}return Object.defineProperty(a.prototype,"byte",{get:function(){return 15&this.L|(15&this.R)<<4},set:function(a){this.L=15&a,this.R=a>>4&15},enumerable:!0,configurable:!0}),a}(),pPosition=function(){function a(a,b){void 0===b&&(b=6);for(var c=0;6>c;c++)this.ch[c]={pattern:0,pitch:0};for(var c=0,d=0;96>=d;d++,c+=b)this.frames[d]=c;this.length=a,this.speed=b}return a.prototype.hasPattern=function(a){return this.indexOf(a)>=0},a.prototype.indexOf=function(a){for(var b=0,c=-1;0>c&&6>b;b++)this.ch[b].pattern===a&&(c=b);return c},a}(),Player=function(){function a(a){this.SAA1099=a,this.sample=[],this.ornament=[],this.playParams=[];var b=["B-","!C-","<C#","UD-","mD#","E-","F-","­F#","ÀG-","ÒG#","ãA-","óA#","ÿB-"];this.tones[0]=new pTone;var c,d,e,f;for(c=1,d=0,e=1;96>=c;c++,e++)this.tones[c].txt=b[e].substr(1)+(d+1),f=b[e].charCodeAt(0),255===f&&7!==d&&(d++,e=0),this.tones[c].oct=d,this.tones[c].cent=f;this.clearSong(),this.clearSamples(),this.clearOrnaments(),this.loopMode=!0,this.lastEnabledFreq=this.lastEnabledNoise=this.lastNoiseCharacter=0,this.stopChannel(0),this.mode=pMode.PM_NOT}return a.prototype.clearSong=function(){this.position=[],this.pattern=[],this.addNewPattern(),this.changedLine=!0,this.changedPosition=!0,this.currentPosition=0,this.repeatPosition=0,this.currentSpeed=6,this.currentLine=0,this.currentTick=0;for(var a=0;6>a;a++)this.clearPlayParams(a)},a.prototype.clearSamples=function(){for(var a=0;32>a;a++){this.sample[a]={name:"",data:[],loop:0,end:0,releasable:!1};for(var b=0;256>b;b++)this.sample[a].data[b]={volume:new pVolume,enable_freq:!1,enable_noise:!1,noise_value:0,shift:0}}},a.prototype.clearOrnaments=function(){for(var a=0;16>a;a++)this.ornament[a]={name:"",data:new Uint8Array(256),loop:0,end:0}},a.prototype.clearPlayParams=function(a){this.playParams[a]={tone:0,playing:!1,sample:this.sample[0],ornament:this.ornament[0],sample_cursor:0,ornament_cursor:0,attenuation:new pVolume,slideShift:0,globalPitch:0,released:!1,command:0,commandParam:0,commandPhase:0,commandValue1:0,commandValue2:0}},a.prototype.addNewPattern=function(){var a,b=this.pattern.length,c={data:[],end:0};for(a=0;96>a;a++)c.data[a]={tone:0,release:!1,smp:0,orn:0,orn_release:!1,volume:new pVolume,cmd:0,cmd_data:0};return this.pattern.push(c),b},a.prototype.prepareFrame=function(){if(this.mode!==pMode.PM_NOT){var b,c,d,e,f,g,h,i,j,k,l=new pVolume,m=0,n=0,o=this.lastEnabledFreq,p=this.lastEnabledNoise,q=this.lastNoiseCharacter,r=function(){return b.sample.data[b.sample_cursor]},s=function(){return b.ornament.data[b.ornament_cursor]};for(d=5;d>=0;d--)if(b=this.playParams[d],k=1<<d,e=d>>1,f=d/3,b.playing){switch(l["byte"]=r().volume["byte"],c=s(),g=r().noise_value|r().noise_value<<2,h=b.command,i=(240&b.commandParam)>>4,j=15&b.commandParam,h){case 1:case 2:!b.commandPhase&&b.commandParam&&(b.commandPhase=i),b.commandPhase&&!--b.commandPhase&&(b.slideShift+=j*(1&h?1:-1));break;case 3:!b.commandPhase&&b.commandParam&&(b.commandPhase=i),b.commandValue1&&b.commandPhase&&!--b.commandPhase&&(b.commandValue2>0?(b.slideShift+=j,b.slideShift>=b.commandValue2&&(b.tone=b.commandValue1,b.slideShift=b.commandValue1=b.commandValue2=0,h=-1)):(b.slideShift-=j,b.slideShift<=b.commandValue2&&(b.tone=b.commandValue1,b.slideShift=b.commandValue1=b.commandValue2=0,h=-1)));break;case 4:b.commandParam?(i?b.commandPhase=b.commandPhase+i&63:b.commandPhase=0,b.slideShift=a.vibratable[(j<<6)+b.commandPhase]):b.slideShift=0;break;case 5:if(b.commandParam){if(i?b.commandPhase=b.commandPhase+i&63:b.commandPhase=0,m=b.commandValue2,b.commandValue2=a.vibratable[(j<<6)+b.commandPhase],m=-(b.commandValue2-m),0==m)break;b.attenuation.L+m<0?b.attenuation.L=0:b.attenuation.L+m>15?b.attenuation.L=15:b.attenuation.L+=m,b.attenuation.R+m<0?b.attenuation.R=0:b.attenuation.R+m>15?b.attenuation.R=15:b.attenuation.R+=m}break;case 6:b.commandParam&&(b.commandPhase=b.commandParam,b.commandParam=0),b.commandPhase?(c=0,b.commandPhase--):(b.ornament_cursor=0,c=s(),h=-1);break;case 7:b.commandParam>0&&b.commandParam<b.ornament.end&&(c=0,b.ornament_cursor=b.commandParam),h=-1;break;case 9:b.commandParam>0&&(b.sample.releasable||b.commandParam<b.sample.end)&&(b.sample_cursor=b.commandParam,l=r().volume),h=-1;break;case 10:!b.commandPhase&&b.commandParam&&(b.commandPhase=i),b.commandPhase&&!--b.commandPhase&&(m=(7&b.commandParam)*(8&b.commandParam?-1:1),b.attenuation.L+m<0?b.attenuation.L=0:b.attenuation.L+m>15?b.attenuation.L=15:b.attenuation.L+=m,b.attenuation.R+m<0?b.attenuation.R=0:b.attenuation.R+m>15?b.attenuation.R=15:b.attenuation.R+=m);break;case 11:break;case 12:if(b.commandParam)if(15>i)switch(b.commandPhase){default:b.commandPhase=2;break;case 2:c+=i,b.commandPhase--;break;case 1:c+=j,b.commandPhase--}else 1&j&&(b.commandPhase=l.R,l.R=l.L,l.L=b.commandPhase,b.commandPhase=0);else b.commandPhase=0;break;case 14:2==i?(b.commandParam&=7,g=4^b.commandParam):(16&b.commandParam||(b.attenuation["byte"]=255),b.commandParam=(14&b.commandParam)<<1|129&b.commandParam,b.commandParam^=130,this.SAA1099.WriteAddressData(24+f,b.commandParam),h=-1);break;default:h=-1}if(0>h&&(b.command=0,b.commandParam=0,b.commandPhase=0),l.L=Math.max(0,l.L-b.attenuation.L),l.R=Math.max(0,l.R-b.attenuation.L),this.SAA1099.WriteAddressData(d,l["byte"]),b.tone){var t=this.calculateTone(d,b.tone,c,r().shift+b.slideShift);this.SAA1099.WriteAddressData(8+d,t.cent),n=1&d?t.oct<<4:n|t.oct}else 1&d&&(n=0);if(this.SAA1099.WriteAddressData(16+e,n),r().enable_freq&&(o|=k),4&g&&(p|=k,k=f<<2,q=q&240>>k|(3&g)<<k),b.sample_cursor+1>=b.sample.end){var u=d+1;b.sample.releasable&&b.released?0===++b.sample_cursor&&this.stopChannel(u):b.sample.loop===b.sample.end?this.mode&pMode.PM_SAMP_OR_LINE?this.stopChannel(u):b.sample_cursor=b.sample.end:this.mode===pMode.PM_LINE?this.stopChannel(u):b.sample_cursor=b.sample.loop}else b.sample_cursor++;b.ornament_cursor+1>=b.ornament.end?b.ornament_cursor=b.ornament.loop:b.ornament_cursor++}else 1&d&&(n=0),this.SAA1099.WriteAddressData(d,0),this.SAA1099.WriteAddressData(8+d,0),this.SAA1099.WriteAddressData(16+e,n),o&=255^k,p&=255^k;this.SAA1099.WriteAddressData(20,o),this.SAA1099.WriteAddressData(21,p),this.SAA1099.WriteAddressData(21,q),this.mode&pMode.PM_SAMP_OR_LINE&&0===(o|p)?(this.SAA1099.WriteAddressData(28,0),this.mode=pMode.PM_NOT):(this.SAA1099.WriteAddressData(28,1),this.mode&pMode.PM_LINE&&this.currentTick>0?this.currentTick--:this.mode&pMode.PM_SONG_OR_POS&&this.prepareLine())}},a.prototype.prepareLine=function(a){if(this.currentTick)return this.currentTick--,!0;if(this.currentPosition>=this.position.length)return!1;("undefined"==typeof a||a)&&(this.currentLine++,this.changedLine=!0);var b,c,d,e,f=this.position[this.currentPosition];if(this.currentLine>=f.length){if(this.mode===pMode.PM_SONG){if(this.currentPosition++,this.currentPosition>=this.position.length){if(!this.loopMode)return this.currentLine--,this.stopChannel(0),!1;this.currentPosition=this.repeatPosition}this.currentLine=0,this.changedPosition=!0,f=this.position[this.currentPosition]}else{if(!this.loopMode)return this.currentLine--,this.stopChannel(0),!1;this.currentLine=0}this.currentSpeed=f.speed}for(var g=0;6>g;g++)if(b=f.ch[g],d=this.pattern[b.pattern<this.pattern.length?b.pattern:0],!(this.currentLine>=d.end)){if(c=this.playParams[g],c.globalPitch=f.ch[g].pitch,c.playing=!0,e=d.data[this.currentLine],e.cmd)if(15==e.cmd&&e.cmd_data>0){if(this.currentSpeed=e.cmd_data,this.currentSpeed>=32){var h=(240&this.currentSpeed)>>4,i=15&this.currentSpeed;2>i||h==i?this.currentSpeed=h:1&this.currentLine&&(this.currentSpeed=h|i<<4)}c.command=c.commandParam=c.commandPhase=0}else c.command=e.cmd,c.commandParam=e.cmd_data,e.cmd!=c.command&&(c.commandPhase=0);else(e.tone||e.smp)&&(c.command=c.commandParam=c.commandPhase=0);if(e.volume["byte"]&&5!=c.command&&10!=c.command&&(c.attenuation["byte"]=~e.volume["byte"]),e.release)c.sample.releasable?c.released=!0:this.clearPlayParams(g);else{if(e.tone&&3==e.cmd&&e.cmd_data){c.commandValue1&&(c.tone=c.commandValue1,c.slideShift-=c.commandValue2);var j=this.calculateTone(g,c.tone,0,c.slideShift),k=this.calculateTone(g,e.tone,0,0),l=k.word-j.word;0===l?(c.tone=e.tone,c.commandValue1=c.commandValue2=0,c.command=c.commandParam=c.commandPhase=0):(c.commandValue1=e.tone,c.commandValue2=l+c.slideShift,c.commandPhase=(240&c.commandParam)>>4)}else e.tone&&(c.tone=e.tone,c.sample_cursor=0,c.ornament_cursor=0,c.slideShift=c.commandValue1=c.commandValue2=0);e.smp&&(c.sample=this.sample[e.smp],c.sample_cursor=0),e.orn?(c.ornament=this.ornament[e.orn],c.ornament_cursor=0):e.orn_release&&(c.ornament=this.ornament[0],c.ornament_cursor=0,(6==c.command||7==c.command)&&(c.command=c.commandParam=c.commandPhase=0))}}return this.currentSpeed>32?this.currentTick=1&this.currentLine?15&this.currentSpeed:(240&this.currentSpeed)>>4:this.currentTick=this.currentSpeed,this.currentTick--,!0},a.prototype.playLine=function(){return this.mode===pMode.PM_LINE&&this.currentTick>0?!1:(this.mode=pMode.PM_LINE,this.currentTick=0,this.prepareLine(!1))},a.prototype.playPosition=function(a,b,c){return("undefined"==typeof a||a)&&(this.currentPosition=0),("undefined"==typeof c||c)&&(this.currentLine=0),"undefined"==typeof b&&(b=!0),this.changedLine=!0,this.changedPosition=!0,this.currentPosition>=this.position.length?!1:(this.stopChannel(0),this.mode=b?pMode.PM_SONG:pMode.PM_POSITION,this.currentSpeed=this.position[this.currentPosition].speed,this.prepareLine(!1))},a.prototype.playSample=function(a,b,c,d){var e;if(d){if(--d>5)return 0;if((e=this.playParams[d]).playing)return 0}else{for(d=0;6>d&&this.playParams[d].playing;d++);if(6===d)return 0}return this.clearPlayParams(d),e.playing=!0,e.tone=++c,e.sample=this.sample[a],e.ornament=this.ornament[b],this.mode=pMode.PM_SAMPLE,++d},a.prototype.stopChannel=function(a){if(!(0>a||a>6)){if(0===a){for(;6>a;a++)this.clearPlayParams(a);return this.mode=pMode.PM_LINE,this.prepareFrame(),this.currentTick=0,void(this.changedLine=!0)}this.clearPlayParams(--a)}},a.prototype.calculateTone=function(a,b,c,d){for(var e=b+this.playParams[a].globalPitch+c;0>e;)e+=96;for(;e>=96;)e-=96;var f=this.tones[e];for(e=f.word+d;0>e;)e+=2048;for(;e>=2048;)e-=2048;return f.word=e,f},a.prototype.countPatternUsage=function(a){if(a>=this.pattern.length)return 0;for(var b=0,c=0,d=this.position.length;d>c;c++)for(var e=0;6>e;e++)this.position[c].ch[e].pattern===a&&b++;return b},a.prototype.countPositionFrames=function(a){var b,c,d,e,f,g=this.position.length;if("undefined"==typeof a||0>a)for(b=0;g>b;b++)this.countPositionFrames(b);else if(g>a){for(e=this.position[a].speed,b=0,d=0;96>d;d++){for(c=0;6>c;c++)if(f=this.pattern[this.position[a].ch[c].pattern].data[d],15===f.cmd&&f.cmd_data>0&&(e=f.cmd_data,e>=32)){var h=(240&e)>>4,i=15&e;2>i||h===i?e=h:1&d&&(e=h|i<<4)}this.position[a].frames[d]=b,b+=e>32?1&d?15&e:(240&e)>>4:e}this.position[a].frames[d]=b}},a.vibratable=[0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,1,1,1,1,0,0,0,-1,-1,-1,-1,-2,-2,-2,-2,-2,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-2,-2,-2,-2,-2,-1,-1,-1,-1,0,0,0,1,1,2,2,3,3,4,4,4,4,5,5,5,5,5,5,5,5,5,4,4,4,4,3,3,2,2,1,1,0,0,0,-1,-1,-2,-2,-3,-3,-4,-4,-4,-4,-5,-5,-5,-5,-5,-5,-5,-5,-5,-4,-4,-4,-4,-3,-3,-2,-2,-1,-1,0,0,1,1,2,3,3,4,4,5,5,6,6,6,7,7,7,7,7,7,7,6,6,6,5,5,4,4,3,3,2,1,1,0,-1,-1,-2,-3,-3,-4,-4,-5,-5,-6,-6,-6,-7,-7,-7,-7,-7,-7,-7,-6,-6,-6,-5,-5,-4,-4,-3,-3,-2,-1,-1,0,1,2,3,3,4,5,6,6,7,7,8,8,9,9,9,9,9,9,9,8,8,7,7,6,6,5,4,3,3,2,1,0,-1,-2,-3,-3,-4,-5,-6,-6,-7,-7,-8,-8,-9,-9,-9,-9,-9,-9,-9,-8,-8,-7,-7,-6,-6,-5,-4,-3,-3,-2,-1,0,1,2,3,4,5,6,7,8,9,9,10,10,11,11,11,11,11,11,11,10,10,9,9,8,7,6,5,4,3,2,1,0,-1,-2,-3,-4,-5,-6,-7,-8,-9,-9,-10,-10,-11,-11,-11,-11,-11,-11,-11,-10,-10,-9,-9,-8,-7,-6,-5,-4,-3,-2,-1,0,1,3,4,5,6,7,8,9,10,11,11,12,12,13,13,13,13,13,12,12,11,11,10,9,8,7,6,5,4,3,1,0,-1,-3,-4,-5,-6,-7,-8,-9,-10,-11,-11,-12,-12,-13,-13,-13,-13,-13,-12,-12,-11,-11,-10,-9,-8,-7,-6,-5,-4,-3,-1,0,1,3,4,6,7,8,10,11,12,12,13,14,14,15,15,15,15,15,14,14,13,12,12,11,10,8,7,6,4,3,1,0,-1,-3,-4,-6,-7,-8,-10,-11,-12,-12,-13,-14,-14,-15,-15,-15,-15,-15,-14,-14,-13,-12,-12,-11,-10,-8,-7,-6,-4,-3,-1,0,2,3,5,7,8,9,11,12,13,14,15,16,16,17,17,17,17,17,16,16,15,14,13,12,11,9,8,7,5,3,2,0,-2,-3,-5,-7,-8,-9,-11,-12,-13,-14,-15,-16,-16,-17,-17,-17,-17,-17,-16,-16,-15,-14,-13,-12,-11,-9,-8,-7,-5,-3,-2,0,2,4,6,7,9,11,12,13,15,16,17,18,18,19,19,19,19,19,18,18,17,16,15,13,12,11,9,7,6,4,2,0,-2,-4,-6,-7,-9,-11,-12,-13,-15,-16,-17,-18,-18,-19,-19,-19,-19,-19,-18,-18,-17,-16,-15,-13,-12,-11,-9,-7,-6,-4,-2,0,2,4,6,8,10,12,13,15,16,17,19,19,20,21,21,21,21,21,20,19,19,17,16,15,13,12,10,8,6,4,2,0,-2,-4,-6,-8,-10,-12,-13,-15,-16,-17,-19,-19,-20,-21,-21,-21,-21,-21,-20,-19,-19,-17,-16,-15,-13,-12,-10,-8,-6,-4,-2,0,2,4,7,9,11,13,15,16,18,19,20,21,22,23,23,23,23,23,22,21,20,19,18,16,15,13,11,9,7,4,2,0,-2,-4,-7,-9,-11,-13,-15,-16,-18,-19,-20,-21,-22,-23,-23,-23,-23,-23,-22,-21,-20,-19,-18,-16,-15,-13,-11,-9,-7,-4,-2,0,2,5,7,10,12,14,16,18,19,21,22,23,24,25,25,25,25,25,24,23,22,21,19,18,16,14,12,10,7,5,2,0,-2,-5,-7,-10,-12,-14,-16,-18,-19,-21,-22,-23,-24,-25,-25,-25,-25,-25,-24,-23,-22,-21,-19,-18,-16,-14,-12,-10,-7,-5,-2,0,3,5,8,10,13,15,17,19,21,22,24,25,26,26,27,27,27,26,26,25,24,22,21,19,17,15,13,10,8,5,3,0,-3,-5,-8,-10,-13,-15,-17,-19,-21,-22,-24,-25,-26,-26,-27,-27,-27,-26,-26,-25,-24,-22,-21,-19,-17,-15,-13,-10,-8,-5,-3,0,3,6,8,11,14,16,18,21,22,24,26,27,28,28,29,29,29,28,28,27,26,24,22,21,18,16,14,11,8,6,3,0,-3,-6,-8,-11,-14,-16,-18,-21,-22,-24,-26,-27,-28,-28,-29,-29,-29,-28,-28,-27,-26,-24,-22,-21,-18,-16,-14,-11,-8,-6,-3],a}();