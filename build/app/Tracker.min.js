/*!
 * SAA1099Tracker v1.1.7.
 * Copyright (c) 2012-2015 Martin Borik <mborik@users.sourceforge.net>
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom
 * the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS
 * OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF
 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
$(document).ready(function(){window.Tracker=new Tracker("1.1.7")});var STMFile=function(){function a(a){function b(){h=0,g.sort(function(a,b){b.timeModified-a.timeModified}),g.forEach(function(a){h+=2*(a.length+40)})}function c(){var b=e.currentLine;a.onCmdToggleEditMode(a.modeEdit),a.onCmdToggleLoop(e.loopMode),$("#scPattern").val(a.workingPattern.toString()),$("#scPosRepeat").val((e.repeatPosition+1).toString()),$("#scPosCurrent").val(e.currentPosition.toString()),a.updatePanels(),e.currentLine=b,a.updateTracklist(),$("#scSampleNumber").val(a.workingSample.toString(32).toUpperCase()),$("#scOrnNumber").val(a.workingOrnament.toString(16).toUpperCase()),$("#scOrnTestSample").val(a.workingOrnTestSample.toString(32).toUpperCase()),$("#scSampleTone,#scOrnTone").val(a.workingSampleTone.toString()).trigger("change"),$("#sbSampleScroll").scrollLeft(0),a.updateSampleEditor(!0),a.smpornedit.updateOrnamentEditor(!0),$("#main-tabpanel a").eq(a.activeTab).tab("show")}var d,e=a.player,f=a.settings,g=[],h=0;this.yetSaved=!1,this.modified=!1,this.fileName="",this.reloadStorage=function(){g.splice(0),d=-1;var a,c,e,f,h,i,j=localStorage.length;for(a=0;j>a;a++)if(c=localStorage.key(a).match(/^(stmf([0-9a-f]{3}))\-nfo/)){if(f=parseInt(c[2],16),e=c[1],h=localStorage.getItem(c[0]),i=localStorage.getItem(e+"-dat"),!i){localStorage.removeItem(c[0]);continue}if(!(c=h.match(/^(.+)\|(\d+?)\|(\d+?)\|(\d\d:\d\d)$/)))continue;d=Math.max(d,f),g.push({id:f,storageId:e,fileName:c[1],timeCreated:parseInt(c[2],10),timeModified:parseInt(c[3],10),duration:c[4],length:i.length})}b()},this.createJSON=function(b){var c,d,g,h,i,j,k,l,m,n={title:a.songTitle,author:a.songAuthor,samples:[],ornaments:[],patterns:[],positions:[],repeatPos:e.repeatPosition,current:{sample:a.workingSample,ornament:a.workingOrnament,ornSample:a.workingOrnTestSample,smpornTone:a.workingSampleTone,position:e.currentPosition,pattern:a.workingPattern,line:e.currentLine,channel:a.modeEditChannel,column:a.modeEditColumn},ctrl:{octave:a.ctrlOctave,sample:a.ctrlSample,ornament:a.ctrlOrnament,rowStep:a.ctrlRowStep},config:{interrupt:f.audioInterrupt,activeTab:a.activeTab,editMode:a.modeEdit,loopMode:e.loopMode},version:"1.2"};for(c=31;c>0;c--){for(k=e.sample[c],m=k.data,l={},k.name&&(l.name=k.name),l.loop=k.loop,l.end=k.end,k.releasable&&(l.rel=k.releasable),l.data=[],d=255;d>=0;d--)i=m[d],g=0|i.enable_freq|i.enable_noise<<1|i.noise_value<<2,(l.data.length||g||i.volume.byte||i.shift)&&(j=g.toHex(1)+i.volume.byte.toHex(2),i.shift&&(j=j.concat(i.shift<0?"-":"+",i.shift.toHex(3))),l.data.unshift(j.toUpperCase()));l.data.length||(l.data=null),null!==l.data||l.loop||l.end||l.rel||l.name||(l=null),(n.samples.length||null!==l)&&n.samples.unshift(l)}for(c=15;c>0;c--){for(k=e.ornament[c],l={},k.name&&(l.name=k.name),l.loop=k.loop,l.end=k.end,l.data=[],d=255;d>=0;d--)g=k.data[d],(l.data.length||g)&&l.data.unshift("".concat(0>g?"-":"+",("0"+g.abs().toString(10)).substr(-2)).toUpperCase());l.data.length||(l.data=null),null!==l.data||l.loop||l.end||l.name||(l=null),(n.ornaments.length||null!==l)&&n.ornaments.unshift(l)}for(c=1,h=e.pattern.length;h>c;c++){for(k=e.pattern[c],m=k.data,l={end:k.end},l.data=[],d=Player.maxPatternLen;d>0;)i=m[--d],g=i.orn_release?33:i.orn,j=i.release?"--":("0"+i.tone.toString(10)).substr(-2),(l.data.length||"00"!==j||i.smp||g||i.volume.byte||i.cmd||i.cmd_data)&&l.data.unshift(j.concat(i.smp.toString(32),g.toString(36),i.volume.byte.toHex(2),i.cmd.toHex(1),i.cmd_data.toHex(2)).toUpperCase());l.data.length||(l.data=null),null!==l.data||l.end||(l=null),(n.patterns.length||null!==l)&&n.patterns.push(l)}for(c=0,h=e.position.length;h>c;c++){for(k=e.position[c],m=k.ch,l={length:k.length,speed:k.speed,ch:[]},d=0;6>d;d++)g=m[d].pitch,j=("00"+m[d].pattern.toString(10)).substr(-3),g&&(j=j.concat(0>g?"-":"+",("0"+g.abs().toString(10)).substr(-2))),l.ch.push(j);n.positions.push(l)}return b?JSON.stringify(n,null,"	").replace(/\},\n\t+?\{/g,"}, {"):JSON.stringify(n)},this.parseJSON=function(b){if("string"==typeof b)try{var d=b;b=JSON.parse(d)}catch(a){return!1}if("object"!=typeof b)return!1;var g,h,i,j,k,l,m,n,o,p={smp:0,orn:0,pat:0,pos:0},q=!1;if(b.version&&"1.1"==b.version)q=!0;else if(!b.version||b.version&&"1.2"!=b.version)return!1;if(e.clearSong(),e.clearSamples(),e.clearOrnaments(),a.songTitle=b.title||"",a.songAuthor=b.author||"",b.samples&&b.samples.length)for(q&&b.samples.shift(),g=1;32>g;g++)if(n=b.samples[g-1]){if(m=e.sample[g],o=m.data,n.name&&(m.name=n.name),m.loop=n.loop||0,m.end=n.end||0,m.releasable=!!n.rel,q)for(k=atob(n.data),h=0,i=0,j=k.length;j>h&&32>i;h+=3,i++)l=255&k.charCodeAt(h+1),o=m.data[i],o.volume.byte=255&k.charCodeAt(h),o.enable_freq=!!(128&l),o.enable_noise=!!(64&l),o.noise_value=(48&l)>>4,o.shift=(7&l)<<8|255&k.charCodeAt(h+2),8&l&&(o.shift*=-1);else for(h=0,j=Math.min(256,n.data.length);j>h;h++)o=m.data[h],l=n.data[h],i=parseInt(l[0],16)||0,o.enable_freq=!!(1&i),o.enable_noise=!!(2&i),o.noise_value=i>>2,o.volume.byte=parseInt(l.substr(1,2),16)||0,o.shift=parseInt(l.substr(3),16)||0;p.smp++}if(b.ornaments&&b.ornaments.length)for(q&&b.ornaments.shift(),g=1;16>g;g++)if(n=b.ornaments[g-1]){if(m=e.ornament[g],o=m.data,n.name&&(m.name=n.name),m.loop=n.loop||0,m.end=n.end||0,q)for(k=atob(n.data),h=0,j=Math.min(256,k.length);j>h;h++)o[h]=k.charCodeAt(h);else for(k=n.data,h=0,j=Math.min(256,k.length);j>h;h++)o[h]=parseInt(k[h],10)||0;p.orn++}if(b.patterns&&b.patterns.length)for(q&&b.patterns.shift(),g=0;g<b.patterns.length;g++)if(n=b.patterns[g]){if(m=e.pattern[e.addNewPattern()],q)for(k=atob(n),m.end=255&k.charCodeAt(0),h=1,i=0,j=k.length;j>h&&i<Player.maxPatternLen;h+=5,i++)o=m.data[i],o.tone=127&k.charCodeAt(h),o.release=!!(128&k.charCodeAt(h)),o.smp=31&k.charCodeAt(h+1),o.orn_release=!!(128&k.charCodeAt(h+1)),o.volume.byte=255&k.charCodeAt(h+2),o.orn=15&k.charCodeAt(h+3),o.cmd=(240&k.charCodeAt(h+3))>>4,o.cmd_data=255&k.charCodeAt(h+4);else for(m.end=n.end||0,h=0,j=Math.min(Player.maxPatternLen,n.data.length);j>h;h++)l=n.data[h]||"",o=m.data[h],i=parseInt(l.substr(0,2),10),o.tone=isNaN(i)?(o.release=!0)&&0:i,i=parseInt(l[3],16),o.orn=isNaN(i)?(o.orn_release=!0)&&0:i,o.smp=parseInt(l[2],32)||0,o.volume.byte=parseInt(l.substr(4,2),16)||0,o.cmd=parseInt(l[6],16)||0,o.cmd_data=parseInt(l.substr(7),16)||0;p.pat++}if(b.positions&&b.positions.length)for(g=0;g<b.positions.length;g++)if(n=b.positions[g]){for(m=e.addNewPosition(n.length,n.speed),q&&(k=atob(n.ch)),h=0,i=0;6>h;h++)q?(m.ch[h].pattern=255&k.charCodeAt(i++),m.ch[h].pitch=k.charCodeAt(i++)):(l=n.ch[h],m.ch[h].pattern=parseInt(l.substr(0,3),10)||0,m.ch[h].pitch=parseInt(l.substr(3),10)||0);e.countPositionFrames(g),e.storePositionRuntime(g),p.pos++}return q&&"object"==typeof b.config?(k=b.config,e.repeatPosition=k.repeatPosition||0,e.currentPosition=k.currentPosition||0,e.currentLine=k.currentLine||0,a.activeTab=0,a.modeEdit=!1,a.modeEditColumn=0,a.modeEditChannel=k.editChannel||0,a.ctrlOctave=k.ctrlOctave||2,a.ctrlSample=k.ctrlSample||0,a.ctrlOrnament=k.ctrlOrnament||0,a.ctrlRowStep=k.ctrlRowStep||0,f.audioInterrupt=k.audioInterrupt||50):"object"==typeof b.current&&(k=b.current,e.repeatPosition=b.repeatPos||0,e.currentPosition=k.position||0,e.currentLine=k.line||0,a.workingPattern=k.pattern||0,a.workingSample=k.sample||1,a.workingOrnament=k.ornament||1,a.workingOrnTestSample=k.ornSample||1,a.workingSampleTone=k.smpornTone||37,a.modeEditChannel=k.channel||0,a.modeEditColumn=k.column||0,k=$.extend({},b.ctrl,b.config),e.loopMode=k.loopMode||!0,a.ctrlOctave=k.octave||2,a.ctrlSample=k.sample||0,a.ctrlOrnament=k.ornament||0,a.ctrlRowStep=k.rowStep||0,a.activeTab=k.activeTab||0,a.modeEdit=k.editMode||!1,f.audioInterrupt=k.interrupt||50),c(),!0},this.new=function(){e.clearSong(),e.clearSamples(),e.clearOrnaments(),a.songTitle="",a.songAuthor="",e.currentPosition=0,e.repeatPosition=0,e.currentLine=0,a.modeEdit=!1,a.modeEditChannel=0,a.modeEditColumn=0,a.workingPattern=0,this.modified=!1,this.yetSaved=!1,this.fileName="",c()},this.loadDemosong=function(a){var b=this;$.getJSON("demosongs/"+a+".json",function(a){b.parseJSON(a),b.modified=!0,b.yetSaved=!1,b.fileName=""})},this.loadFile=function(a){var b,c,d,e,f=g.length;for("string"==typeof a&&(c=a.replace(/[\.\\\/\":*?%<>|\0-\37]+/g,"").trim()),b=0;f>b&&(d=g[b],!c||d.fileName!==c);b++)if(!c&&"number"==typeof a&&d.id===a){c=d.fileName;break}return b===f?!1:(e=localStorage.getItem(d.storageId+"-dat"),e=LZString.decompressFromUTF16(e),this.parseJSON(e)?(e=null,this.modified=!1,this.yetSaved=!0,this.fileName=c,!0):!1)},this.saveFile=function(a,c,e){var f,h,i,j=g.length,k=~~(Date.now()/1e3),l=!1;for(a=a.replace(/[\.\\\/\":*?%<>|\0-\37]+/g,""),f=0;j>f;f++)if(h=g[f],h.id===e||h.fileName===a){l=!0;break}return void 0===e||l?(i=this.createJSON(),i=LZString.compressToUTF16(i),l?(h=g[f],h.fileName=a,h.timeModified=k,h.duration=c,h.length=i.length):h={id:++d,storageId:"stmf"+d.toHex(3),fileName:a,timeCreated:k,timeModified:k,duration:c,length:i.length},localStorage.setItem(h.storageId+"-nfo",a.concat("|",h.timeCreated.toString(),"|",h.timeModified.toString(),"|",h.duration)),localStorage.setItem(h.storageId+"-dat",i),i=null,l||g.push(h),b(),this.yetSaved=!0,this.modified=!1,this.fileName=h.fileName,!0):!1},this.dialog=function(b){var c=$("#filedialog"),d=this,e=this.fileName||a.songTitle||"Untitled",f="save"===b,i={load:"Open file from storage",save:"Save file to storage"};return i[b]&&(f||g.length)?(a.globalKeyState.inDialog=!0,void c.on("show.bs.modal",function(){var j=Math.ceil(100/(2097152/h)),k=null,l=function(){if(f){var b=c.find(".file-name>input").val(),e=$("#stInfoPanel u:eq(3)").text();d.saveFile(b,e,k&&k.id||void 0)}else{if(!k)return!1;d.loadFile(k.id)}return a.globalKeyState.inDialog=!1,c.modal("hide"),!0},m=function(a){return a.stopPropagation(),k=a.data&&"number"==typeof a.data.id?g[a.data.id]:null,0===a.pageX&&0===a.pageY?l():(c.find(".file-list>button").removeClass("selected"),k&&$(this).addClass("selected"),f&&(k&&c.find(".file-name>input").val(k.fileName),c.find(".file-remove").prop("disabled",!k)),!0)};c.addClass(b).before($("<div/>").addClass("modal-backdrop in").css("z-index","1030")),c.find(".modal-title").text(i[b]+"\u2026"),c.find(".file-name>input").val(e),c.find(".storage-usage i").text(h+" bytes used"),c.find(".storage-usage .progress-bar").css("width",j+"%"),c.find(".btn-success").on("click",l);var n,o,p,q=g.length,r=c.find(".file-list").empty(),s=$("<span/>"),t=$('<button class="cell"/>');for(n=0;q>n;n++)o=g[n],p=new Date(1e3*o.timeModified).toISOString().replace(/^([\d\-]+)T([\d:]+).+$/,"$1 $2"),t.clone().append(s.clone().addClass("filename").text(o.fileName)).append(s.clone().addClass("fileinfo").text(p+" | duration: "+o.duration)).prop("tabindex",300).appendTo(r).on("click focus",{id:n},m).on("dblclick",l);c.find(".file-open,.file-save").on("click",l),f&&(c.find(".file-list").on("click",m),c.find(".file-remove").on("click",function(a){return a.stopPropagation(),k?($("#dialoque").confirm({title:"Remove file\u2026",text:"Do you really want to remove this file from storage?",buttons:"yesno",style:"danger",callback:function(e){if("yes"===e)for(var f=0,h=g.length;h>f;f++)if(g[f].storageId===k.storageId)return g.splice(f,1),localStorage.removeItem(k.storageId+"-nfo"),localStorage.removeItem(k.storageId+"-dat"),m(a),c.modal("hide"),void d.dialog(b)}}),!0):!1}),c.find(".file-download").on("click",function(a){a.stopPropagation();var b,f,g=$(this),h=d.createJSON(!0),i="text/x-saa1099tracker",j=c.find(".file-name>input").val().trim()||e;try{b=new Blob([h],{type:i,endings:"native"})}catch(a){try{var k=getCompatible(window,"BlobBuilder",!0);k.append(h),b=k.getBlob(i)}catch(a){b=void 0,f="data:"+i+";base64,"+btoa(h)}}if(b)try{f=getCompatible(window,"URL").createObjectURL(b)+""}catch(a){f="data:"+i+";base64,"+btoa(h)}return g.attr({href:f,download:j+".STMF.json"}),h=null,f=null,c.modal("hide"),setTimeout(function(){g.attr({href:"",download:""})},50),!0}))}).on("shown.bs.modal",function(){c.find(f?".file-name>input":".file-list>button:first-child").focus()}).on("hide.bs.modal",function(){c.removeClass(b).prev(".modal-backdrop").remove(),c.off().find(".file-list").off().empty(),c.find(".modal-footer>.btn").off(),a.globalKeyState.inDialog=!1}).modal({show:!0,backdrop:!1})):!1},this.reloadStorage()}return a}(),TracklistPosition=function(){function a(b,c,d,e,f,g){this.y=b||0,this.line=c||0,this.channel=d||0,this.column=e||0,this.start={x:f||0,y:g||0},this.set=function(b){if(!(b instanceof a))throw"invalid object type";this.y=b.y,this.line=b.line,this.channel=b.channel,this.column=b.column,this.start.x=b.start.x,this.start.y=b.start.y},this.compare=function(b){return b instanceof a?this.y===b.y&&this.line===b.line&&this.channel===b.channel&&this.column===b.column:void 0}}return a}(),Tracklist=function(){function a(a){this.initialized=!1,this.obj=null,this.ctx=null,this.zoom=2,this.canvasData={columns:[0,24,30,36,42,54,60,66],selWidth:78,chnWidth:84,lineWidth:516,center:0,trkOffset:0,vpad:0,offset:null},this.offsets={x:[new Array(9),new Array(9),new Array(9),new Array(9),new Array(9),new Array(9)],y:[]},this.selection={isDragging:!1,start:new TracklistPosition,len:0,line:0,channel:0},this.countTracklines=function(){var b=$("#statusbar").offset(),c=$("#tracklist").offset(),d=a.settings.tracklistLineHeight;return Math.max(((b.top-c.top)/d/this.zoom|1)-2,5)},this.setHeight=function(b){var c=a.settings;void 0===b&&(b=c.tracklistAutosize?this.countTracklines():c.tracklistLines),c.tracklistLines=b,b*=c.tracklistLineHeight,$(this.obj).prop("height",b).css({height:b*this.zoom}),this.canvasData.offset=$(this.obj).offset()},this.moveCurrentline=function(b,c){var d=a.player,e=d.currentLine+b,f=d.currentPosition,g=d.position[f];a.modePlay||void 0===g||(c?e=Math.min(Math.max(e,0),g.length-1):0>e?e+=g.length:e>=g.length&&(e-=g.length),d.currentLine=e)},this.pointToTracklist=function(b,c){var d,e,f,g=a.settings.tracklistLines,h=b/this.zoom,i=c/this.zoom,j=g>>1,k=a.player.currentLine-j;for(d=0;g>d;d++,k++)if(i>=this.offsets.y[d]&&i<=this.offsets.y[d+1])for(f=0;6>f;f++)if(h>=this.offsets.x[f][0]&&h<=this.offsets.x[f][8])for(e=0;8>e;e++)if(h>=this.offsets.x[f][e]&&h<=this.offsets.x[f][e+1])return new TracklistPosition(d,Math.max(k,0),f,e,b,c)}}return a}(),SmpOrnEditor=function(){function a(a){this.initialized=!1,this.img=null,this.amp={obj:null,ctx:null},this.noise={obj:null,ctx:null},this.range={obj:null,ctx:null},this.smpeditOffset=null,this.smpeditScroll=0,this.columnWidth=0,this.halfing=0,this.centering=0,this.radix=10,this.drag={isDragging:!1,freqEnableState:!1,rangeStart:-1},this.init=function(){var b,c,d,e,f,g,h,i=["amp","noise","range"];for(b=0,c=i.length;c>b;b++)d=this[i[b]],e=d.ctx,f=d.obj.width,g=d.obj.height,h=g>>1,e.miterLimit=0,e.fillStyle="#fcfcfc",e.fillRect(0,0,22,g),e.fillStyle="#ccc",e.fillRect(22,0,1,g),0===b&&(this.halfing=h-=12,this.columnWidth=(f-26)/64|0,this.centering=26+(f-64*this.columnWidth)>>1,e.fillRect(22,h,f-22,1),e.fillRect(22,286,f-22,1),e.save(),e.font=$("label").first().css("font"),e.translate(12,h),e.rotate(-Math.PI/2),e.textBaseline="middle",e.fillStyle="#888",e.textAlign="right",e.fillText("RIGHT",-16,0),e.textAlign="left",e.fillText("LEFT",16,0),e.restore()),e.drawImage(this.img,16*b,0,16,16,4,h-8,16,16);this.updateOffsets(),this.createPitchShiftTable(),this.createOrnamentEditorTable(),a.updateSampleEditor(!0),this.initialized=!0},this.updateOffsets=function(){var a=$(this.amp.obj).offset(),b=$(this.noise.obj).offset();this.smpeditOffset={left:0|a.left,top:{amp:0|a.top,noise:0|b.top}}},this.updateSamplePitchShift=function(){var b,c=a.player.sample[a.workingSample],d=c.end===c.loop;$("#fxSampleShift>.cell").each(function(a,e){b=c.data[a],a>=c.end&&!c.releasable?e.className="cell":!d&&a>=c.loop&&a<c.end?e.className="cell loop":e.className="cell on",$(e).find("input").val(parseInt(b.shift,this.radix))}),$("#fxSampleShift").parent().scrollLeft(0)},this.createPitchShiftTable=function(){var b,c,d=$("#fxSampleShift").empty(),e=$('<div class="cell"/>'),f=$('<input type="text" class="form-control">');for(b=0;256>b;b++)c=f.clone(),e.clone().append(c).appendTo(d),c.TouchSpin({prefix:b.toWidth(3),radix:this.radix=a.settings.hexSampleFreq?16:10,initval:0,min:-1023,max:1023}).change({index:b},function(b){var c=a.settings.hexSampleFreq?16:10,d=a.player.sample[a.workingSample],e=d.data,f=b.target;e[b.data.index].shift=parseInt(f.value,c)}).prop("tabindex",b+9)},this.chords={maj:{sequence:[0,4,7],name:"major"},min:{sequence:[0,3,7],name:"minor"},maj7:{sequence:[0,4,7,11],name:"major 7th"},min7:{sequence:[0,3,7,10],name:"minor 7th"},sus2:{sequence:[0,2,7],name:"suspended 2nd"},sus4:{sequence:[0,5,7],name:"suspended 4th"},6:{sequence:[0,4,7,9],name:"major 6th"},7:{sequence:[0,4,7,10],name:"dominant 7th"},add9:{sequence:[0,2,4,7],name:"added 9th"},min7b5:{sequence:[0,3,6,12],name:"minor 7th with flatted 5th"},aug:{sequence:[0,4,10],name:"augmented"},dim:{sequence:[0,3,6,9],name:"diminished"},"12th":{sequence:[12,0],name:"12th"}},this.updateOrnamentEditor=function(b){var c=a.player.ornament[a.workingOrnament],d=c.end===c.loop;$("#fxOrnEditor>.cell").each(function(a,b){a>=c.end?b.className="cell":!d&&a>=c.loop&&a<c.end?b.className="cell loop":b.className="cell on",$(b).find("input").val(c.data[a])}),b&&($("#txOrnName").val(c.name),$("#fxOrnEditor").parent().scrollLeft(0),$("#scOrnLength").val(""+c.end),$("#scOrnRepeat").val(""+(c.end-c.loop)).trigger("touchspin.updatesettings",{min:0,max:c.end}))},this.createOrnamentEditorTable=function(){var b,c,d=$("#fxOrnEditor").empty(),e=$('<div class="cell"/>'),f=$('<input type="text" class="form-control">');for(b=0;256>b;b++)c=f.clone(),e.clone().append(c).appendTo(d),c.TouchSpin({prefix:b.toWidth(3),initval:0,min:-60,max:60}).change({index:b},function(b){var c=a.player.ornament[a.workingOrnament],d=b.target;c.data[b.data.index]=parseInt(d.value,10)}).prop("tabindex",31)}}return a}(),Tracker=function(){function a(a){this.version=a,this.loaded=!1,this.activeTab=null,this.modePlay=!1,this.modeEdit=!1,this.modeEditChannel=0,this.modeEditColumn=0,this.workingPattern=0,this.workingSample=1,this.workingSampleTone=37,this.workingOrnament=1,this.workingOrnTestSample=1,this.ctrlOctave=2,this.ctrlSample=0,this.ctrlOrnament=0,this.ctrlRowStep=0,this.songTitle="",this.songAuthor="",this.globalKeyState={inDialog:!1,modsHandled:!1,lastPlayMode:0,length:0},this.settings={tracklistAutosize:!0,tracklistLines:17,tracklistLineHeight:9,hexTracklines:!0,hexSampleFreq:!1,audioInterrupt:50,audioBuffers:0},this.pixelfont={obj:null,ctx:null},this.tracklist=new Tracklist(this),this.smpornedit=new SmpOrnEditor(this),AudioDriver?(this.player=new Player(new SAASound(AudioDriver.sampleRate)),AudioDriver.init(this.player)):$("#overlay>span").html(browser.isIE?"don't be evil,<br>stop using IE":"WebAudio<br>not supported"),this.player&&(this.file=new STMFile(this),this.populateGUI(),this.initializeGUI())}return a.prototype.baseTimer=function(){this.modePlay&&this.player.changedLine&&(this.player.changedPosition&&this.updatePanelPosition(),this.updatePanelInfo(),this.updateTracklist(),this.player.changedPosition=!1,this.player.changedLine=!1)},a}();Tracker.prototype.updatePanels=function(){$("#scOctave").val(this.ctrlOctave),$("#scAutoSmp").val(this.ctrlSample),$("#scAutoOrn").val(this.ctrlOrnament),$("#scRowStep").val(this.ctrlRowStep),$("#txHeaderTitle").val(this.songTitle),$("#txHeaderAuthor").val(this.songAuthor),this.updatePanelInfo(),this.updatePanelPattern(),this.updatePanelPosition()},Tracker.prototype.updateEditorCombo=function(a){void 0===a&&(this.player.playLine(),a=this.ctrlRowStep),this.tracklist.moveCurrentline(a),this.updateTracklist(),this.updatePanelInfo()},Tracker.prototype.updatePanelInfo=function(){var a,b=this.player,c=$("#stInfoPanel u"),d=this.settings.audioInterrupt,e=0,f=0,g=b.currentPosition,h=b.position.length,i=b.position[g],j=null,k=b.currentLine,l=-2&k,m=60*d;if(h){for(a=m/(i.frames[l+2]-i.frames[l])>>1,m=0;h>m;m++)j=b.position[m],m===g&&(f=e),e+=j.frames[j.length];f+=i.frames[k],m=e.toString().length,c[4].textContent=f.toWidth(m),c[5].textContent=e.toWidth(m),c[2].textContent=(f/d).toTimeString(),c[3].textContent=(e/d).toTimeString()}else a=m/this.player.currentSpeed>>2,c[2].textContent=c[3].textContent=0..toTimeString(),c[4].textContent=c[5].textContent="0";c[0].textContent=a,c[1].textContent=d},Tracker.prototype.updatePanelPattern=function(){var a,b=["#scPattern","#scPatternLen","#btPatternDelete","#btPatternClean","#btPatternInfo"],c=$(b[0]).prop("disabled"),d=this.workingPattern,e=this.player.pattern.length,f=0,g=0,h=!0;for(e--,e?(f=1,g=e,d=Math.max(Math.min(d,g),f)):d=0,a=1;6>=a;a++)$("#scChnPattern"+a).trigger("touchspin.updatesettings",{min:0,max:g});if(d?(h=!1,$(b[1]).val(this.player.pattern[d].end)):$(b[1]).val(64),this.workingPattern=d,$(b[0]).trigger("touchspin.updatesettings",{min:f,max:g,initval:d}).val(d),$("#txPatternUsed").val(this.player.countPatternUsage(d)),$("#txPatternTotal").val(e),h!==c)for(a=0,e=b.length;e>a;a++)$(b[a]+","+b[a]+"~span>button").prop("disabled",h)},Tracker.prototype.updatePanelPosition=function(){var a,b,c=["#scPosCurrent","#scPosLength","#scPosSpeed","#txPosTotal","#scPosRepeat"],d=$(c[0]).prop("disabled"),e=this.player.nullPosition,f=this.player.position.length,g=this.player.currentPosition,h=!0;for(f?(h=!1,$(c[0]+","+c[4]).trigger("touchspin.updatesettings",{min:1,max:f}),$(c[0]).val(g+1),$(c[3]).val(f),$(c[4]).val(this.player.repeatPosition+1),e=this.player.position[g]):($(c[0]+","+c[4]).val(0).trigger("touchspin.updatesettings",{min:0,max:0}),$(c[3]).val(0)),$(c[1]).val(e.length),$(c[2]).val(e.speed),b=0;6>b;b++)c.push(a="#scChnPattern"+(b+1)),$(a).val(e.ch[b].pattern),c.push(a="#scChnTrans"+(b+1)),$(a).val(e.ch[b].pitch);if(h!==d)for(c.splice(3,1),b=0,f=c.length;f>b;b++)$(c[b]+","+c[b]+"~span>button").prop("disabled",h);e=null},Tracker.prototype.onCmdFileNew=function(){var a=this.globalKeyState,b=this.file;!this.modePlay&&(b.yetSaved||b.modified||b.fileName)&&(a.inDialog=!0,$("#dialoque").confirm({title:"Create new file\u2026",text:"Do you really want to clear all song data and lost all of your changes?",buttons:"yesno",style:"danger",callback:function(c){a.inDialog=!1,"yes"===c&&b.new()}}))},Tracker.prototype.onCmdFileOpen=function(){if(!this.modePlay){var a=this.globalKeyState,b=this.file;b.modified?(a.inDialog=!0,$("#dialoque").confirm({title:"Open file\u2026",text:"You should lost all of your changes! Do you really want to continue?",buttons:"yesno",style:"warning",callback:function(c){a.inDialog=!1,"yes"===c&&b.dialog("load")}})):b.dialog("load")}},Tracker.prototype.onCmdFileSave=function(a){if(!this.modePlay&&this.player.position.length){var b=this.file;a||!b.yetSaved||b.modified?b.dialog("save"):!a&&b.yetSaved&&b.fileName&&b.saveFile(b.fileName,$("#stInfoPanel u:eq(3)").text())}},Tracker.prototype.onCmdStop=function(){this.player.stopChannel(),this.modePlay=!1,this.globalKeyState.lastPlayMode=0,0===this.activeTab&&this.updateTracklist(!0)},Tracker.prototype.onCmdSongPlay=function(){2!==this.globalKeyState.lastPlayMode&&(0===this.activeTab&&this.doc.setStatusText(),this.modeEdit&&this.player.storePositionRuntime(this.player.currentPosition),this.modePlay=this.player.playPosition(!1,!0,!0))},Tracker.prototype.onCmdSongPlayStart=function(){0===this.activeTab&&this.doc.setStatusText(),this.modeEdit&&this.player.storePositionRuntime(this.player.currentPosition),this.modePlay=this.player.playPosition(!0,!0,!0)},Tracker.prototype.onCmdPosPlay=function(){1!==this.globalKeyState.lastPlayMode&&(0===this.activeTab&&this.doc.setStatusText(),this.modeEdit&&this.player.storePositionRuntime(this.player.currentPosition),this.modePlay=this.player.playPosition(!1,!1,!1))},Tracker.prototype.onCmdPosPlayStart=function(){0===this.activeTab&&this.doc.setStatusText(),this.modeEdit&&this.player.storePositionRuntime(this.player.currentPosition),this.modePlay=this.player.playPosition(!1,!1,!0)},Tracker.prototype.onCmdToggleLoop=function(a){var b="boolean"==typeof a?a:this.player.loopMode=!this.player.loopMode,c=$("a#miToggleLoop>span"),d="glyphicon-repeat",e="glyphicon-remove-circle",f=b?d:e,g=b?"#000":"#ccc";c.removeClass(d+" "+e),c.addClass(f).css({color:g})},Tracker.prototype.onCmdToggleEditMode=function(a){var b="boolean"==typeof a?a:this.modeEdit=!this.modeEdit,c=$(".tracklist-panel");b||(this.doc.setStatusText(),this.player.storePositionRuntime(this.player.currentPosition)),c[b?"addClass":"removeClass"]("edit"),this.updateTracklist(!0)},Tracker.prototype.onCmdShowDocumentation=function(a){var b="doc/"+a+".txt",c=this.doc.txtCache,d=this.globalKeyState,e=c[a],f=$("#documodal"),g=$("<button/>").attr({type:"button",class:"close","data-dismiss":"modal"}).text("\xd7");e?(d.inDialog=!0,f.modal("show").find(".modal-body").html(e).prepend(g).on("hidden.bs.modal",function(){d.inDialog=!1,$(this).find(".modal-body").empty()})):$.ajax(b,{cache:!0,contentType:"text/plain",dataType:"text",isLocal:!0,success:function(b){b=("<pre>\n"+b+"</pre>").replace(/\s*?^\=\=\s*([^\=]+?)\s*[\=\s]+$/gm,"</pre><h3>$1</h3><pre>").replace(/<pre><\/pre>/g,""),c[a]=b,f.modal("show").find(".modal-body").html(b).prepend(g).on("hidden.bs.modal",function(){d.inDialog=!1,$(this).find(".modal-body").empty()})}})},Tracker.prototype.onCmdAbout=function(){var a=this.globalKeyState,b=$("#about"),c=b.data();c.hasOwnProperty("bs.modal")||b.on("show.bs.modal",function(){a.inDialog=!0}).on("hidden.bs.modal",function(){a.inDialog=!1}).find(".ver").text("v"+this.version),b.modal("toggle")},Tracker.prototype.onCmdPatCreate=function(){if(!this.modePlay){var a=this.player.addNewPattern(),b=this.player.pattern[a],c=this.workingPattern&&this.player.pattern[this.workingPattern].end||64;b.end=c,this.workingPattern=a,this.updatePanelPattern(),this.file.modified=!0,$("#scPatternLen").focus()}},Tracker.prototype.onCmdPatDelete=function(){if(!this.modePlay&&this.workingPattern){var a=this,b=this.player,c=this.workingPattern,d=this.globalKeyState,e=b.pattern.length-1,f=null;b.countPatternUsage(c)>0&&(f="This pattern is used in some positions!\nAre you sure you want to delete it?"),c!==e&&(f="This is not the last pattern in a row and there is necessary to renumber all of the next patterns in the positions!\n\nPlease, take a note that all of your undo history will be lost because of pattern/position data inconsistency that occurs with this irreversible operation.\n\nDo you really want to continue?"),f||(f="Are you sure you want to delete this pattern?"),d.inDialog=!0,$("#dialoque").confirm({title:"Delete pattern\u2026",text:f,buttons:"yesno",style:c!==e?"warning":"info",callback:function(f){if(d.inDialog=!1,"yes"===f){for(var g,h,i=0,j=b.position.length;j>i;i++)for(g=b.position[i],h=0;6>h;h++)g.ch[h].pattern===c?g.ch[h].pattern=0:g.ch[h].pattern>c&&g.ch[h].pattern--;b.pattern.splice(c,1),c===e&&c--,a.workingPattern=c,a.updatePanelInfo(),a.updatePanelPattern(),a.updatePanelPosition(),a.updateTracklist(),a.file.modified=!0}}})}},Tracker.prototype.onCmdPatClean=function(){if(!this.modePlay&&this.workingPattern){var a=this,b=this.globalKeyState,c=this.player.pattern[this.workingPattern].data;b.inDialog=!0,$("#dialoque").confirm({title:"Clean pattern\u2026",text:"Are you sure you want to clean a content of this pattern?",buttons:"yesno",style:"info",callback:function(d){if(b.inDialog=!1,"yes"===d){for(var e=0,f=c[e];e<Player.maxPatternLen;e++,f=c[e])f.tone=0,f.release=!1,f.smp=0,f.orn=0,f.orn_release=!1,f.volume.byte=0,f.cmd=0,f.cmd_data=0;a.updatePanelInfo(),a.updateTracklist(),a.file.modified=!0}}})}},Tracker.prototype.onCmdPatInfo=function(){},Tracker.prototype.onCmdPosCreate=function(){if(!this.modePlay){var a=this.player,b=a.position.length,c=a.position[a.currentPosition]||a.nullPosition;a.addNewPosition(c.length,c.speed),a.currentPosition=b,a.currentLine=0,this.updatePanelInfo(),this.updatePanelPosition(),this.updateTracklist(),this.file.modified=!0}},Tracker.prototype.onCmdPosInsert=function(){if(!this.modePlay){if(!this.player.position.length)return this.onCmdPosCreate();var a,b=this.player,c=b.currentPosition,d=b.position[c]||b.nullPosition,e=b.addNewPosition(d.length,d.speed,!1);for(a=0;6>a;a++)e.ch[a].pattern=d.ch[a].pattern,e.ch[a].pitch=d.ch[a].pitch;b.position.splice(c,0,e),b.countPositionFrames(c),b.storePositionRuntime(c),b.currentLine=0,this.updatePanelInfo(),this.updatePanelPattern(),this.updatePanelPosition(),this.updateTracklist(),this.file.modified=!0}},Tracker.prototype.onCmdPosDelete=function(){if(!this.modePlay&&this.player.position.length){var a=this.globalKeyState,b=this.player.currentPosition,c=this;a.inDialog=!0,$("#dialoque").confirm({title:"Delete position\u2026",text:"Are you sure you want to delete this position?",buttons:"yesno",style:"info",callback:function(d){a.inDialog=!1,"yes"===d&&(c.player.currentLine=0,c.player.position.splice(b,1),b>=c.player.position.length&&c.player.currentPosition--,c.updatePanelInfo(),c.updatePanelPattern(),c.updatePanelPosition(),c.updateTracklist(),c.file.modified=!0)}})}},Tracker.prototype.onCmdPosMoveUp=function(){var a=this.player,b=a.currentPosition,c=a.position[b];!this.modePlay&&a.position.length&&b&&(a.position[b]=a.position[--b],a.position[b]=c,a.currentPosition=b,a.currentLine=0,this.updatePanelInfo(),this.updatePanelPosition(),this.updateTracklist(),this.file.modified=!0)},Tracker.prototype.onCmdPosMoveDown=function(){var a=this.player,b=a.currentPosition,c=a.position.length,d=a.position[b];!this.modePlay&&c&&b!==c-1&&(a.position[b]=a.position[++b],a.position[b]=d,a.currentPosition=b,a.currentLine=0,this.updatePanelInfo(),this.updatePanelPosition(),this.updateTracklist(),this.file.modified=!0)},Tracker.prototype.onCmdSmpPlay=function(){this.player.playSample(this.workingSample,0,this.workingSampleTone)},Tracker.prototype.onCmdSmpClear=function(){var a=this,b=this.player.sample[this.workingSample];this.globalKeyState.inDialog=!0,$("#dialoque").confirm({title:"Clear sample\u2026",text:"Which sample data do you want to clear?",style:"warning",buttons:[{caption:"All",id:7},{caption:"Amplitude",id:1},{caption:"Noise",id:2},{caption:"Pitch-shift",id:4},{caption:"Cancel",id:"cancel"}],callback:function(c){if(a.globalKeyState.inDialog=!1,"cancel"!==c){var d,e=b.data,f=7===c;for(d=0;256>d;d++)1&c&&(e[d].volume.byte=0,e[d].enable_freq=!1),2&c&&(e[d].enable_noise=!1,e[d].noise_value=0),4&c&&(e[d].shift=0);f&&(b.name="",b.loop=0,b.end=0,b.releasable=!1),a.updateSampleEditor(f),4&c&&a.smpornedit.updateSamplePitchShift(),a.file.modified=!0}}})},Tracker.prototype.onCmdSmpSwap=function(){for(var a,b=this.player.sample[this.workingSample].data,c=0;256>c;c++)a=b[c].volume.L,b[c].volume.L=b[c].volume.R,b[c].volume.R=a;this.updateSampleEditor(),this.file.modified=!0},Tracker.prototype.onCmdSmpLVolUp=function(){for(var a=this.player.sample[this.workingSample],b=a.data,c=0;256>c;c++)(c<a.end&&b[c].volume.L<15||c>=a.end&&b[c].volume.L>0&&b[c].volume.L<15)&&b[c].volume.L++;this.updateSampleEditor(),this.file.modified=!0},Tracker.prototype.onCmdSmpLVolDown=function(){for(var a=this.player.sample[this.workingSample].data,b=0;256>b;b++)a[b].volume.L>0&&a[b].volume.L--;this.updateSampleEditor(),this.file.modified=!0},Tracker.prototype.onCmdSmpRVolUp=function(){for(var a=this.player.sample[this.workingSample],b=a.data,c=0;256>c;c++)(c<a.end&&b[c].volume.R<15||c>=a.end&&b[c].volume.R>0&&b[c].volume.R<15)&&b[c].volume.R++;this.updateSampleEditor(),this.file.modified=!0},Tracker.prototype.onCmdSmpRVolDown=function(){for(var a=this.player.sample[this.workingSample].data,b=0;256>b;b++)a[b].volume.R>0&&a[b].volume.R--;this.updateSampleEditor(),this.file.modified=!0},Tracker.prototype.onCmdSmpCopyLR=function(){for(var a=this.player.sample[this.workingSample].data,b=0;256>b;b++)a[b].volume.R=a[b].volume.L;this.updateSampleEditor(),this.file.modified=!0},Tracker.prototype.onCmdSmpCopyRL=function(){for(var a=this.player.sample[this.workingSample].data,b=0;256>b;b++)a[b].volume.L=a[b].volume.R;this.updateSampleEditor(),
this.file.modified=!0},Tracker.prototype.onCmdSmpRotL=function(){for(var a,b=0,c=this.player.sample[this.workingSample].data,d=$.extend(!0,{},c[b]);256>b;b++)a=255>b?c[b+1]:d,c[b].volume.byte=a.volume.byte,c[b].enable_freq=a.enable_freq,c[b].enable_noise=a.enable_noise,c[b].noise_value=a.noise_value,c[b].shift=a.shift;this.updateSampleEditor(),this.file.modified=!0},Tracker.prototype.onCmdSmpRotR=function(){for(var a,b=255,c=this.player.sample[this.workingSample].data,d=$.extend(!0,{},c[b]);b>=0;b--)a=b>0?c[b-1]:d,c[b].volume.byte=a.volume.byte,c[b].enable_freq=a.enable_freq,c[b].enable_noise=a.enable_noise,c[b].noise_value=a.noise_value,c[b].shift=a.shift;this.updateSampleEditor(),this.file.modified=!0},Tracker.prototype.onCmdSmpEnable=function(){for(var a=this.player.sample[this.workingSample].data,b=0;256>b;b++)a[b].volume.byte&&(a[b].enable_freq=!0);this.updateSampleEditor(),this.file.modified=!0},Tracker.prototype.onCmdSmpDisable=function(){for(var a=this.player.sample[this.workingSample].data,b=0;256>b;b++)a[b].enable_freq=!1;this.updateSampleEditor(),this.file.modified=!0},Tracker.prototype.onCmdOrnPlay=function(){this.player.playSample(this.workingOrnTestSample,this.workingOrnament,this.workingSampleTone)},Tracker.prototype.onCmdOrnClear=function(){var a=this.globalKeyState,b=this.player.ornament[this.workingOrnament],c=this;a.inDialog=!0,$("#dialoque").confirm({title:"Clear ornament\u2026",text:"Are you sure you want to clear a content of this ornament?",style:"warning",buttons:"yesno",callback:function(d){a.inDialog=!1,"yes"===d&&(b.name="",b.data.fill(0),b.loop=b.end=0,c.smpornedit.updateOrnamentEditor(!0),c.file.modified=!0)}})},Tracker.prototype.onCmdOrnShiftLeft=function(){for(var a=0,b=this.player.ornament[this.workingOrnament].data,c=b[a];256>a;a++)b[a]=255>a?b[a+1]:c;this.smpornedit.updateOrnamentEditor(),this.file.modified=!0},Tracker.prototype.onCmdOrnShiftRight=function(){for(var a=255,b=this.player.ornament[this.workingOrnament].data,c=b[a];a>=0;a--)b[a]=a>0?b[a-1]:c;this.smpornedit.updateOrnamentEditor(),this.file.modified=!0},Tracker.prototype.onCmdOrnTransUp=function(){for(var a=this.player.ornament[this.workingOrnament],b=a.end,c=0;b>c;c++)a.data[c]++;this.smpornedit.updateOrnamentEditor(),this.file.modified=!0},Tracker.prototype.onCmdOrnTransDown=function(){for(var a=this.player.ornament[this.workingOrnament],b=a.end,c=0;b>c;c++)a.data[c]--;this.smpornedit.updateOrnamentEditor(),this.file.modified=!0},Tracker.prototype.onCmdOrnCompress=function(){for(var a=this.player.ornament[this.workingOrnament],b=a.data,c=0,d=0;256>d;c++,d+=2)b[c]=b[d];b.fill(0,c),a.loop>>=1,a.end>>=1,this.smpornedit.updateOrnamentEditor(!0),this.file.modified=!0},Tracker.prototype.onCmdOrnExpand=function(){for(var a=this.player.ornament[this.workingOrnament],b=a.data,c=127,d=256;d>0;c--)b[--d]=b[c],b[--d]=b[c];a.loop<<=1,a.end<<=1,this.smpornedit.updateOrnamentEditor(!0),this.file.modified=!0},Tracker.prototype.hotkeyMap=function(a,b,c){var d=this,e=c>32&&41>c,f=/keyup|test/.test(a),g=/keydown|test/.test(a);switch(b){case"globalCtrl":if(!f)return;return{79:function(){},83:function(){},80:function(){},89:function(){},90:function(){}}[c];case"globalFs":if(!g)return;return{27:function(){d.modePlay||d.activeTab>0?d.onCmdStop():d.modeEdit&&d.onCmdToggleEditMode()},112:function(){d.onCmdAbout()},113:function(){$("#tab-tracker").tab("show")},114:function(){$("#tab-smpedit").tab("show")},115:function(){$("#tab-ornedit").tab("show")},116:function(){d.onCmdSongPlay()},117:function(){d.onCmdSongPlayStart()},118:function(){d.onCmdPosPlay()},119:function(){d.onCmdPosPlayStart()},120:function(){},121:function(){},122:function(){d.onCmdToggleLoop()},123:function(){}}[c];case"trackerCtrl":if(!("repeat"===a&&[38,40,48,57].indexOf(c)>=0||g))return;return c>96&&103>c?c=96:c>48&&57>c&&(c=56),{38:function(){var a=d.player.currentLine;return(a=a>=16&&(240&a)===a?16:15&a)?void d.updateEditorCombo(-a):!1},40:function(){var a=d.player.position[d.player.currentPosition]||d.player.nullPosition,b=d.player.currentLine,c=a.length;b=c-16>b?16-(15&b):c-b-1,d.updateEditorCombo(b)},48:function(){d.ctrlRowStep=parseInt($("#scRowStep").trigger("touchspin.uponce").val(),10)},56:function(a){a-=48,$("#scOctave").val(a),d.ctrlOctave=a},57:function(){d.ctrlRowStep=parseInt($("#scRowStep").trigger("touchspin.downonce").val(),10)},96:function(a){a-=96,$("#scChnButton"+a).bootstrapToggle("toggle")}}[c];case"trackerCtrlShift":if(!f)return;return 109===c&&(c=107),{37:function(){$("#scPosCurrent").trigger("touchspin.downonce")},39:function(){$("#scPosCurrent").trigger("touchspin.uponce")},107:function(a){if(d.modeEdit){a&=2;var b,c=d.player,e=d.tracklist.selection,f=e.len?e.channel:d.modeEditChannel,g=e.len?e.line:c.currentLine,h=g+e.len,i=c.position[c.currentPosition]||c.nullPosition,j=c.pattern[i.ch[f].pattern];for(a=12*(a-1);h>=g&&!(g>=j.end);g++)(b=j.data[g].tone)&&(b+=a,b>0&&96>=b&&(j.data[g].tone=b));d.updateTracklist()}}}[c];case"editorShift":if(!g||!d.modeEdit||!d.player.position.length)return;return{9:function(){d.modeEditChannel>0?d.modeEditChannel--:d.modeEditChannel=5,d.updateTracklist()}}[c];case"editorKeys":if(!(g||"repeat"===a&&e))return;if(109===c&&(c=107),e)if(d.modePlay)d.onCmdStop();else if(!d.player.position.length||!d.modeEdit&&d.modePlay)return;return{9:function(){d.player.position.length&&d.modeEdit&&(d.modeEditChannel<5?d.modeEditChannel++:d.modeEditChannel=0,d.updateTracklist())},32:function(){d.modePlay&&d.onCmdStop(),d.player.position.length&&d.onCmdToggleEditMode()},33:function(){var a=d.settings.tracklistLines+1;d.tracklist.moveCurrentline(-(a>>1),!0),d.updateTracklist(),d.updatePanelInfo()},34:function(){var a=d.settings.tracklistLines+1;d.tracklist.moveCurrentline(a>>1,!0),d.updateTracklist(),d.updatePanelInfo()},35:function(){d.tracklist.moveCurrentline(Player.maxPatternLen,!0),d.updateTracklist(),d.updatePanelInfo()},36:function(){d.tracklist.moveCurrentline(-Player.maxPatternLen,!0),d.updateTracklist(),d.updatePanelInfo()},37:function(){d.modeEdit&&(d.modeEditColumn>0?d.modeEditColumn--:(d.modeEditColumn=7,d.modeEditChannel>0?d.modeEditChannel--:d.modeEditChannel=5),d.updateTracklist())},38:function(){d.updateEditorCombo(-1)},39:function(){d.modeEdit&&(d.modeEditColumn<7?d.modeEditColumn++:(d.modeEditColumn=0,d.modeEditChannel<5?d.modeEditChannel++:d.modeEditChannel=0),d.updateTracklist())},40:function(){d.updateEditorCombo(1)},107:function(a){if(d.modeEdit){a&=2;var b=d.player,c=d.tracklist.selection,e=c.len?c.channel:d.modeEditChannel,f=c.len?c.line:b.currentLine,g=f+c.len,h=b.position[b.currentPosition]||b.nullPosition,i=b.pattern[h.ch[e].pattern];for(--a;g>=f&&!(f>=i.end);f++)i.data[f].tone&&(i.data[f].tone=Math.min(Math.max(i.data[f].tone+a,1),96));d.updateTracklist()}}}[c];case"editorEdit":if(!g)return;var h=d.player.currentLine,i=d.player.position[d.player.currentPosition]||d.player.nullPosition,j=i.ch[d.modeEditChannel].pattern,k=d.player.pattern[j],l=k.data[h];if(h<k.end)switch(c){case 8:return function(){for(var a=h+1,b=h,c=k.data,e=Player.maxPatternLen-1;e>a;a++,b++)c[b].tone=c[a].tone,c[b].release=c[a].release,c[b].smp=c[a].smp,c[b].orn=c[a].orn,c[b].orn_release=c[a].orn_release,c[b].volume.byte=c[a].volume.byte,c[b].cmd=c[a].cmd,c[b].cmd_data=c[a].cmd_data;c[a].tone=c[a].smp=c[a].orn=0,c[a].release=c[a].orn_release=!1,c[a].cmd=c[a].cmd_data=c[a].volume.byte=0,d.updateTracklist()};case 45:return function(){for(var a=Player.maxPatternLen,b=a-2,c=a-1,e=k.data;b>=h;b--,c--)e[c].tone=e[b].tone,e[c].release=e[b].release,e[c].smp=e[b].smp,e[c].orn=e[b].orn,e[c].orn_release=e[b].orn_release,e[c].volume.byte=e[b].volume.byte,e[c].cmd=e[b].cmd,e[c].cmd_data=e[b].cmd_data;e[c].tone=e[c].smp=e[c].orn=0,e[c].release=e[c].orn_release=!1,e[c].cmd=e[c].cmd_data=e[c].volume.byte=0,d.updateTracklist()};case 46:return function(){switch(d.modeEditColumn){default:case 0:l.tone=0,l.release=0;break;case 1:l.smp=0;break;case 2:l.orn=0,l.orn_release=0;break;case 3:case 4:l.volume.byte=0;break;case 5:l.cmd=0,l.cmd_data=0;break;case 6:l.cmd_data&=15;break;case 7:l.cmd_data&=240}d.updateEditorCombo()};default:var m={0:function(a,b){var c=Math.min(d.getKeynote(a),96);return 0>c?!1:b?!0:(c>0?(l.release=!1,l.tone=c,d.ctrlSample&&!l.smp&&(l.smp=d.ctrlSample),d.ctrlOrnament&&!l.orn&&(l.orn=d.ctrlOrnament,l.orn_release=!1)):(l.release=!0,l.tone=0,l.smp=0,l.orn=0,l.orn_release=!1),void d.updateEditorCombo())},1:function(a,b){if(a>=48&&57>=a){if(b)return!0;l.smp=a-48}else{if(!(a>=65&&86>=a))return!1;if(b)return!0;l.smp=a-55}d.updateEditorCombo()},2:function(a,b){if(a>=48&&57>=a){if(b)return!0;l.orn_release=!1,l.orn=a-48}else if(a>=65&&70>=a){if(b)return!0;l.orn_release=!1,l.orn=a-55}else{if(88!==a&&189!==a)return!1;if(b)return!0;l.orn_release=!0,l.orn=0}d.updateEditorCombo()},3:function(a,b){if(a>=48&&57>=a){if(b)return!0;l.volume.L=a-48}else{if(!(a>=65&&70>=a))return!1;if(b)return!0;l.volume.L=a-55}d.updateEditorCombo()},4:function(a,b){if(a>=48&&57>=a){if(b)return!0;l.volume.R=a-48}else{if(!(a>=65&&70>=a))return!1;if(b)return!0;l.volume.R=a-55}d.updateEditorCombo()},5:function(a,b){if(a>=48&&57>=a){if(b)return!0;l.cmd=a-48}else{if(!(a>=65&&70>=a))return;if(b)return!0;l.cmd=a-55,15==l.cmd&&l.cmd_data&&d.player.countPositionFrames(d.player.currentPosition)}d.updateEditorCombo()},6:function(a,b){if(a>=48&&57>=a)a-=48;else{if(!(a>=65&&70>=a))return!1;a-=55}return b?!0:(l.cmd_data&=15,l.cmd_data|=a<<4,15==l.cmd&&l.cmd_data&&d.player.countPositionFrames(d.player.currentPosition),void d.updateEditorCombo())},7:function(a,b){if(a>=48&&57>=a)a-=48;else{if(!(a>=65&&70>=a))return!1;a-=55}return b?!0:(l.cmd_data&=240,l.cmd_data|=a,15==l.cmd&&l.cmd_data&&d.player.countPositionFrames(d.player.currentPosition),void d.updateEditorCombo())}}[d.modeEditColumn];return m(c,!0)?m:void 0}case"smpornCtrl":if(!g)return;if(c>96&&105>c)return function(a){var b=a-97,c=d.workingSampleTone,e=(c-1)%12+12*b+1;c!==e&&(d.workingSampleTone=e,$("#scSampleTone,#scOrnTone").val(e.toString()).prev().val(d.player.tones[e].txt))};if(c>48&&57>=c||c>64&&90>=c)return function(a){var b=a-48,c=2===d.activeTab;b>9&&(b-=7),b>=(c?16:32)||$(c?"#scOrnNumber":"#scSampleNumber").val(b.toString(32).toUpperCase()).trigger("change")};break;case"smpornKeys":if(!g)return;var n=d.player.tones[d.workingSampleTone].oct,o=Math.min(d.getKeynote(c,n),96),p=1===d.activeTab?d.workingSample:d.workingOrnTestSample,q=2===d.activeTab?d.workingOrnament:0;if(o>0)return function(){d.player.playSample(p,q,o)};break;default:return}},Tracker.prototype.handleKeyEvent=function(a){var b=this.globalKeyState,c=a.type,d=a.target&&/^a|input|button$/i.test(a.target.tagName)||"documodal"===a.target.id,e=a.which||a.charCode||a.keyCode,f=!!this.player.position.length;if(browser.isOpera&&219===e)e=91;else if(browser.isFirefox)switch(e){case 59:e=186;break;case 61:e=187;break;case 173:e=189}if("keydown"===c){if(e>=16&&18>=e&&(b.modsHandled=!1,2===a.location&&(e+=256)),a.repeat||browser.isFirefox&&b[e]?c="repeat":b[e]||(b[e]=!0,b.length++),d&&!this.handleHotkeys("test",e,d))return!0;this.handleHotkeys(c,e,d)||b.inDialog||0!==this.activeTab||(b[13]&&1===b.length&&f&&!this.modePlay&&!b.lastPlayMode?(this.modePlay=this.player.playPosition(!1,!1,!1),b.lastPlayMode=3):b[13]&&b.length>1&&this.modePlay&&3===b.lastPlayMode&&(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0))}else if("keyup"===c&&(b[e]&&this.handleHotkeys(c,e,d)&&(d=!1),b.modsHandled||b.inDialog||!f||(1===b.length&&b[272]?(this.modePlay&&1===b.lastPlayMode?(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0):(this.modePlay=this.player.playPosition(!1,!1,!0),b.lastPlayMode=1),b.modsHandled=!0):1===b.length&&b[273]&&(this.modePlay&&2===b.lastPlayMode?(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0):(this.modePlay=this.player.playPosition(!1,!0,!0),b.lastPlayMode=2),b.modsHandled=!0)),b.inDialog||0!==this.activeTab||b[13]&&this.modePlay&&3===b.lastPlayMode&&(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0),b[e]&&(delete b[e],b.length&&b.length--),b[e+256]&&(delete b[e+256],b.length&&b.length--),d))return!0;return a.preventDefault(),!1},Tracker.prototype.handleHotkeys=function(a,b,c){var d=this.globalKeyState,e=!1,f=d.inDialog||c;if(d[17]&&17!==b){if(90===b&&d[16]&&(delete d[b],delete d[16],d.length&&d.length--,d[--b]=!0),2===d.length){if(c&&67===b||86===b)return!1;82===b||116===b?(e=!0,a="test"):d.inDialog||(e=this.hotkeyMap(a,"globalCtrl",b))||c||(e=0===this.activeTab?this.hotkeyMap(a,"trackerCtrl",b):this.hotkeyMap(a,"smpornCtrl",b))}else!d.inDialog&&3===d.length&&d[16]&&0===this.activeTab&&(e=this.hotkeyMap(a,"trackerCtrlShift",b));d.inDialog&&!e&&(e=!0,a="test",d.modsHandled=!0)}else d[273]&&273!==b?(e=!0,a="test",d.modsHandled=!0):!f&&d[16]&&16!==b&&2===d.length&&0===this.activeTab?e=this.hotkeyMap(a,"editorShift",b):1===d.length&&(d.inDialog&&b>=112&&123>=b||272===b?(e=!0,a="test",d.modsHandled=!0):d.inDialog||(e=this.hotkeyMap(a,"globalFs",b))||c||(0===this.activeTab?!(e=this.hotkeyMap(a,"editorKeys",b))&&this.player.position.length&&this.modeEdit&&(e=this.hotkeyMap(a,"editorEdit",b)):e=this.hotkeyMap(a,"smpornKeys",b)));return e?("test"!==a&&(e(b),d.modsHandled=!0),!0):void 0},Tracker.prototype.getKeynote=function(a,b){var c=12*(void 0!==b?b:this.ctrlOctave-1),d=String.fromCharCode(a),e=" ZSXDCVGBHNJMQ2W3ER5T6Y7UI9O0P".indexOf(d);return e>0?c+e:(e={49:0,65:0,192:0,189:0,222:0,188:c+13,76:c+14,190:c+15,186:c+16,191:c+17,219:c+30,187:c+31,221:c+32}[a])>=0?e:-1},Tracker.prototype.handleMouseEvent=function(a,b,c){var d=c.pageX||0,e=c.pageY||0,f=browser.isFirefox?!!(1&c.buttons)||"mousemove"!==c.type&&0===c.button:1===c.which;if("tracklist"===a){var g,h=!1,i=this.player,j=i.position[i.currentPosition],k=b.selection,l=b.canvasData.offset,m=b.pointToTracklist(d-l.left,e-l.top),n=i.currentLine;if(this.modePlay||!j)return;if(m)m.line=Math.min(m.line,j.length-1),g=m.line-k.start.line;else if("mousewheel"!==c.type)return;"mousewheel"===c.type?(document.activeElement!==c.target&&document.activeElement.blur(),c.delta<0?b.moveCurrentline(1):c.delta>0&&b.moveCurrentline(-1),h=!0):"mousedown"===c.type?f&&m.line<j.length&&k.start.set(m):"mouseup"===c.type&&f?k.isDragging?(k.len=g,k.line=k.start.line,k.channel=k.start.channel,k.isDragging=!1,h=!0):(this.modeEdit||c.target.focus(),m.line===n&&(this.modeEditChannel=k.start.channel,this.modeEditColumn=k.start.column,h=!0)):"dblclick"===c.type&&f?(k.len=0,k.line=m.line,k.channel=m.channel,k.isDragging=!1,this.modeEdit||c.target.focus(),this.modeEditChannel=k.start.channel,this.modeEditColumn=k.start.column,i.currentLine=m.line,h=!0):"mousemove"===c.type&&f&&!m.compare(k.start)&&(g>0&&(k.len=g,k.line=k.start.line,k.channel=k.start.channel,k.isDragging=!0),m.y===this.settings.tracklistLines-1&&b.moveCurrentline(1,!0),h=!0),h&&(k.isDragging||"mousewheel"===c.type||(g=0,this.modeEditColumn>=5&&(g=i.pattern[j.ch[this.modeEditChannel].pattern].data[n].cmd),this.doc.showTracklistStatus(this.modeEditColumn,g)),this.updateTracklist(),this.updatePanelInfo())}else{var o,p,q,r=this.player.sample[this.workingSample],s=/mouse(down|move)/.test(c.type),t=!1,u=!1;if(d-=b.smpeditOffset.left+b.centering,0>d)return;if(d=Math.min(0|d/b.columnWidth,63)+b.smpeditScroll,p=q=d,o=r.data[d],"amp"===a){e-=b.smpeditOffset.top.amp;var v=b.amp.obj.height-24,w=e<b.halfing,x=e>v+3||b.drag.isDragging;x&&f?("mousedown"===c.type?(g=b.drag.freqEnableState=!o.enable_freq,b.drag.isDragging=!0):"mouseup"===c.type?(g=b.drag.freqEnableState,b.drag.isDragging=!1):b.drag.isDragging&&"mousemove"===c.type&&(g=b.drag.freqEnableState),o.enable_freq!==g&&(o.enable_freq=g,t=!0)):"mousewheel"===c.type?(g=c.delta/Math.abs(c.delta),w?o.volume.L=Math.max(Math.min(o.volume.L+g,15),0):o.volume.R=Math.max(Math.min(o.volume.R-g,15),0),t=!0):s&&f&&(w?o.volume.L=Math.max(15-(0|e/9),0):o.volume.R=Math.max(15-(0|(v-e)/9),0),t=!0)}else"noise"===a?(e-=b.smpeditOffset.top.noise,g=(0|o.enable_noise)*(o.noise_value+1),"mousewheel"===c.type?(g+=c.delta/Math.abs(c.delta),t=!0):s&&f&&(g=4-(0|e/9),t=!0),t&&(g=Math.min(Math.max(g,0),4),o.enable_noise=!!g,o.noise_value=Math.max(--g,0))):"range"===a&&f&&("mouseup"===c.type?(b.drag.isDragging=!1,t=!0):"mousedown"===c.type?(b.drag.isDragging=1,b.drag.rangeStart=d,t=!0):b.drag.isDragging&&"mousemove"===c.type&&(b.drag.isDragging=2,t=!0),t&&(d===b.drag.rangeStart?2===b.drag.isDragging?(r.end=d+1,r.loop=d):1===b.drag.isDragging&&(r.end=++d,r.loop=d):d>b.drag.rangeStart?(r.end=++d,r.loop=b.drag.rangeStart):(r.end=b.drag.rangeStart+1,r.loop=d),u=!0,1===b.drag.isDragging?p=q=void 0:(p=r.loop-1,q=r.end)));t&&this.updateSampleEditor(u,p,q)}},Tracker.prototype.initPixelFont=function(a){var b,c,d,e=["#fff","#f00","#38c","#000","#800"],f=this.pixelfont,g=10*e.length,h=a.width;for(f.obj=document.createElement("canvas"),f.obj.width=h,f.obj.height=g,f.ctx=f.obj.getContext("2d"),b=0;g>b;b+=10)f.ctx.fillStyle=e[b/10],f.ctx.fillRect(0,b,h,10);for(c=document.createElement("canvas"),c.width=h,c.height=5,d=c.getContext("2d"),d.save(),d.clearRect(0,0,h,5),d.drawImage(a,0,0),d.fillStyle="#fff",d.globalCompositeOperation="source-in",d.fillRect(0,0,h,5),d.restore(),b=0;g>b;b+=10)f.ctx.drawImage(c,0,b);for(d.save(),d.clearRect(0,0,h,5),d.drawImage(a,0,0),d.fillStyle="#aaa",d.globalCompositeOperation="source-in",d.fillRect(0,0,h,5),d.restore(),b=5;g>b;b+=10)f.ctx.drawImage(c,0,b);f.ctx.drawImage(a,0,0),d=null,c=null},Tracker.prototype.updateTracklist=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p=this.tracklist.canvasData,q=this.tracklist.selection,r=this.tracklist.offsets,s=this.player,t=this.settings.hexTracklines,u=this.pixelfont.obj,v=this.tracklist.ctx,w=s.currentPosition,x=s.position[w]||s.nullPosition,y=!t&&x.length>100,z=this.tracklist.obj.width,A=this.settings.tracklistLineHeight,B=this.settings.tracklistLines,C=B>>1,D=s.currentLine-C,E=function(a){return 6*(e.charCodeAt(a||0)-32)};for(a&&(p.center=z-p.lineWidth>>1,p.vpad=Math.round((A-5)/2),p.trkOffset=p.center+24,r.y=[]),i=0,n=0,m=p.vpad;B>i;i++,D++,m+=A,n+=A){if(a&&(r.y[i]=n),i!==C?(g=0,v.clearRect(p.center-6,n,p.lineWidth+9,A)):this.modeEdit?(g=10,v.fillStyle="#f00",v.fillRect(0,n,z,A)):(g=20,v.fillStyle="#38c",v.fillRect(0,n,z,A)),0>D){if(!w||!x)continue;b={pp:x,line:D},x=s.position[w-1],D+=x.length}else if(D>=x.length){if(!(w<s.position.length-1&&x))continue;b={pp:x,line:D},D-=x.length,x=s.position[w+1]}for(e=("00"+D.toString(t?16:10)).substr(-3),(y||!t&&D>99)&&v.drawImage(u,E(0),g,5,5,p.center-6,m,5,5),v.drawImage(u,E(1),g,5,5,p.center,m,5,5),v.drawImage(u,E(2),g,5,5,p.center+6,m,5,5),h=0;6>h;h++)for(c=s.pattern[x.ch[h].pattern],d=c.data[D],j=0;8>j;j++)if(l=p.trkOffset+h*p.chnWidth+p.columns[j],a&&(r.x[h][j]=l,!j&&h&&(r.x[h-1][8]=l)),f=g,!b&&(i!==C||!this.modeEdit)&&q.len&&q.channel===h&&D>=q.line&&D<=q.line+q.len?(j||(v.fillStyle="#000",v.fillRect(l-3,n,p.selWidth,A)),f=30):i===C&&this.modeEdit&&this.modeEditChannel===h&&this.modeEditColumn===j&&(o=j>=5?d.cmd:0,v.fillStyle="#800",j?v.fillRect(l-1,n,7,A):v.fillRect(l-2,n,22,A),f=40),D>=c.end&&(f+=5),j){switch(k=-1,j){case 1:d.smp&&(k=d.smp);break;case 2:d.orn_release?k=33:d.orn&&(k=d.orn);break;case 3:d.volume.byte&&(k=d.volume.L);break;case 4:d.volume.byte&&(k=d.volume.R);break;case 5:(d.cmd||d.cmd_data)&&(k=d.cmd);break;case 6:(d.cmd||d.cmd_data)&&(k=(240&d.cmd_data)>>4);break;case 7:(d.cmd||d.cmd_data)&&(k=15&d.cmd_data)}e=0>k?"":k.toString(36),v.drawImage(u,E(),f,5,5,l,m,5,5)}else e="---",d.release?e="R--":d.tone&&(e=s.tones[d.tone].txt),v.drawImage(u,E(0),f,5,5,l,m,5,5),v.drawImage(u,E(1),f,5,5,l+6,m,5,5),v.drawImage(u,E(2),f,5,5,l+12,m,5,5);b&&(x=b.pp,D=b.line,b=void 0,v.save(),v.fillStyle="rgba(255,255,255,.75)",v.globalCompositeOperation="xor",v.fillRect(p.center-6,m,p.lineWidth+6,5),v.restore())}!this.modePlay&&this.modeEdit&&void 0!==o&&this.doc.showTracklistStatus(this.modeEditColumn,o),a&&(r.x[5][8]=z,r.x[0][0]=0,r.y[i]=n)},Tracker.prototype.updateSampleEditor=function(a,b,c){var d,e,f,g,h,i,j,k=this.smpornedit,l=this.player.sample[this.workingSample],m=k.amp.ctx,n=k.noise.ctx,o=k.range.ctx,p=m.getImageData(22,0,1,1),q=k.halfing,r=k.smpeditScroll,s=r+64,t=k.columnWidth,u=k.centering,v=t-1;for(void 0!==b&&(f=Math.max(r,b),u+=(f-r)*t,r=f),void 0!==c&&(s=Math.min(s,++c));s>r;r++,u+=t){for(d=r>=l.end&&!l.releasable?"#888":l.loop!=l.end&&r>=l.loop&&r<l.end?"#38c":"#000",o.strokeStyle=o.fillStyle=n.fillStyle=m.strokeStyle=m.fillStyle=d,e=l.data[r],i=e.volume.L,j=e.volume.R,g=q-12,h=q+5,f=0;15>f;f++,g-=9,h+=9)m.clearRect(u,g,v,8),m.putImageData(p,u,g+7),i>f&&m.fillRect(u,g,v,8),m.clearRect(u,h,v,8),m.putImageData(p,u,h),j>f&&m.fillRect(u,h,v,8);for(m.clearRect(u,292,v,12),m.strokeRect(u-.5,291.5,v-1,12),e.enable_freq&&m.fillRect(u+1,293,v-4,9),f=0,g=34;4>f;f++,g-=9)n.clearRect(u,g,v,8),n.putImageData(p,u,g+7),e.enable_noise&&f<=e.noise_value&&n.fillRect(u,g,v,8);o.clearRect(u,4,12,8),r>=l.end?o.fillRect(u,12,12,1):(o.fillRect(u,10,12,3),l.loop<=l.end&&r===l.end-1&&(o.beginPath(),o.moveTo(u,10),o.lineTo(u+12,10),o.lineTo(u+12,4),o.closePath(),o.fill()),l.loop<l.end&&r===l.loop&&(o.beginPath(),o.moveTo(u,10),o.lineTo(u+12,10),o.lineTo(u,4),o.closePath(),o.fill()))}a&&(f=l.end-l.loop,$("#txSampleName").val(l.name),$("#scSampleLength").val(""+l.end),$("#scSampleRepeat").val(""+f).trigger("touchspin.updatesettings",{min:0,max:l.end}),!f&&l.releasable&&(l.releasable=!1),$("#chSampleRelease").prop("checked",l.releasable),$("#chSampleRelease").prop("disabled",!f).parent()[f?"removeClass":"addClass"]("disabled"))},Tracker.prototype.doc={txtCache:{},tooltip:{miFileNew:"New",miFileOpen:"Open [Ctrl+O]",miFileSave:"Save [Ctrl+S]",miFileSaveAs:"Save as...",miEditCut:"Cut [Ctrl+X]",miEditCopy:"Copy [Ctrl+C]",miEditPaste:"Paste [Ctrl+V]",miEditClear:"Clear [Ctrl+D]",miEditUndo:"Undo [Ctrl+Z]",miEditRedo:"Redo [Ctrl+Y | Ctrl+Shift+Z]",miStop:"Stop [Esc]",miSongPlay:"Play song [F5]",miSongPlayStart:"Play song from start [F6]",miPosPlay:"Play position [F7]",miPosPlayStart:"Play position from start [F8]",miToggleLoop:"Toggle repeat [F11]",miManager:"Track manager [F9]",miPreferences:"Preferences [F10]",miSpecialLogin:"Login to SAA-1099\ncloud for musicians",scOctave:"Base octave [Ctrl+1...Ctrl+8]",scAutoSmp:"Auto-typed sample",scAutoOrn:"Auto-typed ornament",scRowStep:"Row-step in edit mode [- Ctrl+9 | Ctrl+0 +]",btPatternCreate:"Create a new pattern\nin length of current",btPatternDelete:"Delete the current pattern\n(and renumber others if it isn't last one)",btPatternClean:"Clear content of current pattern",btPatternInfo:"View summary dialog of patterns",scPattern:"Current pattern number",scPatternLen:"Current pattern length",txPatternUsed:"How many times is the pattern used",txPatternTotal:"Total number of patterns",btPosCreate:"Create an empty position\nat the end of song",btPosInsert:"Create a copy of current position\nand insert before it",btPosDelete:"Delete the current position",btPosMoveUp:"Move the current position\nbefore the previous",btPosMoveDown:"Move the current position\nafter the next one",scPosCurrent:"Actual position to play or edit [- Ctrl+Shift+Left|Right +]",scPosLength:"Current position length",scPosSpeed:"Initial speed of current position",scPosRepeat:"Position number to repeat from",txPosTotal:"Total number of positions",scChnButton:"Mute/Unmute channels [Ctrl+Num1...Ctrl+Num6]",scChnPattern:"Assigned pattern for specific\nchannel in current position",scChnTrans:"Transposition of notes\nin specific channel-pattern",scSampleNumber:"Current sample ID",txSampleName:"Current sample description",scSampleTone:"Base tone and octave\nto test this sample",btSamplePlay:"Play current sample",btSampleStop:"Stop playback [Esc]",btSampleClear:"Clear sample or\npart of sample data",btSampleSwap:"Swap volume data between channels",btSampleLVolUp:"Volume up left channel",btSampleLVolDown:"Volume down left channel",btSampleCopyLR:"Copy volume data from left to right channel",btSampleCopyRL:"Copy volume data from right to left channel",btSampleRVolUp:"Volume up right channel",btSampleRVolDown:"Volume down right channel",btSampleRotL:"Shift whole sample data\nto the left side",btSampleRotR:"Shift whole sample data\nto the right side",btSampleEnable:"Enable frequency generator\nin full active sample length",btSampleDisable:"Disable frequency generator\nin full sample length",chSampleRelease:"Sample can continue in playing\nafter the loop section when\nthe note was released in tracklist",scSampleLength:"Length of current sample",scSampleRepeat:"Number of ticks at the end\nof sample which will be repeated",scOrnNumber:"Current ornament ID",txOrnName:"Current ornament description",scOrnTestSample:"Sample ID to test ornament with",scOrnTone:"Base tone and octave\nto test this ornament",btOrnPlay:"Play current ornament\nwith test sample",btOrnStop:"Stop playback [Esc]",btOrnClear:"Clear ornament",btOrnShiftLeft:"Shift whole ornament data\nto the left side",btOrnShiftRight:"Shift whole ornament data\nto the right side",btOrnTransUp:"Transpose ornament data\nup a halftone",btOrnTransDown:"Transpose ornament data\ndown a halftone",btOrnCompress:"Compress ornament data\n(keep only every even line)",btOrnExpand:"Expand ornament data\n(duplicate each line)",fxOrnChords:"Replace current ornament with\npregenerated chord decomposition",scOrnLength:"Length of current ornament",scOrnRepeat:"Number of ticks at the end\nof ornament which will be repeated"},statusbar:["NOTE - use alphanumeric keys as two-octave piano, for RELEASE note use [A], [1] or [-] key","SAMPLE - [0] no change, [1 - V] to change current sample","ORNAMENT - [0] no change, [1 - F] for ornament, or [X] for release ornament","VOLUME CHANGE - [0] no change, [1 - F] for volume change in left channel","VOLUME CHANGE - [0] no change, [1 - F] for volume change in right channel","COMMAND - [0] no change, [1 - F] to use effect or command","COMMAND: 1XY - portamento up","COMMAND: 2XY - portamento down","COMMAND: 3XY - glissando to given note","COMMAND: 4XY - vibrato on current note","COMMAND: 5XY - tremolo on current note","COMMAND: 6XX - delay ornament","COMMAND: 7XX - ornament offset","COMMAND: 8XX - delay sample","COMMAND: 9XX - sample offset","COMMAND: AXY - volume slide","COMMAND: BXX - break current channel-pattern and loop from line","COMMAND: CXY - special command","COMMAND: DXX - delay listing on current line","COMMAND: EXY - soundchip envelope or noise channel control","COMMAND: FXX - change global speed","COMMAND 1st parameter: period of change (in ticks)","COMMAND 2nd parameter: pitch change in period (in cents)","COMMAND parameter: delay (in ticks)","COMMAND parameter: offset (in ticks)","COMMAND 2nd parameter: volume change in period [- 9-F | 1-7 +]","COMMAND parameter: trackline of current channel-pattern","COMMAND parameter: [00] disable last command, [XY] false-chord, [F1] swap stereo channels","COMMAND 1st parameter: [0, 1] enable envelope control, [D] disable, [2] enable noise control","COMMAND 2nd parameter: [0-F] for envelope shape, [0-4] for noise control","COMMAND parameter: speed of track listing (01-1F constant, otherwise XY for swing mode)","COMMAND parameter: none"],lastStatus:void 0,setStatusText:function(a){var b=this.statusbar[a];b&&a===this.lastStatus||($("#statusbar>p").html(b?b.replace(/(\[.+?\])/g,"<strong>$1</strong>").replace(/^([\w ]+?)(\:| \-)/,"<kbd>$1</kbd>$2").replace(/(\(.+?\))$/,"<em>$1</em>"):""),this.lastStatus=a)},showTracklistStatus:function(a,b){var c=a;if(5===a)c=b+5;else if(a>5)switch(b){case 1:case 2:case 3:case 4:case 5:c=a+15;break;case 6:case 8:case 13:c=23;break;case 7:case 9:c=24;break;case 10:c=6==a?21:25;break;case 11:c=26;break;case 12:c=27;break;case 14:c=a+22;break;case 15:c=30;break;default:c=31}this.setStatusText(c)}},Tracker.prototype.populateGUI=function(){var a=this,b={menu:"nav.navbar",header:".fixed-container",trackedit:".fixed-container>.tab-content",smpedit:".fixed-container>.tab-content",ornedit:".fixed-container>.tab-content"},c=[{global:"document",method:"bind",param:"contextmenu",handler:function(a){return a.preventDefault(),!1}},{global:"window",method:"resize",handler:function(){var b=a.tracklist.countTracklines();if(b!==a.settings.tracklistLineHeight){a.tracklist.setHeight(b),a.updateTracklist(!0);var c=$("#statusbar").offset();$("#documodal .modal-body").css("height",.8*c.top)}}},{global:"window",method:"bind",param:"beforeunload",handler:function(){return dev?void 0:"All unsaved changes in SAA1099Tracker will be lost."}},{global:"window",method:"bind",param:"keyup keydown",handler:function(b){return a.handleKeyEvent(b.originalEvent)}},{global:"window",method:"bind",param:"blur",handler:function(b){var c,d=a.globalKeyState;for(c in d)c-0&&(delete d[c],d.length--)}},{selector:"[data-tooltip]",method:"each",handler:function(b,c){var d=(c.dataset||$(this).data()).tooltip||"",e=d.length?d:c.id||c.htmlFor||c.name,f=/^mi/.test(e)?500:2e3,g=a.doc.tooltip[e];g&&$(this).tooltip({html:!0,animation:!1,delay:{show:f,hide:0},placement:"auto top",trigger:"hover",title:g.replace(/\.{3}/g,"&hellip;").replace(/\n/g,"<br>").replace(/(\[.+?\])$/,"<kbd>$1</kbd>")})}},{selector:"canvas",method:"each",handler:function(b,c){var d=c.className,e=a[d];"tracklist"===d?(e.obj=c,e.ctx=c.getContext("2d"),getCompatible(e.ctx,"imageSmoothingEnabled",!0,!1),$(this).bind("focus",function(b){a.player.position.length&&!a.modeEdit&&a.onCmdToggleEditMode()})):"smpornedit"===d&&(d=c.id.replace("smpedit_",""),e[d].obj=c,e[d].ctx=c.getContext("2d"),getCompatible(e[d].ctx,"imageSmoothingEnabled",!0,!1)),$(this).bind("mousedown mouseup mousemove dblclick mousewheel DOMMouseScroll",function(b){var c=b.originalEvent.wheelDelta||-b.originalEvent.deltaY||"DOMMouseScroll"===b.originalEvent.type&&-b.originalEvent.detail;c&&(b.stopPropagation(),b.preventDefault(),b.delta=c,b.type="mousewheel"),a.handleMouseEvent(d,e,b)})}},{selector:"img.pixelfont",method:"load",handler:function(b){a.initPixelFont(b.target)}},{selector:"img.smpedit",method:"load",handler:function(b){a.smpornedit.img=b.target}},{selector:'#main-tabpanel a[data-toggle="tab"]',method:"on",param:"shown.bs.tab",handler:function(b){a.activeTab=parseInt($(this).data().value,10)}},{selector:"#scOctave",method:"TouchSpin",data:{initval:"2",min:1,max:8}},{selector:"#scOctave",method:"change",handler:function(){a.ctrlOctave=$(this).val()-0}},{selector:"#scAutoSmp",method:"TouchSpin",data:{initval:"0",radix:32,min:0,max:31}},{selector:"#scAutoSmp",method:"change",handler:function(){a.ctrlSample=parseInt($(this).val(),32)}},{selector:"#scAutoOrn",method:"TouchSpin",data:{initval:"0",radix:16,min:0,max:15}},{selector:"#scAutoOrn",method:"change",handler:function(){a.ctrlOrnament=parseInt($(this).val(),16)}},{selector:"#scRowStep",method:"TouchSpin",data:{initval:"0",min:0,max:8}},{selector:"#scRowStep",method:"change",handler:function(){a.ctrlRowStep=$(this).val()-0}},{selector:'#scPattern,#scPosCurrent,#scPosRepeat,input[id^="scChnPattern"]',method:"TouchSpin",data:{initval:"0",min:0,max:0}},{selector:"#scPatternLen,#scPosLength",method:"TouchSpin",data:{initval:"64",min:1,max:Player.maxPatternLen}},{selector:"#scPattern",method:"change",handler:function(){return a.player.pattern.length<=1?!1:(a.workingPattern=$(this).val()-0,void a.updatePanelPattern())}},{selector:"#scPatternLen",method:"change",handler:function(){var b=a.player.pattern[a.workingPattern];return a.player.pattern.length<=1?!1:a.modePlay?($(this).val(b.end),!1):(b.end=$(this).val()-0,a.player.countPositionFrames(),a.updatePanelPattern(),a.updateTracklist(),a.updatePanelInfo(),void(a.file.modified=!0))}},{selector:"#scPosCurrent",method:"change",handler:function(){if(!a.player.position.length)return!1;if(a.modePlay)return $(this).val(a.player.currentPosition+1),!1;var b=$(this).val()-1;a.player.currentPosition=b,a.player.currentLine=0,a.player.storePositionRuntime(b),a.updatePanelInfo(),a.updatePanelPosition(),a.updateTracklist()}},{
selector:"#scPosLength",method:"change",handler:function(){var b=a.player.currentPosition,c=a.player.position[b];return a.player.position.length?a.modePlay?($(this).val(c.length),!1):(c.length=$(this).val()-0,a.player.currentLine>=c.length&&(a.player.currentLine=c.length-1),a.player.countPositionFrames(b),a.updateTracklist(),a.updatePanelInfo(),void(a.file.modified=!0)):!1}},{selector:"#scPosSpeed",method:"TouchSpin",data:{initval:"6",min:1,max:31}},{selector:"#scPosSpeed",method:"change",handler:function(){var b=a.player.currentPosition,c=a.player.position[b];return a.player.position.length?a.modePlay?($(this).val(c.speed),!1):(c.speed=$(this).val()-0,a.player.countPositionFrames(b),a.updateTracklist(),a.updatePanelInfo(),void(a.file.modified=!0)):!1}},{selector:"#scPosRepeat",method:"change",handler:function(){return a.player.position.length?a.modePlay?($(this).val(a.player.repeatPosition+1),!1):(a.player.repeatPosition=$(this).val()-1,void(a.file.modified=!0)):!1}},{selector:'input[id^="scChnPattern"]',method:"change",handler:function(b){var c=b.target,d=a.player.currentPosition,e=c.id.substr(-1)-1,f=a.player.position[d]||a.player.nullPosition,g=c.value-0,h=f.ch[e].pattern;return a.player.position.length?a.modePlay?(c.value=h,!1):(f.ch[e].pattern=g,(a.workingPattern===g||a.workingPattern===h)&&a.updatePanelPattern(),a.player.countPositionFrames(d),a.updateTracklist(),a.updatePanelInfo(),void(a.file.modified=!0)):!1}},{selector:'input[id^="scChnTrans"]',method:"each",handler:function(b,c){$(this).TouchSpin({initval:"0",min:-24,max:24}).change(function(b){var c=b.target,d=c.id.substr(-1)-1,e=a.player.position[a.player.currentPosition];return a.player.position.length?a.modePlay?(c.value=e.ch[d].pitch,!1):(e.ch[d].pitch=c.value-0,void(a.file.modified=!0)):!1})}},{selector:'input[id^="scChnButton"]',method:"each",handler:function(b,c){var d=c.id.substr(-1);$(this).bootstrapToggle({on:d,off:d,onstyle:"default",offstyle:"default",size:"mini",width:58}).change(function(b){var c=b.target;a.player.rtSong.muted[c.value-1]=!c.checked})}},{selector:"#scSampleNumber,#scOrnTestSample",method:"TouchSpin",data:{initval:"1",radix:32,min:1,max:31}},{selector:"#scSampleNumber",method:"change",handler:function(){a.workingSample=parseInt($(this).val(),32),a.workingOrnTestSample=a.workingSample,a.updateSampleEditor(!0),a.smpornedit.updateSamplePitchShift(),$("#sbSampleScroll").scrollLeft(0),$("#scOrnTestSample").val(a.workingOrnTestSample.toString(32).toUpperCase())}},{selector:"#scOrnTestSample",method:"change",handler:function(){a.workingOrnTestSample=parseInt($(this).val(),32)}},{selector:"#scOrnNumber",method:"TouchSpin",data:{initval:"1",radix:16,min:1,max:15}},{selector:"#scOrnNumber",method:"change",handler:function(){a.workingOrnament=parseInt($(this).val(),16),a.smpornedit.updateOrnamentEditor(!0)}},{selector:"#txSampleName",method:"change",handler:function(b){a.player.sample[a.workingSample].name=b.target.value,a.file.modified=!0}},{selector:"#txOrnName",method:"change",handler:function(b){a.player.ornament[a.workingOrnament].name=b.target.value,a.file.modified=!0}},{selector:"#scSampleTone,#scOrnTone",method:"each",handler:function(b,c){var d="tx"+c.id.substr(2);$(this).TouchSpin({initval:a.workingSampleTone,min:1,max:96}).change(function(b){var c=b.target,d=c.value-0;a.workingSampleTone=d,$("#scSampleTone,#scOrnTone").val(d.toString()).prev().val(a.player.tones[d].txt)}).wrapAll('<div id="'+d+'"/>').removeAttr("style").prop("readonly",!0).clone(!1).removeAttr("id").removeAttr("tabindex").insertBefore(this),$(this).trigger("change")}},{selector:"#sbSampleScroll",method:"scroll",handler:function(b){a.smpornedit.smpeditScroll=0|b.target.scrollLeft/1e3*64,a.updateSampleEditor()}},{selector:"#scSampleLength,#scSampleRepeat,#scOrnLength,#scOrnRepeat",method:"TouchSpin",data:{initval:"0",min:0,max:255}},{selector:"#chSampleRelease",method:"change",handler:function(b){var c=a.player.sample[a.workingSample];c.end!==c.loop&&(c.releasable=b.target.checked),a.updateSampleEditor(!0),a.file.modified=!0}},{selector:"#scSampleLength",method:"change",handler:function(b){var c=a.player.sample[a.workingSample],d=parseInt(b.target.value,10)-c.end,e=c.loop+=d;c.end+=d,c.loop=c.end-e<0?0:e,a.updateSampleEditor(!0),a.file.modified=!0}},{selector:"#scSampleRepeat",method:"change",handler:function(b){var c=a.player.sample[a.workingSample],d=parseInt(b.target.value,10);c.loop=c.end-d,a.updateSampleEditor(!0),a.file.modified=!0}},{selector:"#fxOrnChords button",method:"each",handler:function(){var b=$(this).text(),c=a.smpornedit.chords[b],d=JSON.stringify(c.sequence,null,1).replace(/^\[|\]$|\s+/g,"");$(this).tooltip({html:!0,animation:!1,trigger:"hover",delay:{show:500,hide:0},title:c.name+"<kbd>{ "+d+" }</kbd>"}).click(function(){var b,d=a.player.ornament[a.workingOrnament],e=c.sequence.length;for(d.data.fill(0),d.name=c.name,d.loop=0,d.end=e,b=0;e>b;b++)d.data[b]=c.sequence[b];a.smpornedit.updateOrnamentEditor(!0),a.file.modified=!0})}},{selector:"#scOrnLength",method:"change",handler:function(b){var c=a.player.ornament[a.workingOrnament],d=parseInt(b.target.value,10)-c.end,e=c.loop+=d;c.end+=d,c.loop=c.end-e<0?0:e,a.smpornedit.updateOrnamentEditor(!0),a.file.modified=!0}},{selector:"#scOrnRepeat",method:"change",handler:function(b){var c=a.player.ornament[a.workingOrnament],d=parseInt(b.target.value,10);c.loop=c.end-d,a.smpornedit.updateOrnamentEditor(!0),a.file.modified=!0}},{selector:'#sample-tabpanel a[data-toggle="tab"]',method:"on",param:"show.bs.tab",handler:function(b){"tab-pitchshift"===b.target.id&&"tab-sampledata"===b.relatedTarget.id&&a.smpornedit.updateSamplePitchShift()}},{selector:'a[id^="miFileImportDemo"]',method:"click",handler:function(){var b=$(this).data().filename;return!b||a.modePlay||a.globalKeyState.lastPlayMode?!1:void a.file.loadDemosong(b)}},{selector:'a[id^="miHelp"]',method:"click",handler:function(){var b=$(this),c=b.data().filename;return c?void a.onCmdShowDocumentation(c):!1}},{selector:"#miFileNew",method:"click",handler:function(){a.onCmdFileNew()}},{selector:"#miFileOpen",method:"click",handler:function(){a.onCmdFileOpen()}},{selector:"#miFileSave",method:"click",handler:function(){a.onCmdFileSave()}},{selector:"#miFileSaveAs",method:"click",handler:function(){a.onCmdFileSave(!0)}},{selector:"#miAbout",method:"click",handler:function(){a.onCmdAbout()}},{selector:"#miStop",method:"click",handler:function(){a.onCmdStop()}},{selector:"#miSongPlay",method:"click",handler:function(){a.onCmdSongPlay()}},{selector:"#miSongPlayStart",method:"click",handler:function(){a.onCmdSongPlayStart()}},{selector:"#miPosPlay",method:"click",handler:function(){a.onCmdPosPlay()}},{selector:"#miPosPlayStart",method:"click",handler:function(){a.onCmdPosPlayStart()}},{selector:"#miToggleLoop",method:"click",handler:function(){a.onCmdToggleLoop()}},{selector:'button[id^="btPattern"]',method:"click",handler:function(){a[this.id.replace("btPattern","onCmdPat")]()}},{selector:"button[id^=btPos]",method:"click",handler:function(){a[this.id.replace("bt","onCmd")]()}},{selector:'button[id^="btSample"]',method:"click",handler:function(){var b=this.id.replace("btSample","onCmdSmp");b.endsWith("Stop")&&(b=b.replace("Smp","")),a[b]()}},{selector:'button[id^="btOrn"]',method:"click",handler:function(){var b=this.id.replace("btOrn","onCmdOrn");b.endsWith("Stop")&&(b=b.replace("Orn","")),a[b]()}}];$.ajax({cache:!0,contentType:!1,converters:{"text html":jQuery.parseHTML},dataType:"html",isLocal:!0,url:location.appPath+"Tracker.tpl.html",success:function(a){var d,e,f,g,h;for(d=0,e=a.length;e>d;d++)f=a[d],h=b[f.id]||"body",$(f).contents().appendTo(h);for(d=0,e=c.length;e>d;d++)f=c[d],g=f.handler||f.data,h=f.selector||f.global&&window[f.global],h&&f.method&&(f.param?$(h)[f.method](f.param,g):$(h)[f.method](g))}})},Tracker.prototype.initializeGUI=function(){var a=this,b=0,c=[function(){return a.smpornedit.initialized||!a.smpornedit.img||1===a.activeTab?!1:($("#tab-smpedit").tab("show"),!0)},function(){return a.smpornedit.initialized||!a.smpornedit.img||1!==a.activeTab?!1:(a.smpornedit.init(),$("#tab-ornedit").tab("show"),!0)},function(){return a.tracklist.initialized||!a.pixelfont.ctx||0===a.activeTab?!1:($("#tab-tracker").tab("show"),$(window).trigger("resize"),!0)},function(){return a.tracklist.initialized||!a.pixelfont.ctx||a.activeTab?!1:(a.updatePanels(),a.updateTracklist(!0),a.tracklist.initialized=!0,!0)},function(){return a.loaded?!1:(AudioDriver.play(),SyncTimer.start(function(){a.baseTimer()},20),!0)},function(){return a.loaded?!1:(document.body.className="",a.loaded=!0)}],d=function(){var a=c[b];a&&(a()&&b++,setTimeout(d,250))};d()};