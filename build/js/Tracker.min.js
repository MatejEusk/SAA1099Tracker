/*!
 * Tracker: Core of SAA1099Tracker.
 * Copyright (c) 2012-2015 Martin Borik <mborik@users.sourceforge.net>
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom
 * the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS
 * OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF
 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
$(document).ready(function(){window.Tracker=new Tracker("1.1.3")});var TracklistPosition=function(){function a(b,c,d,e,f,g){this.y=b||0,this.line=c||0,this.channel=d||0,this.column=e||0,this.start={x:f||0,y:g||0},this.set=function(b){if(!(b instanceof a))throw"invalid object type";this.y=b.y,this.line=b.line,this.channel=b.channel,this.column=b.column,this.start.x=b.start.x,this.start.y=b.start.y},this.compare=function(b){return b instanceof a?this.y===b.y&&this.line===b.line&&this.channel===b.channel&&this.column===b.column:void 0}}return a}(),Tracklist=function(){function a(a){this.initialized=!1,this.obj=null,this.ctx=null,this.zoom=2,this.canvasData={columns:[0,24,30,36,42,54,60,66],selWidth:78,chnWidth:84,lineWidth:516,center:0,trkOffset:0,vpad:0,offset:null},this.offsets={x:[new Array(9),new Array(9),new Array(9),new Array(9),new Array(9),new Array(9)],y:[]},this.selection={isDragging:!1,start:new TracklistPosition,len:0,line:0,channel:0},this.countTracklines=function(){var b=$("#statusbar").offset(),c=$("#tracklist").offset(),d=a.settings.tracklistLineHeight;return Math.max(((b.top-c.top)/d/this.zoom|1)-2,5)},this.setHeight=function(b){var c=a.settings;void 0===b&&(b=c.tracklistAutosize?this.countTracklines():c.tracklistLines),c.tracklistLines=b,b*=c.tracklistLineHeight,$(this.obj).prop("height",b).css({height:b*this.zoom}),this.canvasData.offset=$(this.obj).offset()},this.moveCurrentline=function(b,c){var d=a.player,e=d.currentLine+b,f=d.currentPosition,g=d.position[f];a.modePlay||void 0===g||(c?e=Math.min(Math.max(e,0),g.length-1):0>e?e+=g.length:e>=g.length&&(e-=g.length),d.currentLine=e)},this.pointToTracklist=function(b,c){var d,e,f,g=a.settings.tracklistLines,h=b/this.zoom,i=c/this.zoom,j=g>>1,k=a.player.currentLine-j;for(d=0;g>d;d++,k++)if(i>=this.offsets.y[d]&&i<=this.offsets.y[d+1])for(f=0;6>f;f++)if(h>=this.offsets.x[f][0]&&h<=this.offsets.x[f][8])for(e=0;8>e;e++)if(h>=this.offsets.x[f][e]&&h<=this.offsets.x[f][e+1])return new TracklistPosition(d,Math.max(k,0),f,e,b,c)}}return a}(),SmpOrnEditor=function(){function a(a){this.initialized=!1,this.img=null,this.amp={obj:null,ctx:null},this.noise={obj:null,ctx:null},this.range={obj:null,ctx:null},this.smpeditOffset=null,this.smpeditScroll=0,this.columnWidth=0,this.halfing=0,this.centering=0,this.radix=10,this.drag={isDragging:!1,freqEnableState:!1,rangeStart:-1},this.init=function(){var b,c,d,e,f,g,h,i=["amp","noise","range"];for(b=0,c=i.length;c>b;b++)d=this[i[b]],e=d.ctx,f=d.obj.width,g=d.obj.height,h=g>>1,e.miterLimit=0,e.fillStyle="#fcfcfc",e.fillRect(0,0,22,g),e.fillStyle="#ccc",e.fillRect(22,0,1,g),0===b&&(this.halfing=h-=12,this.columnWidth=(f-26)/64|0,this.centering=26+(f-64*this.columnWidth)>>1,e.fillRect(22,h,f-22,1),e.fillRect(22,286,f-22,1),e.save(),e.font=$("label").first().css("font"),e.translate(12,h),e.rotate(-Math.PI/2),e.textBaseline="middle",e.fillStyle="#888",e.textAlign="right",e.fillText("RIGHT",-16,0),e.textAlign="left",e.fillText("LEFT",16,0),e.restore()),e.drawImage(this.img,16*b,0,16,16,4,h-8,16,16);this.updateOffsets(),this.createPitchShiftTable(),this.createOrnamentEditorTable(),a.updateSampleEditor(!0),this.initialized=!0},this.updateOffsets=function(){var a=$(this.amp.obj).offset(),b=$(this.noise.obj).offset();this.smpeditOffset={left:a.left,top:{amp:a.top,noise:b.top}}},this.updateSamplePitchShift=function(){var b,c=a.player.sample[a.workingSample],d=c.end===c.loop;$("#fxSampleShift>.cell").each(function(a,e){b=c.data[a],a>=c.end&&!c.releasable?e.className="cell":!d&&a>=c.loop&&a<c.end?e.className="cell loop":e.className="cell on",$(e).find("input").val(parseInt(b.shift,this.radix))}),$("#fxSampleShift").parent().scrollLeft(0)},this.createPitchShiftTable=function(){var b,c,d=$("#fxSampleShift").empty(),e=$('<div class="cell"/>'),f=$('<input type="text" class="form-control">');for(b=0;256>b;b++)c=f.clone(),e.clone().append(c).appendTo(d),c.TouchSpin({prefix:b.toWidth(3),radix:this.radix=a.settings.hexSampleFreq?16:10,initval:0,min:-1023,max:1023}).change({index:b},function(b){var c=a.settings.hexSampleFreq?16:10,d=a.player.sample[a.workingSample],e=d.data,f=b.target;e[b.data.index].shift=parseInt(f.value,c)})},this.updateOrnamentEditor=function(b){var c=a.player.ornament[a.workingOrnament],d=c.end===c.loop;$("#fxOrnamentEditor>.cell").each(function(a,b){a>=c.end?b.className="cell":!d&&a>=c.loop&&a<c.end?b.className="cell loop":b.className="cell on",$(b).find("input").val(c.data[a])}),b&&($("#txOrnamentName").val(c.name),$("#fxOrnamentEditor").parent().scrollLeft(0),$("#scOrnamentLength").val(""+c.end),$("#scOrnamentRepeat").trigger("touchspin.updatesettings",{min:0,max:c.end}).val(c.end-c.loop))},this.createOrnamentEditorTable=function(){var b,c,d=$("#fxOrnamentEditor").empty(),e=$('<div class="cell"/>'),f=$('<input type="text" class="form-control">');for(b=0;256>b;b++)c=f.clone(),e.clone().append(c).appendTo(d),c.TouchSpin({prefix:b.toWidth(3),initval:0,min:-48,max:48}).change({index:b},function(b){var c=a.player.ornament[a.workingOrnament],d=b.target;c.data[b.data.index]=parseInt(d.value,10)})}}return a}(),Tracker=function(){function a(a){this.version=a,this.loaded=!1,this.activeTab=null,this.modePlay=!1,this.modeEdit=!1,this.modeEditChannel=0,this.modeEditColumn=0,this.workingPattern=0,this.workingSample=1,this.workingSampleTone=37,this.workingOrnament=1,this.workingOrnTestSample=1,this.ctrlOctave=2,this.ctrlSample=0,this.ctrlOrnament=0,this.ctrlRowStep=0,this.songTitle="",this.songAuthor="",this.globalKeyState={modsHandled:!1,lastPlayMode:0,length:0},this.settings={tracklistAutosize:!0,tracklistLines:17,tracklistLineHeight:9,hexTracklines:!0,hexSampleFreq:!1,audioInterrupt:50,audioBuffers:0},this.pixelfont={obj:null,ctx:null},this.tracklist=new Tracklist(this),this.smpornedit=new SmpOrnEditor(this),AudioDriver?(this.player=new Player(new SAASound(AudioDriver.sampleRate)),AudioDriver.init(this.player)):$("#overlay>span").html(browser.isIE?"don't be evil,<br>stop using IE":"WebAudio<br>not supported");var b=this;this.player&&(this.populateGUI(),SyncTimer.start(function(){b.baseTimer()},20))}return a.prototype.baseTimer=function(){this.modePlay?this.player.changedLine&&(this.player.changedPosition&&this.updatePanelPosition(),this.updatePanelInfo(),this.updateTracklist(),this.player.changedPosition=!1,this.player.changedLine=!1):this.smpornedit.initialized?this.tracklist.initialized?this.loaded||(document.body.className="",this.loaded=!0):this.pixelfont.ctx&&(0===this.activeTab?($(window).trigger("resize"),this.updatePanels(),this.updateTracklist(!0),this.tracklist.initialized=!0,AudioDriver.play()):$("#tab-tracker").tab("show")):this.smpornedit.img&&(1===this.activeTab?(this.smpornedit.init(),$("#tab-ornedit").tab("show")):$("#tab-smpedit").tab("show"))},a.prototype.loadDemosong=function(a){var b=this,c=this.player,d=this.settings;$.getJSON("demosongs/"+a+".json",function(a){c.clearSong(),c.clearSamples(),c.clearOrnaments(),b.songTitle=a.title,b.songAuthor=a.author;var e,f,g,h,i,j,k,l,m,n;for(h=0;32>h;h++)if(e=a.samples[h])for(n=c.sample[h],n.name=e.name,n.loop=e.loop,n.end=e.end,n.releasable=!!e.rel,i=0,j=0,g=atob(e.data);i<g.length;i+=3,j++)f=255&g.charCodeAt(i+1),n.data[j].volume.byte=255&g.charCodeAt(i),n.data[j].enable_freq=!!(128&f),n.data[j].enable_noise=!!(64&f),n.data[j].noise_value=(48&f)>>4,n.data[j].shift=(7&f)<<8|255&g.charCodeAt(i+2),8&f&&(n.data[j].shift*=-1);for(h=0;16>h;h++)if(e=a.ornaments[h])for(k=c.ornament[h],k.name=e.name,k.loop=e.loop,k.end=e.end,i=0,g=atob(e.data);i<g.length;i++)k.data[i]=g.charCodeAt(i);for(h=0;h<a.patterns.length;h++)if(g=a.patterns[h])for(g=atob(g),l=c.pattern[c.addNewPattern()],l.end=255&g.charCodeAt(0),i=1,j=0;i<g.length;i+=5,j++)l.data[j].tone=127&g.charCodeAt(i),l.data[j].release=!!(128&g.charCodeAt(i)),l.data[j].smp=31&g.charCodeAt(i+1),l.data[j].orn_release=!!(128&g.charCodeAt(i+1)),l.data[j].volume.byte=255&g.charCodeAt(i+2),l.data[j].orn=15&g.charCodeAt(i+3),l.data[j].cmd=(240&g.charCodeAt(i+3))>>4,l.data[j].cmd_data=255&g.charCodeAt(i+4);for(h=0;h<a.positions.length;h++)for(e=a.positions[h],g=atob(e.ch),m=c.position[h]=new pPosition(e.length,e.speed),i=0,j=0;6>i;i++)m.ch[i].pattern=255&g.charCodeAt(j++),m.ch[i].pitch=g.charCodeAt(j++);c.setInterrupt(d.audioInterrupt=a.config.audioInterrupt),c.currentPosition=a.config.currentPosition,c.repeatPosition=a.config.repeatPosition,c.currentLine=a.config.currentLine,b.modeEditChannel=a.config.editChannel,b.ctrlOctave=a.config.ctrlOctave,b.ctrlSample=a.config.ctrlSample,b.ctrlOrnament=a.config.ctrlOrnament,b.ctrlRowStep=a.config.ctrlRowStep,b.updatePanels(),b.updateTracklist(),b.updateSampleEditor(!0)})},a}();Tracker.prototype.updatePanels=function(){$("#scOctave").val(this.ctrlOctave),$("#scAutoSmp").val(this.ctrlSample),$("#scAutoOrn").val(this.ctrlOrnament),$("#scRowStep").val(this.ctrlRowStep),$("#txHeaderTitle").val(this.songTitle),$("#txHeaderAuthor").val(this.songAuthor),this.updatePanelInfo(),this.updatePanelPattern(),this.updatePanelPosition()},Tracker.prototype.updateEditorCombo=function(a){this.tracklist.moveCurrentline(a||this.ctrlRowStep),this.updateTracklist(),this.updatePanelInfo()},Tracker.prototype.updatePanelInfo=function(){var a,b=this.player,c=$("#stInfoPanel u"),d=this.settings.audioInterrupt,e=0,f=0,g=b.currentPosition,h=b.position.length,i=b.position[g],j=null,k=b.currentLine,l=-2&k,m=60*d;if(h){for(a=m/(i.frames[l+2]-i.frames[l])>>1,m=0;h>m;m++)j=b.position[m],m===g&&(f=e),e+=j.frames[j.length];f+=i.frames[k],m=e.toString().length,c[4].innerText=f.toWidth(m),c[5].innerText=e.toWidth(m),c[2].innerText=(f/d).toTimeString(),c[3].innerText=(e/d).toTimeString()}else a=m/this.player.currentSpeed>>2,c[2].innerText=c[3].innerText=0..toTimeString(),c[4].innerText=c[5].innerText="0";c[0].innerText=a,c[1].innerText=d},Tracker.prototype.updatePanelPattern=function(){var a,b=["#scPattern","#scPatternLen","#btPatternDelete","#btPatternClean","#btPatternInfo"],c=$(b[0]).prop("disabled"),d=this.workingPattern,e=this.player.pattern.length,f=0,g=0,h=!0;for(e--,e?(f=1,g=e,d=Math.max(Math.min(d,g),f)):d=0,a=1;6>=a;a++)$("#scChnPattern"+a).trigger("touchspin.updatesettings",{min:0,max:g});if(d?(h=!1,$(b[1]).val(this.player.pattern[d].end)):$(b[1]).val(64),this.workingPattern=d,$(b[0]).trigger("touchspin.updatesettings",{min:f,max:g,initval:d}).val(d),$("#txPatternUsed").val(this.player.countPatternUsage(d)),$("#txPatternTotal").val(e),h!==c)for(a=0,e=b.length;e>a;a++)$(b[a]+","+b[a]+"~span>button").prop("disabled",h)},Tracker.prototype.updatePanelPosition=function(){var a,b,c=["#scPosCurrent","#scPosLength","#scPosSpeed","#txPosTotal","#scPosRepeat"],d=$(c[0]).prop("disabled"),e=this.player.nullPosition,f=this.player.position.length,g=this.player.currentPosition,h=!0;for(f?(h=!1,$(c[0]+","+c[4]).trigger("touchspin.updatesettings",{min:1,max:f}),$(c[0]).val(g+1),$(c[3]).val(f),$(c[4]).val(this.player.repeatPosition+1),e=this.player.position[g]):($(c[0]+","+c[4]).val(0).trigger("touchspin.updatesettings",{min:0,max:0}),$(c[3]).val(0)),$(c[1]).val(e.length),$(c[2]).val(e.speed),b=0;6>b;b++)c.push(a="#scChnPattern"+(b+1)),$(a).val(e.ch[b].pattern),c.push(a="#scChnTrans"+(b+1)),$(a).val(e.ch[b].pitch);if(h!==d)for(c.splice(3,1),b=0,f=c.length;f>b;b++)$(c[b]+","+c[b]+"~span>button").prop("disabled",h);e=null},Tracker.prototype.onCmdStop=function(){this.player.stopChannel(),this.modePlay=!1,this.globalKeyState.lastPlayMode=0,0===this.activeTab&&this.updateTracklist(!0)},Tracker.prototype.onCmdSongPlay=function(){2!==this.globalKeyState.lastPlayMode&&(0===this.activeTab&&this.doc.setStatusText(),this.modePlay=this.player.playPosition(!1,!0,!0))},Tracker.prototype.onCmdSongPlayStart=function(){0===this.activeTab&&this.doc.setStatusText(),this.modePlay=this.player.playPosition(!0,!0,!0)},Tracker.prototype.onCmdPosPlay=function(){1!==this.globalKeyState.lastPlayMode&&(0===this.activeTab&&this.doc.setStatusText(),this.modePlay=this.player.playPosition(!1,!1,!1))},Tracker.prototype.onCmdPosPlayStart=function(){0===this.activeTab&&this.doc.setStatusText(),this.modePlay=this.player.playPosition(!1,!1,!0)},Tracker.prototype.onCmdToggleLoop=function(){var a=this.player.loopMode=!this.player.loopMode,b=$("a#miToggleLoop>span"),c="glyphicon-repeat",d="glyphicon-remove-circle",e=a?c:d,f=a?"#000":"#ccc";b.removeClass(c+" "+d),b.addClass(e).css({color:f})},Tracker.prototype.onCmdToggleEditMode=function(){var a=this.modeEdit=!this.modeEdit,b=$(".tracklist-panel");a||this.doc.setStatusText(),b[a?"addClass":"removeClass"]("edit"),this.updateTracklist(!0)},Tracker.prototype.onCmdShowDocumentation=function(a,b){var c="doc/"+a+".txt",d=$("#documodal"),e=this.doc.txtCache,f=e[a];f?(d.find(".modal-title").text(b),d.modal("show").find("pre").text(f)):$.ajax(c,{contentType:"text/plain",dataType:"text",success:function(c){e[a]=c.trim(),d.find(".modal-title").text(b),d.modal("show").find("pre").text(c)}})},Tracker.prototype.onCmdAbout=function(){var a=$("#about"),b=a.data();b.hasOwnProperty("bs.modal")||a.find(".ver").text("v"+this.version),a.modal("toggle")},Tracker.prototype.onCmdPatCreate=function(){if(!this.modePlay){var a=this.player.addNewPattern(),b=this.player.pattern[a],c=this.workingPattern&&this.player.pattern[this.workingPattern].end||64;b.end=c,this.workingPattern=a,this.updatePanelPattern(),$("#scPatternLen").focus()}},Tracker.prototype.onCmdPatDelete=function(){if(!this.modePlay&&this.workingPattern){var a,b,c,d,e=this.workingPattern,f=this.player.pattern.length-1,g=null;for(this.player.countPatternUsage(e)>0&&(g="This pattern is used in some positions!\nAre you sure to delete it?"),e!==f&&(g="This is not the last pattern in a row and there is necessary to renumber all of the next patterns in the positions!\n\nPlease, take a note that all of your undo history will be lost because of pattern/position data inconsistency that occurs with this irreversible operation.\n\nDo you really want to continue?"),g||(g="Are you sure to delete this pattern?"),a=0,b=this.player.position.length;b>a;a++)for(d=this.player.position[a],c=0;6>c;c++)d.ch[c].pattern===e?d.ch[c].pattern=0:d.ch[c].pattern>e&&d.ch[c].pattern--;this.player.pattern.splice(e,1),e===f&&e--,this.workingPattern=e,this.updatePanelInfo(),this.updatePanelPattern(),this.updatePanelPosition(),this.updateTracklist()}},Tracker.prototype.onCmdPatClean=function(){if(!this.modePlay&&this.workingPattern)for(var a=this.player.pattern[this.workingPattern].data,b=0,c=a[b];96>b;b++,c=a[b])c.tone=0,c.release=!1,c.smp=0,c.orn=0,c.orn_release=!1,c.volume.byte=0,c.cmd=0,c.cmd_data=0},Tracker.prototype.onCmdPatInfo=function(){},Tracker.prototype.onCmdPosCreate=function(){if(!this.modePlay){var a=this.player,b=a.position.length,c=a.position[a.currentPosition]||a.nullPosition,d=new pPosition(c.length,c.speed);a.position.push(d),a.countPositionFrames(b),a.currentPosition=b,a.currentLine=0,this.updatePanelInfo(),this.updatePanelPosition(),this.updateTracklist()}},Tracker.prototype.onCmdPosInsert=function(){if(!this.modePlay){if(!this.player.position.length)return this.onCmdPosCreate();var a,b=this.player,c=b.currentPosition,d=b.position[c]||b.nullPosition,e=new pPosition(d.length,d.speed);for(a=0;6>a;a++)e.ch[a].pattern=d.ch[a].pattern,e.ch[a].pitch=d.ch[a].pitch;b.position.splice(c,0,e),b.countPositionFrames(c),b.currentLine=0,this.updatePanelInfo(),this.updatePanelPattern(),this.updatePanelPosition(),this.updateTracklist()}},Tracker.prototype.onCmdPosDelete=function(){!this.modePlay&&this.player.position.length&&(this.player.position.splice(this.player.currentPosition,1),this.player.currentLine=0,this.updatePanelInfo(),this.updatePanelPattern(),this.updatePanelPosition(),this.updateTracklist())},Tracker.prototype.onCmdPosMoveUp=function(){var a=this.player,b=a.currentPosition,c=a.position[b];!this.modePlay&&a.position.length&&b&&(a.position[b]=a.position[--b],a.position[b]=c,a.currentPosition=b,a.currentLine=0,this.updatePanelInfo(),this.updatePanelPosition(),this.updateTracklist())},Tracker.prototype.onCmdPosMoveDown=function(){var a=this.player,b=a.currentPosition,c=a.position.length,d=a.position[b];!this.modePlay&&c&&b!==c-1&&(a.position[b]=a.position[++b],a.position[b]=d,a.currentPosition=b,a.currentLine=0,this.updatePanelInfo(),this.updatePanelPosition(),this.updateTracklist())},Tracker.prototype.onCmdSmpPlay=function(){this.player.playSample(this.workingSample,0,this.workingSampleTone)},Tracker.prototype.onCmdSmpClear=function(){},Tracker.prototype.onCmdSmpSwap=function(){for(var a,b=this.player.sample[this.workingSample].data,c=0;256>c;c++)a=b[c].volume.L,b[c].volume.L=b[c].volume.R,b[c].volume.R=a;this.updateSampleEditor()},Tracker.prototype.onCmdSmpLVolUp=function(){for(var a=this.player.sample[this.workingSample],b=a.data,c=0;256>c;c++)(c<a.end&&b[c].volume.L<15||c>=a.end&&b[c].volume.L>0&&b[c].volume.L<15)&&b[c].volume.L++;this.updateSampleEditor()},Tracker.prototype.onCmdSmpLVolDown=function(){for(var a=this.player.sample[this.workingSample].data,b=0;256>b;b++)a[b].volume.L>0&&a[b].volume.L--;this.updateSampleEditor()},Tracker.prototype.onCmdSmpRVolUp=function(){for(var a=this.player.sample[this.workingSample],b=a.data,c=0;256>c;c++)(c<a.end&&b[c].volume.R<15||c>=a.end&&b[c].volume.R>0&&b[c].volume.R<15)&&b[c].volume.R++;this.updateSampleEditor()},Tracker.prototype.onCmdSmpRVolDown=function(){for(var a=this.player.sample[this.workingSample].data,b=0;256>b;b++)a[b].volume.R>0&&a[b].volume.R--;this.updateSampleEditor()},Tracker.prototype.onCmdSmpCopyLR=function(){for(var a=this.player.sample[this.workingSample].data,b=0;256>b;b++)a[b].volume.R=a[b].volume.L;this.updateSampleEditor()},Tracker.prototype.onCmdSmpCopyRL=function(){for(var a=this.player.sample[this.workingSample].data,b=0;256>b;b++)a[b].volume.L=a[b].volume.R;this.updateSampleEditor()},Tracker.prototype.onCmdSmpRotL=function(){for(var a,b=this.player.sample[this.workingSample].data,c=0;256>c;c++)a=b[(c+1)%256],b[c].volume.byte=a.volume.byte,b[c].enable_freq=a.enable_freq,b[c].enable_noise=a.enable_noise,b[c].noise_value=a.noise_value,b[c].shift=a.shift;this.updateSampleEditor()},Tracker.prototype.onCmdSmpRotR=function(){for(var a,b=this.player.sample[this.workingSample].data,c=255;c>=0;c--)a=b[c-1&255],b[c].volume.byte=a.volume.byte,b[c].enable_freq=a.enable_freq,b[c].enable_noise=a.enable_noise,b[c].noise_value=a.noise_value,b[c].shift=a.shift;this.updateSampleEditor()},Tracker.prototype.onCmdSmpEnable=function(){for(var a=this.player.sample[this.workingSample].data,b=0;256>b;b++)a[b].volume.byte&&(a[b].enable_freq=!0);this.updateSampleEditor()},Tracker.prototype.onCmdSmpDisable=function(){for(var a=this.player.sample[this.workingSample].data,b=0;256>b;b++)a[b].enable_freq=!1;this.updateSampleEditor()},Tracker.prototype.hotkeyMap=function(a,b,c){var d=this,e=c>32&&41>c,f=/keyup|test/.test(a),g=/keydown|test/.test(a);switch(b){case"globalCtrl":if(!f)return;return{79:function(){},83:function(){},89:function(){},90:function(){}}[c];case"globalFs":if(!g)return;return{27:function(){d.modePlay?d.onCmdStop():d.modeEdit&&d.onCmdToggleEditMode()},112:function(){d.onCmdAbout()},113:function(){$("#tab-tracker").tab("show")},114:function(){$("#tab-smpedit").tab("show")},115:function(){$("#tab-ornedit").tab("show")},116:function(){d.onCmdSongPlay()},117:function(){d.onCmdSongPlayStart()},118:function(){d.onCmdPosPlay()},119:function(){d.onCmdPosPlayStart()},120:function(){},121:function(){},122:function(){d.onCmdToggleLoop()},123:function(){}}[c];case"trackerCtrl":if(!("repeat"===a&&[38,40,48,57].indexOf(c)>=0||g))return;return c>96&&103>c?c=96:c>48&&57>c&&(c=56),{38:function(){var a=d.player.currentLine;return(a=a>=16&&(240&a)===a?16:15&a)?void d.updateEditorCombo(-a):!1},40:function(){var a=d.player.position[d.player.currentPosition]||d.player.nullPosition,b=d.player.currentLine,c=a.length;b=c-16>b?16-(15&b):c-b-1,d.updateEditorCombo(b)},48:function(){d.ctrlRowStep=parseInt($("#scRowStep").trigger("touchspin.uponce").val(),10)},56:function(a){a-=48,$("#scOctave").val(a),d.ctrlOctave=a},57:function(){d.ctrlRowStep=parseInt($("#scRowStep").trigger("touchspin.downonce").val(),10)},96:function(a){a-=96,$("#scChnButton"+a).bootstrapToggle("toggle")}}[c];case"trackerCtrlShift":if(!f)return;return{37:function(){$("#scPosCurrent").trigger("touchspin.downonce")},39:function(){$("#scPosCurrent").trigger("touchspin.uponce")}}[c];case"editorShift":if(!g||!d.modeEdit||!d.player.position.length)return;return{9:function(){d.modeEditChannel>0?d.modeEditChannel--:d.modeEditChannel=5,d.updateTracklist()}}[c];case"editorKeys":if(!(g||"repeat"===a&&e))return;if(e)if(d.modePlay)d.onCmdStop();else if(!d.player.position.length||!d.modeEdit&&d.modePlay)return;return{9:function(){d.player.position.length&&d.modeEdit&&(d.modeEditChannel<5?d.modeEditChannel++:d.modeEditChannel=0,d.updateTracklist())},32:function(){d.modePlay&&d.onCmdStop(),d.player.position.length&&d.onCmdToggleEditMode()},33:function(){var a=d.settings.tracklistLines+1;d.tracklist.moveCurrentline(-(a>>1),!0),d.updateTracklist(),d.updatePanelInfo()},34:function(){var a=d.settings.tracklistLines+1;d.tracklist.moveCurrentline(a>>1,!0),d.updateTracklist(),d.updatePanelInfo()},35:function(){d.tracklist.moveCurrentline(96,!0),d.updateTracklist(),d.updatePanelInfo()},36:function(){d.tracklist.moveCurrentline(-96,!0),d.updateTracklist(),d.updatePanelInfo()},37:function(){d.modeEdit&&(d.modeEditColumn>0?d.modeEditColumn--:(d.modeEditColumn=7,d.modeEditChannel>0?d.modeEditChannel--:d.modeEditChannel=5),d.updateTracklist())},38:function(){d.updateEditorCombo(-1)},39:function(){d.modeEdit&&(d.modeEditColumn<7?d.modeEditColumn++:(d.modeEditColumn=0,d.modeEditChannel<5?d.modeEditChannel++:d.modeEditChannel=0),d.updateTracklist())},40:function(){d.updateEditorCombo(1)}}[c];case"editorEdit":if(!g)return;var h=d.player.currentLine,i=d.player.position[d.player.currentPosition]||d.player.nullPosition,j=i.ch[d.modeEditChannel].pattern,k=d.player.pattern[j],l=k.data[h];if(h<k.end)switch(c){case 8:return function(){for(var a=h,b=h+1;96>b;a++,b++)k.data[a]=k.data[b];k.data[a].tone=k.data[a].smp=k.data[a].orn=0,k.data[a].release=k.data[a].orn_release=!1,k.data[a].cmd=k.data[a].cmd_data=k.data[a].volume.byte=0,d.updateTracklist()};case 45:return function(){for(var a=96-h,b=a-1,c=94;c>=h;b--,c--)k.data[b]=k.data[c];k.data[b].tone=k.data[b].smp=k.data[b].orn=0,k.data[b].release=k.data[b].orn_release=!1,k.data[b].cmd=k.data[b].cmd_data=k.data[b].volume.byte=0,d.updateTracklist()};case 46:return function(){switch(d.modeEditColumn){default:case 0:l.tone=0,l.release=0;break;case 1:l.smp=0;break;case 2:l.orn=0,l.orn_release=0;break;case 3:case 4:l.volume.byte=0;break;case 5:l.cmd=0,l.cmd_data=0;break;case 6:l.cmd_data&=15;break;case 7:l.cmd_data&=240}d.updateEditorCombo()};default:var m={0:function(a,b){var c=d.getKeynote(a);return 0>c?!1:b?!0:(c>0?(l.release=!1,l.tone=c,d.ctrlSample&&!l.smp&&(l.smp=d.ctrlSample),d.ctrlOrnament&&!l.orn&&(l.orn=d.ctrlOrnament,l.orn_release=!1)):(l.release=!0,l.tone=0,l.smp=0,l.orn=0,l.orn_release=!1),void d.updateEditorCombo())},1:function(a,b){if(a>=48&&57>=a){if(b)return!0;l.smp=a-48}else{if(!(a>=65&&86>=a))return!1;if(b)return!0;l.smp=a-55}d.updateEditorCombo()},2:function(a,b){if(a>=48&&57>=a){if(b)return!0;l.orn_release=!1,l.orn=a-48}else if(a>=65&&70>=a){if(b)return!0;l.orn_release=!1,l.orn=a-55}else{if(88!==a&&189!==a)return!1;if(b)return!0;l.orn_release=!0,l.orn=0}d.updateEditorCombo()},3:function(a,b){if(a>=48&&57>=a){if(b)return!0;l.volume.L=a-48}else{if(!(a>=65&&70>=a))return!1;if(b)return!0;l.volume.L=a-55}d.updateEditorCombo()},4:function(a,b){if(a>=48&&57>=a){if(b)return!0;l.volume.R=a-48}else{if(!(a>=65&&70>=a))return!1;if(b)return!0;l.volume.R=a-55}d.updateEditorCombo()},5:function(a,b){if(a>=48&&57>=a){if(b)return!0;l.cmd=a-48}else{if(!(a>=65&&70>=a))return;if(b)return!0;l.cmd=a-55,15==l.cmd&&l.cmd_data&&d.player.countPositionFrames(d.player.currentPosition)}d.updateEditorCombo()},6:function(a,b){if(a>=48&&57>=a)a-=48;else{if(!(a>=65&&70>=a))return!1;a-=55}return b?!0:(l.cmd_data&=15,l.cmd_data|=a<<4,15==l.cmd&&l.cmd_data&&d.player.countPositionFrames(d.player.currentPosition),void d.updateEditorCombo())},7:function(a,b){if(a>=48&&57>=a)a-=48;else{if(!(a>=65&&70>=a))return!1;a-=55}return b?!0:(l.cmd_data&=240,l.cmd_data|=a,15==l.cmd&&l.cmd_data&&d.player.countPositionFrames(d.player.currentPosition),void d.updateEditorCombo())}}[d.modeEditColumn];return m(c,!0)?m:void 0}default:return}},Tracker.prototype.handleKeyEvent=function(a){var b=this.globalKeyState,c=a.type,d=a.target&&"text"===a.target.type,e=d&&/touchspin/.test(a.target.parentElement.className),f=a.which||a.charCode||a.keyCode,g=!!this.player.position.length;if(browser.isOpera&&219===f)f=91;else if(browser.isFirefox)switch(f){case 59:f=186;break;case 61:f=187;break;case 173:f=189}if("keydown"===c){if(f>=16&&18>=f&&(b.modsHandled=!1,2===a.location&&(f+=256)),a.repeat?c="repeat":b[f]||(b[f]=!0,b.length++),e&&!this.handleHotkeys("test",f)||!e&&d&&!b[9])return!0;this.handleHotkeys(c,f)||0===this.activeTab&&(b[13]&&1===b.length&&g&&!this.modePlay&&!b.lastPlayMode?(this.modePlay=this.player.playPosition(!1,!1,!1),b.lastPlayMode=3):b[13]&&b.length>1&&this.modePlay&&3===b.lastPlayMode&&(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0)),d&&b[9]&&(delete b[9],b.length--,a.target.blur())}else if("keyup"===c&&(b[f]&&this.handleHotkeys(c,f)&&(d=!1),!b.modsHandled&&g&&(1===b.length&&b[272]?(this.modePlay&&1===b.lastPlayMode?(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0):(this.modePlay=this.player.playPosition(!1,!1,!0),b.lastPlayMode=1),b.modsHandled=!0):1===b.length&&b[273]&&(this.modePlay&&2===b.lastPlayMode?(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0):(this.modePlay=this.player.playPosition(!1,!0,!0),b.lastPlayMode=2),b.modsHandled=!0)),0===this.activeTab&&b[13]&&this.modePlay&&3===b.lastPlayMode&&(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0),b[f]&&(delete b[f],b.length&&b.length--),b[f+256]&&(delete b[f+256],b.length&&b.length--),d))return!0;return a.preventDefault(),!1},Tracker.prototype.handleHotkeys=function(a,b){var c=this.globalKeyState,d=!1;return c[17]&&17!==b?(90===b&&c[16]&&(delete c[b],delete c[16],c.length&&c.length--,c[--b]=!0),2===c.length?82===b||116===b?(d=!0,a="test"):(d=this.hotkeyMap(a,"globalCtrl",b))||(0!==this.activeTab||(d=this.hotkeyMap(a,"trackerCtrl",b))?1===this.activeTab?d=this.hotkeyMap(a,"smpeditCtrl",b):2===this.activeTab&&(d=this.hotkeyMap(a,"orneditCtrl",b)):d=this.hotkeyMap(a,"editorCtrl",b)):3===c.length&&c[16]&&0===this.activeTab&&(d=this.hotkeyMap(a,"trackerCtrlShift",b))):c[16]&&16!==b&&2===c.length&&0===this.activeTab?d=this.hotkeyMap(a,"editorShift",b):1===c.length&&((d=this.hotkeyMap(a,"globalFs",b))||(0===this.activeTab?!(d=this.hotkeyMap(a,"editorKeys",b))&&this.player.position.length&&this.modeEdit&&(d=this.hotkeyMap(a,"editorEdit",b)):d=this.hotkeyMap(a,"smpornKeys",b))),d?("test"!==a&&(d(b),c.modsHandled=!0),!0):void 0},Tracker.prototype.getKeynote=function(a){var b=12*(this.ctrlOctave-1),c=String.fromCharCode(a),d=" ZSXDCVGBHNJMQ2W3ER5T6Y7UI9O0P".indexOf(c);return d>0?b+d:(d={49:0,65:0,192:0,189:0,222:0,188:b+13,76:b+14,190:b+15,186:b+16,191:b+17,219:b+30,187:b+31,221:b+32}[a])>=0?d:-1},Tracker.prototype.handleMouseEvent=function(a,b,c){if("tracklist"===a){var d,e=!1,f=this.player,g=f.position[f.currentPosition],h=b.selection,i=b.canvasData.offset,j=b.pointToTracklist(c.pageX-i.left,c.pageY-i.top),k=f.currentLine;if(this.modePlay||!g||!j)return;j.line=Math.min(j.line,g.length-1),d=j.line-h.start.line,"mousewheel"===c.type?(c.target.focus(),c.delta<0?b.moveCurrentline(1):c.delta>0&&b.moveCurrentline(-1),e=!0):"mousedown"===c.type?(c.target.focus(),1===c.which&&j.line<g.length&&h.start.set(j)):"mouseup"===c.type&&1===c.which?h.isDragging?(h.len=d,h.line=h.start.line,h.channel=h.start.channel,h.isDragging=!1,e=!0):(this.modeEdit||(this.modeEdit=e=!0),j.line===k&&(this.modeEditChannel=h.start.channel,this.modeEditColumn=h.start.column,e=!0)):"dblclick"===c.type&&1===c.which?(h.len=0,h.line=j.line,h.channel=j.channel,h.isDragging=!1,this.modeEditChannel=h.start.channel,this.modeEditColumn=h.start.column,f.currentLine=j.line,e=!0):"mousemove"!==c.type||1!==c.which||j.compare(h.start)||(d>0&&(h.len=d,h.line=h.start.line,h.channel=h.start.channel,h.isDragging=!0),j.y===this.settings.tracklistLines-1&&b.moveCurrentline(1,!0),e=!0),e&&(h.isDragging||(d=0,this.modeEditColumn>=5&&(d=f.pattern[g.ch[this.modeEditChannel].pattern].data[k].cmd),this.doc.showTracklistStatus(this.modeEditColumn,d)),this.updateTracklist(),this.updatePanelInfo())}else{var l,m,n,o=this.player.sample[this.workingSample],p=c.pageX-b.smpeditOffset.left-b.centering,q=c.pageY,r=/mouse(down|move)/.test(c.type),s=!1,t=!1;if(0>p)return;if(p=Math.min(0|p/b.columnWidth,63)+b.smpeditScroll,m=n=p,l=o.data[p],"amp"===a){q-=b.smpeditOffset.top.amp;var u=b.amp.obj.height-24,v=q<b.halfing,w=q>u+3||b.drag.isDragging;w&&1===c.which?("mousedown"===c.type?(d=b.drag.freqEnableState=!l.enable_freq,b.drag.isDragging=!0):"mouseup"===c.type?(d=b.drag.freqEnableState,b.drag.isDragging=!1):b.drag.isDragging&&"mousemove"===c.type&&(d=b.drag.freqEnableState),l.enable_freq!==d&&(l.enable_freq=d,s=!0)):"mousewheel"===c.type?(d=c.delta/Math.abs(c.delta),v?l.volume.L=Math.min(l.volume.L+d,15):l.volume.R=Math.max(l.volume.R-d,0),s=!0):r&&1===c.which&&(v?l.volume.L=Math.max(15-(0|q/9),0):l.volume.R=Math.max(15-(0|(u-q)/9),0),s=!0)}else"noise"===a?(q-=b.smpeditOffset.top.noise,d=(0|l.enable_noise)*(l.noise_value+1),"mousewheel"===c.type?(d+=c.delta/Math.abs(c.delta),s=!0):r&&1===c.which&&(d=4-(0|q/9),s=!0),s&&(d=Math.min(Math.max(d,0),4),l.enable_noise=!!d,l.noise_value=Math.max(--d,0))):"range"===a&&1===c.which&&("mouseup"===c.type?(b.drag.isDragging=!1,s=!0):"mousedown"===c.type?(b.drag.isDragging=1,b.drag.rangeStart=p,s=!0):b.drag.isDragging&&"mousemove"===c.type&&(b.drag.isDragging=2,s=!0),s&&(p===b.drag.rangeStart?2===b.drag.isDragging?(o.end=p+1,o.loop=p):1===b.drag.isDragging&&(o.end=++p,o.loop=p):p>b.drag.rangeStart?(o.end=++p,o.loop=b.drag.rangeStart):(o.end=b.drag.rangeStart+1,o.loop=p),t=!0,1===b.drag.isDragging?m=n=void 0:(m=o.loop-1,n=o.end)));s&&this.updateSampleEditor(t,m,n)}},Tracker.prototype.initPixelFont=function(a){var b,c,d,e=["#fff","#f00","#38c","#000","#800"],f=this.pixelfont,g=10*e.length,h=a.width;for(f.obj=document.createElement("canvas"),f.obj.width=h,f.obj.height=g,f.ctx=f.obj.getContext("2d"),b=0;g>b;b+=10)f.ctx.fillStyle=e[b/10],f.ctx.fillRect(0,b,h,10);for(c=document.createElement("canvas"),c.width=h,c.height=5,d=c.getContext("2d"),d.save(),d.clearRect(0,0,h,5),d.drawImage(a,0,0),d.fillStyle="#fff",d.globalCompositeOperation="source-in",d.fillRect(0,0,h,5),d.restore(),b=0;g>b;b+=10)f.ctx.drawImage(c,0,b);for(d.save(),d.clearRect(0,0,h,5),d.drawImage(a,0,0),d.fillStyle="#aaa",d.globalCompositeOperation="source-in",d.fillRect(0,0,h,5),d.restore(),b=5;g>b;b+=10)f.ctx.drawImage(c,0,b);f.ctx.drawImage(a,0,0),d=null,c=null},Tracker.prototype.updateTracklist=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p=this.tracklist.canvasData,q=this.tracklist.selection,r=this.tracklist.offsets,s=this.player,t=this.settings.hexTracklines?16:10,u=this.pixelfont.obj,v=this.tracklist.ctx,w=s.currentPosition,x=s.position[w]||s.nullPosition,y=this.tracklist.obj.width,z=this.settings.tracklistLineHeight,A=this.settings.tracklistLines,B=A>>1,C=s.currentLine-B,D=function(a){return 6*(e.charCodeAt(a||0)-32)};for(a&&(p.center=y-p.lineWidth>>1,p.vpad=Math.round((z-5)/2),p.trkOffset=p.center+24,r.y=[]),i=0,n=0,m=p.vpad;A>i;i++,C++,m+=z,n+=z){if(a&&(r.y[i]=n),i!==B?(g=0,v.clearRect(p.center,n,p.lineWidth,z)):this.modeEdit?(g=10,v.fillStyle="#f00",v.fillRect(0,n,y,z)):(g=20,v.fillStyle="#38c",v.fillRect(0,n,y,z)),0>C){if(!w||!x)continue;b={pp:x,line:C},x=s.position[w-1],C+=x.length}else if(C>=x.length){
if(!(w<s.position.length-1&&x))continue;b={pp:x,line:C},C-=x.length,x=s.position[w+1]}for(e=("0"+C.toString(t)).substr(-2),v.drawImage(u,D(0),g,5,5,p.center,m,5,5),v.drawImage(u,D(1),g,5,5,p.center+6,m,5,5),h=0;6>h;h++)for(c=s.pattern[x.ch[h].pattern],d=c.data[C],j=0;8>j;j++)if(l=p.trkOffset+h*p.chnWidth+p.columns[j],a&&(r.x[h][j]=l,!j&&h&&(r.x[h-1][8]=l)),f=g,(i!==B||!this.modeEdit)&&q.len&&q.channel===h&&C>=q.line&&C<=q.line+q.len?(j||(v.fillStyle="#000",v.fillRect(l-3,n,p.selWidth,z)),f=30):i===B&&this.modeEdit&&this.modeEditChannel===h&&this.modeEditColumn===j&&(o=j>=5?d.cmd:0,v.fillStyle="#800",j?v.fillRect(l-1,n,7,z):v.fillRect(l-2,n,22,z),f=40),C>=c.end&&(f+=5),j){switch(k=-1,j){case 1:d.smp&&(k=d.smp);break;case 2:d.orn_release?k=33:d.orn&&(k=d.orn);break;case 3:d.volume.byte&&(k=d.volume.L);break;case 4:d.volume.byte&&(k=d.volume.R);break;case 5:(d.cmd||d.cmd_data)&&(k=d.cmd);break;case 6:(d.cmd||d.cmd_data)&&(k=(240&d.cmd_data)>>4);break;case 7:(d.cmd||d.cmd_data)&&(k=15&d.cmd_data)}e=0>k?"":k.toString(36),v.drawImage(u,D(),f,5,5,l,m,5,5)}else e="---",d.release?e="R--":d.tone&&(e=s.tones[d.tone].txt),v.drawImage(u,D(0),f,5,5,l,m,5,5),v.drawImage(u,D(1),f,5,5,l+6,m,5,5),v.drawImage(u,D(2),f,5,5,l+12,m,5,5);b&&(x=b.pp,C=b.line,b=void 0,v.save(),v.fillStyle="rgba(255,255,255,.75)",v.globalCompositeOperation="xor",v.fillRect(p.center,m,p.lineWidth,5),v.restore())}!this.modePlay&&this.modeEdit&&void 0!==o&&this.doc.showTracklistStatus(this.modeEditColumn,o),a&&(r.x[5][8]=y,r.x[0][0]=0,r.y[i]=n)},Tracker.prototype.updateSampleEditor=function(a,b,c){var d,e,f,g,h,i,j,k=this.smpornedit,l=this.player.sample[this.workingSample],m=k.amp.ctx,n=k.noise.ctx,o=k.range.ctx,p=m.getImageData(22,0,1,1),q=k.halfing,r=k.smpeditScroll,s=r+64,t=k.columnWidth,u=k.centering,v=t-1;for(void 0!==b&&(f=Math.max(r,b),u+=(f-r)*t,r=f),void 0!==c&&(s=Math.min(s,++c));s>r;r++,u+=t){for(d=r>=l.end&&!l.releasable?"#888":l.loop!=l.end&&r>=l.loop&&r<l.end?"#38c":"#000",o.strokeStyle=o.fillStyle=n.fillStyle=m.strokeStyle=m.fillStyle=d,e=l.data[r],i=e.volume.L,j=e.volume.R,g=q-12,h=q+5,f=0;15>f;f++,g-=9,h+=9)m.clearRect(u,g,v,8),m.putImageData(p,u,g+7),i>f&&m.fillRect(u,g,v,8),m.clearRect(u,h,v,8),m.putImageData(p,u,h),j>f&&m.fillRect(u,h,v,8);for(m.clearRect(u,292,v,12),m.strokeRect(u-.5,291.5,v-1,12),e.enable_freq&&m.fillRect(u+1,293,v-4,9),f=0,g=34;4>f;f++,g-=9)n.clearRect(u,g,v,8),n.putImageData(p,u,g+7),e.enable_noise&&f<=e.noise_value&&n.fillRect(u,g,v,8);o.clearRect(u,4,12,8),r>=l.end?o.fillRect(u,12,12,1):(o.fillRect(u,10,12,3),l.loop<=l.end&&r===l.end-1&&(o.beginPath(),o.moveTo(u,10),o.lineTo(u+12,10),o.lineTo(u+12,4),o.closePath(),o.fill()),l.loop<l.end&&r===l.loop&&(o.beginPath(),o.moveTo(u,10),o.lineTo(u+12,10),o.lineTo(u,4),o.closePath(),o.fill()))}a&&(i=l.end===l.loop,$("#txSampleName").val(l.name),$("#scSampleLength").val(""+l.end),$("#scSampleRepeat").trigger("touchspin.updatesettings",{min:0,max:l.end}).val(l.end-l.loop),i&&l.releasable&&(l.releasable=!1),$("#chSampleRelease").prop("checked",l.releasable),$("#chSampleRelease").prop("disabled",i).parent()[i?"addClass":"removeClass"]("disabled"))},Tracker.prototype.doc={txtCache:{},tooltip:{miFileNew:"New",miFileOpen:"Open [Ctrl+O]",miFileSave:"Save [Ctrl+S]",miFileSaveAs:"Save as...",miEditCut:"Cut [Ctrl+X]",miEditCopy:"Copy [Ctrl+C]",miEditPaste:"Paste [Ctrl+V]",miEditClear:"Clear [Ctrl+D]",miEditUndo:"Undo [Ctrl+Z]",miEditRedo:"Redo [Ctrl+Y | Ctrl+Shift+Z]",miStop:"Stop [Esc]",miSongPlay:"Play song [F5]",miSongPlayStart:"Play song from start [F6]",miPosPlay:"Play position [F7]",miPosPlayStart:"Play position from start [F8]",miToggleLoop:"Toggle repeat [F11]",miManager:"Track manager [F9]",miPreferences:"Preferences [F10]",miSpecialLogin:"Login to SAA-1099\ncloud for musicians",scOctave:"Base octave [Ctrl+1...Ctrl+8]",scAutoSmp:"Auto-typed sample",scAutoOrn:"Auto-typed ornament",scRowStep:"Row-step in edit mode [- Ctrl+9 | Ctrl+0 +]",btPatternCreate:"Create a new pattern\nin length of current",btPatternDelete:"Delete the current pattern\n(and renumber others if it isn't last one)",btPatternClean:"Clear content of current pattern",btPatternInfo:"View summary dialog of patterns",scPattern:"Current pattern number",scPatternLen:"Current pattern length",txPatternUsed:"How many times is the pattern used",txPatternTotal:"Total number of patterns",btPosCreate:"Create an empty position\nat the end of song",btPosInsert:"Create a copy of current position\nand insert before it",btPosDelete:"Delete the current position",btPosMoveUp:"Move the current position\nbefore the previous",btPosMoveDown:"Move the current position\nafter the next one",scPosCurrent:"Actual position to play or edit [- Ctrl+Shift+Left|Right +]",scPosLength:"Current position length",scPosSpeed:"Initial speed of current position",scPosRepeat:"Position number to repeat from",txPosTotal:"Total number of positions",scChnButton:"Mute/Unmute channels [Ctrl+Num1...Ctrl+Num6]",scChnPattern:"Assigned pattern for specific\nchannel in current position",scChnTrans:"Transposition of notes\nin specific channel-pattern",scSampleNumber:"Current sample ID",txSampleName:"Current sample description",scSampleTone:"Base tone and octave\nto test this sample",btSamplePlay:"Play current sample",btSampleStop:"Stop playback [Esc]",btSampleClear:"Clear sample or\npart of sample data",btSampleSwap:"Swap volume data between channels",btSampleLVolUp:"Volume up left channel",btSampleLVolDown:"Volume down left channel",btSampleCopyLR:"Copy volume data from left to right channel",btSampleCopyRL:"Copy volume data from right to left channel",btSampleRVolUp:"Volume up right channel",btSampleRVolDown:"Volume down right channel",btSampleRotL:"Shift whole sample data\nto the left side",btSampleRotR:"Shift whole sample data\nto the right side",btSampleEnable:"Enable frequency generator\nin full active sample length",btSampleDisable:"Disable frequency generator\nin full sample length",chSampleRelease:"Sample can continue in playing\nafter the loop section when\nthe note was released in tracklist",scSampleLength:"Length of current sample",scSampleRepeat:"Number of ticks at the end\nof sample which will be repeated"},statusbar:["NOTE - use alphanumeric keys as two-octave piano, for RELEASE note use [A], [1] or [-] key","SAMPLE - [0] no change, [1 - V] to change current sample","ORNAMENT - [0] no change, [1 - F] for ornament, or [X] for release ornament","VOLUME CHANGE - [0] no change, [1 - F] for volume change in left channel","VOLUME CHANGE - [0] no change, [1 - F] for volume change in right channel","COMMAND - [0] no change, [1 - F] to use effect or command","COMMAND: 1XY - portamento up","COMMAND: 2XY - portamento down","COMMAND: 3XY - glissando to given note","COMMAND: 4XY - vibrato on current note","COMMAND: 5XY - tremolo on current note","COMMAND: 6XX - delay ornament","COMMAND: 7XX - ornament offset","COMMAND: 8XX - delay sample","COMMAND: 9XX - sample offset","COMMAND: AXY - volume slide","COMMAND: BXX - break current channel-pattern and loop from line","COMMAND: CXY - special command","COMMAND: DXX - delay listing on current line","COMMAND: EXY - soundchip envelope or noise channel control","COMMAND: FXX - change global speed","COMMAND 1st parameter: period of change (in ticks)","COMMAND 2nd parameter: pitch change in period (in cents)","COMMAND parameter: delay (in ticks)","COMMAND parameter: offset (in ticks)","COMMAND 2nd parameter: volume change in period [- 9-F | 1-7 +]","COMMAND parameter: trackline of current channel-pattern","COMMAND parameter: [00] disable last command, [XY] false-chord, [F1] swap stereo channels","COMMAND 1st parameter: [0, 1] enable envelope control, [D] disable, [2] enable noise control","COMMAND 2nd parameter: [0-F] for envelope shape, [0-4] for noise control","COMMAND parameter: speed of track listing (01-1F constant, otherwise XY for swing mode)","COMMAND parameter: none"],lastStatus:void 0,setStatusText:function(a){var b=this.statusbar[a];b&&a===this.lastStatus||($("#statusbar>p").html(b?b.replace(/(\[.+?\])/g,"<strong>$1</strong>").replace(/^([\w ]+?)(\:| \-)/,"<kbd>$1</kbd>$2").replace(/(\(.+?\))$/,"<em>$1</em>"):""),this.lastStatus=a)},showTracklistStatus:function(a,b){var c=a;if(5===a)c=b+5;else if(a>5)switch(b){case 1:case 2:case 3:case 4:case 5:c=a+15;break;case 6:case 8:case 13:c=23;break;case 7:case 9:c=24;break;case 10:c=6==a?21:25;break;case 11:c=26;break;case 12:c=27;break;case 14:c=a+22;break;case 15:c=30;break;default:c=31}this.setStatusText(c)}},Tracker.prototype.populateGUI=function(){for(var a=this,b=[{global:"document",method:"bind",param:"contextmenu",handler:function(a){return a.preventDefault(),!1}},{global:"window",method:"resize",handler:function(){var b=a.tracklist.countTracklines();if(b!==a.settings.tracklistLineHeight){a.tracklist.setHeight(b),a.updateTracklist(!0);var c=$("#statusbar").offset();$("#documodal .modal-body").css("height",.8*c.top)}}},{global:"window",method:"bind",param:"keyup keydown",handler:function(b){return a.handleKeyEvent(b.originalEvent)}},{global:"window",method:"bind",param:"blur",handler:function(b){var c,d=a.globalKeyState;for(c in d)c-0&&(delete d[c],d.length--)}},{selector:"[data-tooltip]",method:"each",handler:function(b,c){var d=(c.dataset||$(this).data()).tooltip||"",e=d.length?d:c.id||c.htmlFor||c.name,f=/^mi/.test(e)?500:1e3,g=a.doc.tooltip[e];g&&$(this).tooltip({html:!0,animation:!1,delay:{show:f,hide:0},placement:"auto top",trigger:"hover",title:g.replace(/\.{3}/g,"&hellip;").replace(/\n/g,"<br>").replace(/(\[.+?\])$/,"<kbd>$1</kbd>")})}},{selector:"canvas",method:"each",handler:function(b,c){var d=c.className,e=a[d];"tracklist"===d?(e.obj=c,e.ctx=c.getContext("2d")):"smpornedit"===d&&(d=c.id.replace("smpedit_",""),e[d].obj=c,e[d].ctx=c.getContext("2d")),$(this).bind("mousedown mouseup mousemove dblclick mousewheel DOMMouseScroll",function(b){var c=b.originalEvent.wheelDelta||-b.originalEvent.deltaY||"DOMMouseScroll"===b.originalEvent.type&&-b.originalEvent.detail;c&&(b.stopPropagation(),b.preventDefault(),b.delta=c,b.type="mousewheel"),a.handleMouseEvent(d,e,b)})}},{selector:"img.pixelfont",method:"load",handler:function(b){a.initPixelFont(b.target)}},{selector:"img.smpedit",method:"load",handler:function(b){a.smpornedit.img=b.target}},{selector:'#main-tabpanel a[data-toggle="tab"]',method:"on",param:"shown.bs.tab",handler:function(b){a.activeTab=parseInt($(this).data().value,10)}},{selector:"#scOctave",method:"TouchSpin",data:{initval:"2",min:1,max:8}},{selector:"#scOctave",method:"change",handler:function(){a.ctrlOctave=$(this).val()-0}},{selector:"#scAutoSmp",method:"TouchSpin",data:{initval:"0",radix:32,min:0,max:31}},{selector:"#scAutoSmp",method:"change",handler:function(){a.ctrlSample=parseInt($(this).val(),32)}},{selector:"#scAutoOrn",method:"TouchSpin",data:{initval:"0",radix:16,min:0,max:15}},{selector:"#scAutoOrn",method:"change",handler:function(){a.ctrlOrnament=parseInt($(this).val(),16)}},{selector:"#scRowStep",method:"TouchSpin",data:{initval:"0",min:0,max:8}},{selector:"#scRowStep",method:"change",handler:function(){a.ctrlRowStep=$(this).val()-0}},{selector:'#scPattern,#scPosCurrent,#scPosRepeat,input[id^="scChnPattern"]',method:"TouchSpin",data:{initval:"0",min:0,max:0}},{selector:"#scPatternLen,#scPosLength",method:"TouchSpin",data:{initval:"64",min:1,max:96}},{selector:"#scPattern",method:"change",handler:function(){return a.player.pattern.length<=1?!1:(a.workingPattern=$(this).val()-0,void a.updatePanelPattern())}},{selector:"#scPatternLen",method:"change",handler:function(){var b=a.player.pattern[a.workingPattern];return a.player.pattern.length<=1?!1:a.modePlay?($(this).val(b.end),!1):(b.end=$(this).val()-0,a.player.countPositionFrames(),a.updatePanelPattern(),a.updateTracklist(),void a.updatePanelInfo())}},{selector:"#scPosCurrent",method:"change",handler:function(){return a.player.position.length?a.modePlay?($(this).val(a.player.currentPosition+1),!1):(a.player.currentPosition=$(this).val()-1,a.player.currentLine=0,a.updatePanelInfo(),a.updatePanelPosition(),void a.updateTracklist()):!1}},{selector:"#scPosLength",method:"change",handler:function(){var b=a.player.currentPosition,c=a.player.position[b];return a.player.position.length?a.modePlay?($(this).val(c.length),!1):(c.length=$(this).val()-0,a.player.currentLine>=c.length&&(a.player.currentLine=c.length-1),a.player.countPositionFrames(b),a.updateTracklist(),void a.updatePanelInfo()):!1}},{selector:"#scPosSpeed",method:"TouchSpin",data:{initval:"6",min:1,max:31}},{selector:"#scPosSpeed",method:"change",handler:function(){var b=a.player.currentPosition,c=a.player.position[b];return a.player.position.length?a.modePlay?($(this).val(c.speed),!1):(c.speed=$(this).val()-0,a.player.countPositionFrames(b),a.updateTracklist(),void a.updatePanelInfo()):!1}},{selector:"#scPosRepeat",method:"change",handler:function(){return a.player.position.length?a.modePlay?($(this).val(a.player.repeatPosition+1),!1):void(a.player.repeatPosition=$(this).val()-1):!1}},{selector:'input[id^="scChnPattern"]',method:"change",handler:function(b){var c=b.target,d=a.player.currentPosition,e=c.id.substr(-1)-1,f=a.player.position[d],g=c.value-0,h=f.ch[e].pattern;return a.player.position.length?a.modePlay?(c.value=h,!1):(f.ch[e].pattern=g,(a.workingPattern===g||a.workingPattern===h)&&a.updatePanelPattern(),a.player.countPositionFrames(d),a.updateTracklist(),void a.updatePanelInfo()):!1}},{selector:'input[id^="scChnTrans"]',method:"each",handler:function(b,c){$(this).TouchSpin({initval:"0",min:-24,max:24}).change(function(b){var c=b.target,d=c.id.substr(-1)-1,e=a.player.position[a.player.currentPosition];return a.player.position.length?a.modePlay?(c.value=e.ch[d].pitch,!1):void(e.ch[d].pitch=c.value-0):!1})}},{selector:'input[id^="scChnButton"]',method:"each",handler:function(b,c){var d=c.id.substr(-1);$(this).bootstrapToggle({on:d,off:d,onstyle:"default",offstyle:"default",size:"mini",width:58}).change(function(b){var c=b.target;a.player.SAA1099.mute(c.value-1,!c.checked)})}},{selector:"#scSampleNumber,#scOrnamentTestSample",method:"TouchSpin",data:{initval:"1",radix:32,min:1,max:31}},{selector:"#scSampleNumber",method:"change",handler:function(){a.workingSample=parseInt($(this).val(),32),a.updateSampleEditor(!0),a.smpornedit.updateSamplePitchShift(),$("#sbSampleScroll").scrollLeft(0),$("#scOrnamentTestSample").val(a.workingOrnTestSample=a.workingSample)}},{selector:"#scOrnamentTestSample",method:"change",handler:function(){a.workingOrnTestSample=parseInt($(this).val(),32)}},{selector:"#scOrnamentNumber",method:"TouchSpin",data:{initval:"1",radix:16,min:1,max:15}},{selector:"#scOrnamentNumber",method:"change",handler:function(){a.workingOrnament=parseInt($(this).val(),16),a.smpornedit.updateOrnamentEditor(!0)}},{selector:"#txSampleName",method:"change",handler:function(b){a.player.sample[a.workingSample].name=b.target.value}},{selector:"#txOrnamentName",method:"change",handler:function(b){a.player.ornament[a.workingOrnament].name=b.target.value}},{selector:"#scSampleTone,#scOrnamentTone",method:"each",handler:function(b,c){var d="tx"+c.id.substr(2);$(this).TouchSpin({initval:a.workingSampleTone,min:1,max:96}).change(function(b){var c=b.target,d=c.value-0;a.workingSampleTone=d,$("#scSampleTone,#scOrnamentTone").val(d.toString()).prev().val(a.player.tones[d].txt)}).wrapAll('<div id="'+d+'"/>').removeAttr("style").prop("readonly",!0).clone(!1).removeAttr("id").insertBefore(this),$(this).trigger("change")}},{selector:"#sbSampleScroll",method:"scroll",handler:function(b){a.smpornedit.smpeditScroll=0|b.target.scrollLeft/1e3*64,a.updateSampleEditor()}},{selector:"#scSampleLength,#scSampleRepeat,#scOrnamentLength,#scOrnamentRepeat",method:"TouchSpin",data:{initval:"0",min:0,max:255}},{selector:"#chSampleRelease",method:"change",handler:function(b){var c=a.player.sample[a.workingSample];c.end!==c.loop&&(c.releasable=b.target.checked),a.updateSampleEditor(!0)}},{selector:"#scSampleLength",method:"change",handler:function(b){var c=a.player.sample[a.workingSample],d=parseInt(b.target.value,10)-c.end,e=c.loop+=d;c.end+=d,c.loop=c.end-e<0?0:e,a.updateSampleEditor(!0)}},{selector:"#scSampleRepeat",method:"change",handler:function(b){var c=a.player.sample[a.workingSample],d=parseInt(b.target.value,10);c.loop=c.end-d,a.updateSampleEditor(!0)}},{selector:"#scOrnamentLength",method:"change",handler:function(b){var c=a.player.ornament[a.workingOrnament],d=parseInt(b.target.value,10)-c.end,e=c.loop+=d;c.end+=d,c.loop=c.end-e<0?0:e,a.smpornedit.updateOrnamentEditor()}},{selector:"#scOrnamentRepeat",method:"change",handler:function(b){var c=a.player.ornament[a.workingOrnament],d=parseInt(b.target.value,10);c.loop=c.end-d,a.smpornedit.updateOrnamentEditor()}},{selector:'#sample-tabpanel a[data-toggle="tab"]',method:"on",param:"show.bs.tab",handler:function(b){"tab-pitchshift"===b.target.id&&"tab-sampledata"===b.relatedTarget.id&&a.smpornedit.updateSamplePitchShift()}},{selector:'a[id^="miFileImportDemo"]',method:"click",handler:function(){var b=$(this).data().filename;return!b||a.modePlay||a.globalKeyState.lastPlayMode?!1:void a.loadDemosong(b)}},{selector:'a[id^="miHelp"]',method:"click",handler:function(){var b=$(this),c=b.data().filename,d=b.text();return c?void a.onCmdShowDocumentation(c,d.slice(0,-1)):!1}},{selector:"#miAbout",method:"click",handler:function(){a.onCmdAbout()}},{selector:"#miStop",method:"click",handler:function(){a.onCmdStop()}},{selector:"#miSongPlay",method:"click",handler:function(){a.onCmdSongPlay()}},{selector:"#miSongPlayStart",method:"click",handler:function(){a.onCmdSongPlayStart()}},{selector:"#miPosPlay",method:"click",handler:function(){a.onCmdPosPlay()}},{selector:"#miPosPlayStart",method:"click",handler:function(){a.onCmdPosPlayStart()}},{selector:"#miToggleLoop",method:"click",handler:function(){a.onCmdToggleLoop()}},{selector:'button[id^="btPattern"]',method:"click",handler:function(){a[this.id.replace("btPattern","onCmdPat")]()}},{selector:"button[id^=btPos]",method:"click",handler:function(){a[this.id.replace("bt","onCmd")]()}},{selector:'button[id^="btSample"]',method:"click",handler:function(){var b=this.id.replace("btSample","onCmdSmp");b.endsWith("Stop")&&(b=b.replace("Smp","")),a[b]()}}],c=0,d=b.length;d>c;c++){var e=b[c],f=e.handler||e.data,g=e.selector||e.global&&window[e.global];g&&e.method&&(e.param?$(g)[e.method](e.param,f):$(g)[e.method](f))}};