/*!
 * Tracker: Core of SAA1099Tracker.
 * Copyright (c) 2013-2015 Martin Borik <mborik@users.sourceforge.net>
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom
 * the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS
 * OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF
 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
$(document).ready(function(){window.Tracker=new Tracker});var TracklistPosition=function(){function a(){this.y=0,this.line=0,this.channel=0,this.column=0,this.start={x:0,y:0},this.compare=function(a){return this.y===a.y&&this.line===a.line&&this.channel===a.channel&&this.column===a.column}}return a}(),Tracklist=function(){function a(a){this.obj=null,this.ctx=null,this.zoom=2,this.canvasData={columns:[0,24,30,36,42,54,60,66],selWidth:78,chnWidth:84,lineWidth:516,center:0,trkOffset:0,vpad:0},this.offsets={x:[new Array(9),new Array(9),new Array(9),new Array(9),new Array(9),new Array(9)],y:[]},this.countTracklines=function(){var b=$("#statusbar").offset(),c=$("#tracklist").offset(),d=a.settings.tracklistLineHeight;return Math.max(((b.top-c.top)/d/this.zoom|1)-2,5)},this.setHeight=function(b){void 0===b&&(b=a.settings.tracklistAutosize?this.countTracklines():a.settings.tracklistLines),a.settings.tracklistLines=b,b*=a.settings.tracklistLineHeight,$(this.obj).prop("height",b).css({height:b*this.zoom})},this.moveCurrentline=function(b){if(a.player.position.length&&!a.modePlay){var c=a.player.currentLine+b,d=a.player.currentPosition,e=a.player.position[d];0>c?c+=e.length:c>=e.length&&(c-=e.length),a.player.currentLine=c}}}return a}(),Tracker=function(){function a(){this.modePlay=!1,this.modeEdit=!1,this.modeEditChannel=0,this.modeEditColumn=0,this.workingPattern=0,this.workingSample=1,this.workingSampleTone=36,this.workingOrnament=1,this.ctrlOctave=2,this.ctrlSample=0,this.ctrlOrnament=0,this.ctrlRowStep=0,this.songTitle="",this.songAuthor="",this.globalKeyState={modsHandled:!1,lastPlayMode:0,length:0},this.selectionPoint=new TracklistPosition,this.selectionStarted=!1,this.selectionChannel=0,this.selectionLine=0,this.selectionLen=0,this.settings={tracklistAutosize:!0,tracklistLines:17,tracklistLineHeight:9,hexTracklines:!0,hexSampleFreq:!1,audioInterrupt:50,audioBuffers:0},this.tracklist=new Tracklist(this),this.pixelfont={obj:null,ctx:null},this.smpedit={obj:null,ctx:null},this.ornedit={obj:null,ctx:null},this.player=new Player(new SAASound(AudioDriver.sampleRate)),AudioDriver.setAudioSource(this.player),AudioDriver.play(),this.populateGUI(),this.updatePanels();var a=this;SyncTimer.start(function(){a.modePlay&&a.player.changedLine&&(a.player.changedPosition&&a.updatePanelPosition(),a.updatePanelInfo(),a.updateTracklist(),a.player.changedPosition=!1,a.player.changedLine=!1)},20)}return a.prototype.loadDemosong=function(a){var b=this,c=this.player,d=this.settings;$.getJSON("demosongs/"+a+".json",function(a){c.clearOrnaments(),c.clearSamples(),c.clearSong(),b.songTitle=a.title,b.songAuthor=a.author;var e,f,g,h,i,j,k,l,m,n;for(h=0;32>h;h++)if(e=a.samples[h])for(n=c.sample[h],n.name=e.name,n.loop=e.loop,n.end=e.end,n.releasable=!!e.rel,i=0,j=0,g=atob(e.data);i<g.length;i+=3,j++)f=255&g.charCodeAt(i+1),n.data[j].volume.byte=255&g.charCodeAt(i),n.data[j].enable_freq=!!(128&f),n.data[j].enable_noise=!!(64&f),n.data[j].noise_value=(48&f)>>4,n.data[j].shift=7&f|255&g.charCodeAt(i+2),8&f&&(n.data[j].shift*=-1);for(h=0;16>h;h++)if(e=a.ornaments[h])for(k=c.ornament[h],k.name=e.name,k.loop=e.loop,k.end=e.end,i=0,g=atob(e.data);i<g.length;i++)k.data[i]=g.charCodeAt(i);for(h=0;h<a.patterns.length;h++)if(g=a.patterns[h])for(g=atob(g),l=c.pattern[c.addNewPattern()],l.end=255&g.charCodeAt(0),i=1,j=0;i<g.length;i+=5,j++)l.data[j].tone=127&g.charCodeAt(i),l.data[j].release=!!(128&g.charCodeAt(i)),l.data[j].smp=31&g.charCodeAt(i+1),l.data[j].orn_release=!!(128&g.charCodeAt(i+1)),l.data[j].volume.byte=255&g.charCodeAt(i+2),l.data[j].orn=15&g.charCodeAt(i+3),l.data[j].cmd=(240&g.charCodeAt(i+3))>>4,l.data[j].cmd_data=255&g.charCodeAt(i+4);for(h=0;h<a.positions.length;h++)for(e=a.positions[h],g=atob(e.ch),m=c.position[h]=new pPosition(e.length,e.speed),i=0,j=0;6>i;i++)m.ch[i].pattern=255&g.charCodeAt(j++),m.ch[i].pitch=g.charCodeAt(j++);c.setInterrupt(d.audioInterrupt=a.config.audioInterrupt),c.currentPosition=a.config.currentPosition,c.repeatPosition=a.config.repeatPosition,c.currentLine=a.config.currentLine,b.modeEditChannel=a.config.editChannel,b.ctrlOctave=a.config.ctrlOctave,b.ctrlSample=a.config.ctrlSample,b.ctrlOrnament=a.config.ctrlOrnament,b.ctrlRowStep=a.config.ctrlRowStep,b.updatePanels(),b.updateTracklist()})},a}();Tracker.prototype.updatePanels=function(){$("#scOctave").val(this.ctrlOctave),$("#scAutoSmp").val(this.ctrlSample),$("#scAutoOrn").val(this.ctrlOrnament),$("#scRowStep").val(this.ctrlRowStep),$("#txHeaderTitle").val(this.songTitle),$("#txHeaderAuthor").val(this.songAuthor),this.updatePanelInfo(),this.updatePanelPattern(),this.updatePanelPosition()},Tracker.prototype.updatePanelInfo=function(){var a,b,c=this.settings.audioInterrupt,d=null,e=null,f=0,g=0,h=this.player.currentPosition,i=this.player.position.length,j=this.player.currentLine,k=-2&j,l=60*c;if(i){for(d=this.player.position[h],b=l/(d.frames[k+2]-d.frames[k])>>1,l=0;i>l;l++)e=this.player.position[l],l===h&&(g=f),f+=e.frames[e.length];g+=d.frames[j],l=f.toString().length,a="("+g.toWidth(l)+"/"+f.toWidth(l)+")",$("#stInfoPanelFrames").text(a),g/=c,f/=c,a=(g/60).toWidth(2)+":"+(g%60).toWidth(2)+" / "+(f/60).toWidth(2)+":"+(f%60).toWidth(2),$("#stInfoPanelTime").text(a)}else $("#stInfoPanelTime").text("00:00 / 00:00"),$("#stInfoPanelFrames").text("(0/0)"),b=l/this.player.currentSpeed>>2;$("#stInfoPanelBPM").text("BPM: "+b+" ("+c+" Hz)")},Tracker.prototype.updatePanelPattern=function(){var a,b=["#scPattern","#scPatternLen","#btPatternDelete","#btPatternClean","#btPatternInfo"],c=$(b[0]).prop("disabled"),d=this.workingPattern,e=this.player.pattern.length,f=0,g=0,h=!0;for(e--,e?(f=1,g=e,d=Math.max(Math.min(d,g),f)):d=0,a=1;6>=a;a++)$("#scChnPattern"+a).trigger("touchspin.updatesettings",{min:0,max:g});if(d?(h=!1,$(b[1]).val(this.player.pattern[d].end)):$(b[1]).val(64),this.workingPattern=d,$(b[0]).trigger("touchspin.updatesettings",{min:f,max:g,initval:d}).val(d),$("#txPatternUsed").val(this.player.countPatternUsage(d)),$("#txPatternTotal").val(e),h!==c)for(a=0,e=b.length;e>a;a++)$(b[a]+","+b[a]+"~span>button").prop("disabled",h)},Tracker.prototype.updatePanelPosition=function(){var a,b,c=["#scPosCurrent","#scPosLength","#scPosSpeed","#txPosTotal","#scPosRepeat"],d=$(c[0]).prop("disabled"),e=this.player.nullPosition,f=this.player.position.length,g=this.player.currentPosition,h=!0;for(f?(h=!1,$(c[0]+","+c[4]).trigger("touchspin.updatesettings",{min:1,max:f}),$(c[0]).val(g+1),$(c[3]).val(f),$(c[4]).val(this.player.repeatPosition+1),e=this.player.position[g]):($(c[0]+","+c[4]).val(0).trigger("touchspin.updatesettings",{min:0,max:0}),$(c[3]).val(0)),$(c[1]).val(e.length),$(c[2]).val(e.speed),b=0;6>b;b++)c.push(a="#scChnPattern"+(b+1)),$(a).val(e.ch[b].pattern),c.push(a="#scChnTrans"+(b+1)),$(a).val(e.ch[b].pitch);if(h!==d)for(c.splice(3,1),b=0,f=c.length;f>b;b++)$(c[b]+","+c[b]+"~span>button").prop("disabled",h);e=null},Tracker.prototype.onCmdStop=function(){this.player.stopChannel(),this.modePlay=!1,this.globalKeyState.lastPlayMode=0},Tracker.prototype.onCmdSongPlay=function(){2!==this.globalKeyState.lastPlayMode&&(this.modePlay=this.player.playPosition(!1,!0,!0))},Tracker.prototype.onCmdSongPlayStart=function(){this.modePlay=this.player.playPosition(!0,!0,!0)},Tracker.prototype.onCmdPosPlay=function(){1!==this.globalKeyState.lastPlayMode&&(this.modePlay=this.player.playPosition(!1,!1,!1))},Tracker.prototype.onCmdPosPlayStart=function(){this.modePlay=this.player.playPosition(!1,!1,!0)},Tracker.prototype.onCmdToggleLoop=function(){var a=this.player.loopMode=!this.player.loopMode,b=$("a#miToggleLoop>span"),c="glyphicon-repeat",d="glyphicon-remove-circle",e=a?c:d,f=a?"#000":"#ccc";b.removeClass(c+" "+d),b.addClass(e).css({color:f})},Tracker.prototype.handleKeyEvent=function(a){var b=this.globalKeyState,c=a.target&&"text"===a.target.type,d=a.which||a.charCode||a.keyCode,e=!!this.player.position.length;if(browser.isOpera&&219===d)d=91;else if(browser.isFirefox)switch(d){case 59:d=186;break;case 61:d=187;break;case 173:d=189}if("keydown"===a.type){if(d>=16&&18>=d&&(b.modsHandled=!1,2===a.location&&(d+=256)),b[d]||(b[d]=!0,b.length++),c)return!0;b[13]&&1===b.length&&e&&!this.modePlay&&!b.lastPlayMode?(this.modePlay=this.player.playPosition(!1,!1,!1),b.lastPlayMode=3):b[13]&&b.length>1&&this.modePlay&&3===b.lastPlayMode&&(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0)}else if("keyup"===a.type&&(c&&(b.modsHandled=!0),!b.modsHandled&&e&&(1===b.length&&b[272]?(this.modePlay&&1===b.lastPlayMode?(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0):(this.modePlay=this.player.playPosition(!1,!1,!0),b.lastPlayMode=1),b.modsHandled=!0):1===b.length&&b[273]&&(this.modePlay&&2===b.lastPlayMode?(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0):(this.modePlay=this.player.playPosition(!1,!0,!0),b.lastPlayMode=2),b.modsHandled=!0)),b[13]&&this.modePlay&&3===b.lastPlayMode&&(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0),b[d]&&(delete b[d],b.length&&b.length--),b[d+256]&&(delete b[d+256],b.length&&b.length--),c))return!0;return a.preventDefault(),!1},Tracker.prototype.initPixelFont=function(a){var b,c,d,e=["#fff","#f00","#38c","#000","#800"],f=this.pixelfont,g=10*e.length,h=a.width;for(f.obj=document.createElement("canvas"),f.obj.width=h,f.obj.height=g,f.ctx=f.obj.getContext("2d"),b=0;g>b;b+=10)f.ctx.fillStyle=e[b/10],f.ctx.fillRect(0,b,h,10);for(c=document.createElement("canvas"),c.width=h,c.height=5,d=c.getContext("2d"),d.save(),d.clearRect(0,0,h,5),d.drawImage(a,0,0),d.fillStyle="#fff",d.globalCompositeOperation="source-in",d.fillRect(0,0,h,5),d.restore(),b=0;g>b;b+=10)f.ctx.drawImage(c,0,b);for(d.save(),d.clearRect(0,0,h,5),d.drawImage(a,0,0),d.fillStyle="#aaa",d.globalCompositeOperation="source-in",d.fillRect(0,0,h,5),d.restore(),b=5;g>b;b+=10)f.ctx.drawImage(c,0,b);f.ctx.drawImage(a,0,0),d=null,c=null},Tracker.prototype.updateTracklist=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n=this.tracklist.canvasData,o=this.tracklist.offsets,p=this.player,q=this.settings.hexTracklines?16:10,r=this.pixelfont.obj,s=this.tracklist.ctx,t=p.currentPosition,u=p.position[t]||p.nullPosition,v=this.tracklist.obj.width,w=this.settings.tracklistLineHeight,x=this.settings.tracklistLines,y=x>>1,z=p.currentLine-y,A=function(a){return 6*(d.charCodeAt(a||0)-32)};for(a&&(n.center=v-n.lineWidth>>1,n.vpad=Math.round((w-5)/2),n.trkOffset=n.center+24,o.y=[]),h=0,m=0,l=n.vpad;x>h;h++,z++,l+=w,m+=w)if(a&&(o.y[h]=m),h!==y?f=0:this.modeEdit?(f=10,s.fillStyle="#f00",s.fillRect(0,m,v,w)):(f=20,a&&(s.fillStyle="#38c",s.fillRect(0,m,v,w))),z>=0&&z<u.length)for(d=("0"+z.toString(q)).substr(-2),s.drawImage(r,A(0),f,5,5,n.center,l,5,5),s.drawImage(r,A(1),f,5,5,n.center+6,l,5,5),g=0;6>g;g++)for(b=p.pattern[u.ch[g].pattern],c=b.data[z],i=0;8>i;i++)if(k=n.trkOffset+g*n.chnWidth+n.columns[i],a&&(o.x[g][i]=k,!i&&g&&(o.x[g-1][8]=k)),e=f,!i&&(h!==y||!this.modeEdit)&&this.selectionLen&&this.selectionChannel===g&&z>=this.selectionLine&&z<=this.selectionLine+this.selectionLen?(s.fillStyle="#000",s.fillRect(k-3,m,n.selWidth,w),e=30):h===y&&this.modeEdit&&this.modeEditChannel===g&&this.modeEditColumn===i&&(s.fillStyle="#800",i?s.fillRect(k-1,m,7,w):s.fillRect(k-2,m,22,w),e=40),z>=b.end&&(e+=5),i){switch(j=-1,i){case 1:c.smp&&(j=c.smp);break;case 2:c.orn_release?j=33:c.orn&&(j=c.orn);break;case 3:c.volume.byte&&(j=c.volume.L);break;case 4:c.volume.byte&&(j=c.volume.R);break;case 5:(c.cmd||c.cmd_data)&&(j=c.cmd);break;case 6:(c.cmd||c.cmd_data)&&(j=(240&c.cmd_data)>>4);break;case 7:(c.cmd||c.cmd_data)&&(j=15&c.cmd_data)}d=0>j?"":j.toString(36),s.drawImage(r,A(),e,5,5,k,l,5,5)}else d="---",c.release?d="R--":c.tone&&(d=p.tones[c.tone].txt),s.drawImage(r,A(0),e,5,5,k,l,5,5),s.drawImage(r,A(1),e,5,5,k+6,l,5,5),s.drawImage(r,A(2),e,5,5,k+12,l,5,5);else s.fillStyle="#fff",s.fillRect(n.center,l,n.lineWidth,5);a&&(o.x[5][8]=v,o.x[0][0]=0,o.y[h]=m)},Tracker.prototype.populateGUI=function(){for(var app=this,populatedElementsTable=[{global:"document",method:"bind",param:"contextmenu",handler:function(a){return a.preventDefault(),!1}},{global:"window",method:"resize",handler:function(){var a=app.tracklist.countTracklines();a!==app.settings.tracklistLineHeight&&(app.tracklist.setHeight(a),app.updateTracklist(!0))}},{global:"window",method:"bind",param:"keyup keydown",handler:function(a){return app.handleKeyEvent(a.originalEvent)}},{selector:'[data-toggle="tooltip"]',method:"tooltip",data:{animation:!1,container:".tooltip-target",viewport:{selector:".tooltip-target",padding:0},template:'<div class="tooltip tooltip-custom" role="tooltip"><div class="tooltip-inner"></div></div>'}},{selector:"img.pixelfont",method:"load",handler:function(a){app.initPixelFont(a.target),app.updateTracklist(!0)}},{selector:"canvas",method:"each",handler:function(a,b){var c=b.id,d=app[c];void 0!==d&&(d.obj=b,d.ctx=b.getContext("2d"),"tracklist"===c&&d.setHeight())}},{selector:"#tracklist",method:"on",param:"mousewheel DOMMouseScroll",handler:function(a){if(app.player.position.length&&!app.modePlay){var b=a.originalEvent.wheelDelta||-a.originalEvent.deltaY||-a.originalEvent.detail;a.stopPropagation(),a.preventDefault(),a.target.focus(),0>b?app.tracklist.moveCurrentline(1):b>0&&app.tracklist.moveCurrentline(-1),app.updateTracklist(),app.updatePanelInfo()}}},{selector:"#scOctave",method:"TouchSpin",data:{initval:"2",min:1,max:8}},{selector:"#scAutoSmp",method:"TouchSpin",data:{initval:"0",radix:32,min:0,max:31}},{selector:"#scAutoOrn",method:"TouchSpin",data:{initval:"0",radix:16,min:0,max:15}},{selector:"#scRowStep",method:"TouchSpin",data:{initval:"0",min:0,max:8}},{selector:'#scPattern,#scPosCurrent,#scPosRepeat,input[id^="scChnPattern"]',method:"TouchSpin",data:{initval:"0",min:0,max:0}},{selector:"#scPatternLen,#scPosLength",method:"TouchSpin",data:{initval:"64",min:1,max:96}},{selector:"#scPosSpeed",method:"TouchSpin",data:{initval:"6",min:1,max:31}},{selector:'input[id^="scChnTrans"]',method:"TouchSpin",data:{initval:"0",min:-24,max:24}},{selector:'input[id^="scChnButton"]',method:"each",handler:function(a,b){var c=b.id.substr(-1);$(this).bootstrapToggle({on:c,off:c,onstyle:"default",offstyle:"default",size:"mini",width:58}).change(function(a){var b=a.target;app.player.SAA1099.mute(b.value-1,!b.checked)})}},{selector:"#scPosCurrent",method:"change",handler:function(){app.player.position.length&&(app.player.currentPosition=$(this).val()-1,app.updatePanelInfo(),app.updatePanelPosition(),app.updateTracklist())}},{selector:"#scPattern",method:"change",handler:function(){app.player.pattern.length<=1||(app.workingPattern=$(this).val()-0,app.updatePanelPattern())}},{selector:'a[id^="miFileImportDemo"]',method:"click",handler:function(){var a=$(this).data(),b=a.filename;return b?void app.loadDemosong(b):!1}},{selector:"#miStop",method:"click",handler:function(){app.onCmdStop()}},{selector:"#miSongPlay",method:"click",handler:function(){app.onCmdSongPlay()}},{selector:"#miSongPlayStart",method:"click",handler:function(){app.onCmdSongPlayStart()}},{selector:"#miPosPlay",method:"click",handler:function(){app.onCmdPosPlay()}},{selector:"#miPosPlayStart",method:"click",handler:function(){app.onCmdPosPlayStart()}},{selector:"#miToggleLoop",method:"click",handler:function(){app.onCmdToggleLoop()}}],i=0,l=populatedElementsTable.length;l>i;i++){var obj=populatedElementsTable[i],param=obj.handler||obj.data,selector=obj.selector?"'"+obj.selector+"'":obj.global;eval("$("+selector+")."+(obj.param?obj.method+"('"+obj.param+"', param)":obj.method+"(param)"))}};