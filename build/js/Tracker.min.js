/*!
 * Tracker: Core of SAA1099Tracker.
 * Copyright (c) 2013-2015 Martin Borik <mborik@users.sourceforge.net>
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom
 * the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS
 * OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF
 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
$(document).ready(function(){window.Tracker=new Tracker});var TracklistPosition=function(){function a(){this.y=0,this.line=0,this.channel=0,this.column=0,this.start={x:0,y:0},this.compare=function(a){return this.y===a.y&&this.line===a.line&&this.channel===a.channel&&this.column===a.column}}return a}(),Tracker=function(){function a(){this.isActive=!1,this.isInitialized=!1,this.modePlay=!1,this.modeEdit=!1,this.modeEditChannel=0,this.modeEditColumn=0,this.workingPattern=0,this.workingSample=1,this.workingSampleTone=36,this.workingOrnament=1,this.ctrlOctave=2,this.ctrlSample=0,this.ctrlOrnament=0,this.ctrlRowStep=0,this.songTitle="",this.songAuthor="",this.selectionPoint=new TracklistPosition,this.selectionStarted=!1,this.selectionChannel=0,this.selectionLine=0,this.selectionLen=0,this.settings={tracklistLines:15,tracklistLineHeight:8,hexTracklines:!0,hexSampleFreq:!1,audioInterrupt:50,audioBuffers:0},this.tracklist={obj:null,ctx:null},this.smpedit={obj:null,ctx:null},this.ornedit={obj:null,ctx:null},this.player=new Player(new SAASound(AudioDriver.sampleRate)),AudioDriver.setAudioSource(this.player),AudioDriver.play(),this.populateGUI(),this.updatePanels();var a=this;SyncTimer.start(function(){a.modePlay&&a.player.changedLine&&(a.player.changedPosition&&a.updatePanelPosition(),a.updatePanelInfo(),a.player.changedPosition=!1,a.player.changedLine=!1)},20)}return a.prototype.loadDemosong=function(a){var b=this,c=this.player,d=this.settings;$.getJSON("demosongs/"+a+".json",function(a){c.clearOrnaments(),c.clearSamples(),c.clearSong(),b.songTitle=a.title,b.songAuthor=a.author;var e,f,g,h,i,j,k,l,m,n;for(h=0;32>h;h++)if(e=a.samples[h])for(n=c.sample[h],n.name=e.name,n.loop=e.loop,n.end=e.end,n.releasable=!!e.rel,i=0,j=0,g=atob(e.data);i<g.length;i+=3,j++)f=255&g.charCodeAt(i+1),n.data[j].volume["byte"]=255&g.charCodeAt(i),n.data[j].enable_freq=!!(128&f),n.data[j].enable_noise=!!(64&f),n.data[j].noise_value=(48&f)>>4,n.data[j].shift=7&f|255&g.charCodeAt(i+2),8&f&&(n.data[j].shift*=-1);for(h=0;16>h;h++)if(e=a.ornaments[h])for(k=c.ornament[h],k.name=e.name,k.loop=e.loop,k.end=e.end,i=0,g=atob(e.data);i<g.length;i++)k.data[i]=g.charCodeAt(i);for(h=0;h<a.patterns.length;h++)if(g=a.patterns[h])for(g=atob(g),l=c.pattern[c.addNewPattern()],l.end=255&g.charCodeAt(0),i=1,j=0;i<g.length;i+=5,j++)l.data[j].tone=127&g.charCodeAt(i),l.data[j].release=!!(128&g.charCodeAt(i)),l.data[j].smp=31&g.charCodeAt(i+1),l.data[j].orn_release=!!(128&g.charCodeAt(i+1)),l.data[j].volume["byte"]=255&g.charCodeAt(i+2),l.data[j].orn=15&g.charCodeAt(i+3),l.data[j].cmd=(240&g.charCodeAt(i+3))>>4,l.data[j].cmd_data=255&g.charCodeAt(i+4);for(h=0;h<a.positions.length;h++)for(e=a.positions[h],g=atob(e.ch),m=c.position[h]=new pPosition(e.length,e.speed),i=0,j=0;6>i;i++)m.ch[i].pattern=255&g.charCodeAt(j++),m.ch[i].pitch=g.charCodeAt(j++);c.setInterrupt(d.audioInterrupt=a.config.audioInterrupt),c.currentPosition=a.config.currentPosition,c.repeatPosition=a.config.repeatPosition,c.currentLine=a.config.currentLine,b.modeEditChannel=a.config.editChannel,b.ctrlOctave=a.config.ctrlOctave,b.ctrlSample=a.config.ctrlSample,b.ctrlOrnament=a.config.ctrlOrnament,b.ctrlRowStep=a.config.ctrlRowStep,b.updatePanels()})},a}();Tracker.prototype.updatePanels=function(){$("#scOctave").val(this.ctrlOctave),$("#scAutoSmp").val(this.ctrlSample),$("#scAutoOrn").val(this.ctrlOrnament),$("#scRowStep").val(this.ctrlRowStep),$("#txHeaderTitle").val(this.songTitle),$("#txHeaderAuthor").val(this.songAuthor),this.updatePanelInfo(),this.updatePanelPattern(),this.updatePanelPosition()},Tracker.prototype.updatePanelInfo=function(){var a,b,c=this.settings.audioInterrupt,d=null,e=null,f=0,g=0,h=this.player.currentPosition,i=this.player.position.length,j=this.player.currentLine,k=-2&j,l=60*c;if(i){for(d=this.player.position[h],b=l/(d.frames[k+2]-d.frames[k])>>1,l=0;i>l;l++)e=this.player.position[l],l===h&&(g=f),f+=e.frames[e.length];g+=d.frames[j],l=f.toString().length,a="("+g.toWidth(l)+"/"+f.toWidth(l)+")",$("#stInfoPanelFrames").text(a),g/=c,f/=c,a=(g/60).toWidth(2)+":"+(g%60).toWidth(2)+" / "+(f/60).toWidth(2)+":"+(f%60).toWidth(2),$("#stInfoPanelTime").text(a)}else $("#stInfoPanelTime").text("00:00 / 00:00"),$("#stInfoPanelFrames").text("(0/0)"),b=l/this.player.currentSpeed>>2;$("#stInfoPanelBPM").text("BPM: "+b+" ("+c+" Hz)")},Tracker.prototype.updatePanelPattern=function(){var a,b=["#scPattern","#scPatternLen","#btPatternDelete","#btPatternClean","#btPatternInfo"],c=$(b[0]).prop("disabled"),d=this.workingPattern,e=this.player.pattern.length,f=!0;for(e?(e--,$(b[0]).trigger("touchspin.updatesettings",{min:1,max:e}),d>e&&(d=e)):($(b[0]).trigger("touchspin.updatesettings",{min:0,max:0}),d=0),a=1;6>=a;a++)$("#scChnPattern"+a).trigger("touchspin.updatesettings",{min:0,max:e});if(d?(f=!1,$(b[1]).val(this.player.pattern[d].end)):$(b[1]).val(64),$(b[0]).val(d),$("#txPatternUsed").val(this.player.countPatternUsage(d)),$("#txPatternTotal").val(e),this.workingPattern=d,f!==c)for(a=0,e=b.length;e>a;a++)$(b[a]+","+b[a]+"~span>button").prop("disabled",f)},Tracker.prototype.updatePanelPosition=function(){var a,b,c=["#scPosCurrent","#scPosLength","#scPosSpeed","#txPosTotal","#scPosRepeat"],d=$(c[0]).prop("disabled"),e=null,f=this.player.position.length,g=this.player.currentPosition,h=!0;for(f?(h=!1,$(c[0]+","+c[4]).trigger("touchspin.updatesettings",{min:1,max:f}),$(c[0]).val(g+1),$(c[3]).val(f),$(c[4]).val(this.player.repeatPosition+1),e=this.player.position[g]):($(c[0]+","+c[4]).val(0).trigger("touchspin.updatesettings",{min:0,max:0}),$(c[3]).val(0),e=new pPosition(64,6)),$(c[1]).val(e.length),$(c[2]).val(e.speed),b=0;6>b;b++)c.push(a="#scChnPattern"+(b+1)),$(a).val(e.ch[b].pattern),c.push(a="#scChnTrans"+(b+1)),$(a).val(e.ch[b].pitch);if(h!==d)for(c.splice(3,1),b=0,f=c.length;f>b;b++)$(c[b]+","+c[b]+"~span>button").prop("disabled",h);e=null},Tracker.prototype.populateGUI=function(){var i,app=this,populatedElementsTable=[{selector:"canvas",method:"each",handler:function(a,b){var c=b.id,d=app[c];void 0!==d&&(d.obj=b,d.ctx=b.getContext("2d"),"tracklist"===c&&(d.setHeight=function(a){void 0===a&&(a=app.settings.tracklistLines),a*=app.settings.tracklistLineHeight,$(this.obj).prop("height",a).css({height:2*a})},d.setHeight()))}},{selector:'[data-toggle="tooltip"]',method:"tooltip"},{selector:"#scOctave",method:"TouchSpin",data:{initval:"2",min:1,max:8}},{selector:"#scAutoSmp",method:"TouchSpin",data:{initval:"0",radix:32,min:0,max:31}},{selector:"#scAutoOrn",method:"TouchSpin",data:{initval:"0",radix:16,min:0,max:15}},{selector:"#scRowStep",method:"TouchSpin",data:{initval:"0",min:0,max:8}},{selector:'#scPattern,#scPosCurrent,#scPosRepeat,input[id^="scChnPattern"]',method:"TouchSpin",data:{initval:"0",min:0,max:0}},{selector:"#scPatternLen,#scPosLength",method:"TouchSpin",data:{initval:"64",min:1,max:96}},{selector:"#scPosSpeed",method:"TouchSpin",data:{initval:"6",min:1,max:31}},{selector:'input[id^="scChnTrans"]',method:"TouchSpin",data:{initval:"0",min:-24,max:24}},{selector:'input[id^="scChnButton"]',method:"each",handler:function(a,b){var c=b.id.substr(-1);$(this).bootstrapToggle({on:c,off:c,onstyle:"default",offstyle:"default",size:"mini",width:58}).change(function(a){var b=a.target;app.player.SAA1099.mute(b.value-1,!b.checked)})}},{selector:"#scPosCurrent",method:"change",handler:function(){app.player.position.length&&(app.player.currentPosition=$(this).val()-1,app.updatePanelInfo(),app.updatePanelPosition())}},{selector:"#scPattern",method:"change",handler:function(){app.player.pattern.length<=1||(app.workingPattern=$(this).val(),app.updatePanelPattern())}},{selector:'a[id^="miFileImportDemo"]',method:"click",handler:function(){app.loadDemosong($(this).data().filename)}},{selector:"#miStop",method:"click",handler:function(){app.player.stopChannel(),app.modePlay=!1}},{selector:"#miSongPlay",method:"click",handler:function(){app.modePlay=app.player.playPosition(!1,!0,!0)}},{selector:"#miSongPlayStart",method:"click",handler:function(){app.modePlay=app.player.playPosition(!0,!0,!0)}},{selector:"#miPosPlay",method:"click",handler:function(){app.modePlay=app.player.playPosition(!1,!1,!1)}},{selector:"#miPosPlayStart",method:"click",handler:function(){app.modePlay=app.player.playPosition(!1,!1,!0)}},{selector:"#miToggleLoop",method:"click",handler:function(){var a=app.player.loopMode=!app.player.loopMode,b=$(this).find("span"),c="glyphicon-repeat",d="glyphicon-remove-circle",e=a?c:d,f=a?"#000":"#ccc";b.removeClass(c+" "+d),b.addClass(e).css({color:f})}}];for(i in populatedElementsTable)if(populatedElementsTable.hasOwnProperty(i)){var obj=populatedElementsTable[i],param=obj.handler||obj.data;eval("$('"+obj.selector+"')."+(obj.param?obj.method+"('"+obj.param+"', param)":obj.method+"(param)"))}};