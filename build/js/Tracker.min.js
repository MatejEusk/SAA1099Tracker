/*!
 * Tracker: Core of SAA1099Tracker.
 * Copyright (c) 2013-2015 Martin Borik <mborik@users.sourceforge.net>
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom
 * the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS
 * OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF
 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
$(document).ready(function(){window.Tracker=new Tracker});var TracklistPosition=function(){function a(b,c,d,e,f,g){this.y=b||0,this.line=c||0,this.channel=d||0,this.column=e||0,this.start={x:f||0,y:g||0},this.set=function(b){if(!(b instanceof a))throw"invalid object type";this.y=b.y,this.line=b.line,this.channel=b.channel,this.column=b.column,this.start.x=b.start.x,this.start.y=b.start.y},this.compare=function(b){return b instanceof a?this.y===b.y&&this.line===b.line&&this.channel===b.channel&&this.column===b.column:void 0}}return a}(),Tracklist=function(){function a(a){this.obj=null,this.ctx=null,this.zoom=2,this.canvasData={columns:[0,24,30,36,42,54,60,66],selWidth:78,chnWidth:84,lineWidth:516,center:0,trkOffset:0,vpad:0},this.offsets={x:[new Array(9),new Array(9),new Array(9),new Array(9),new Array(9),new Array(9)],y:[]},this.countTracklines=function(){var b=$("#statusbar").offset(),c=$("#tracklist").offset(),d=a.settings.tracklistLineHeight;return Math.max(((b.top-c.top)/d/this.zoom|1)-2,5)},this.setHeight=function(b){var c=a.settings;void 0===b&&(b=c.tracklistAutosize?this.countTracklines():c.tracklistLines),c.tracklistLines=b,b*=c.tracklistLineHeight,$(this.obj).prop("height",b).css({height:b*this.zoom})},this.moveCurrentline=function(b,c){var d=a.player,e=d.currentLine+b,f=d.currentPosition,g=d.position[f];a.modePlay||void 0===g||(c?e=Math.min(Math.max(e,0),g.length-1):0>e?e+=g.length:e>=g.length&&(e-=g.length),d.currentLine=e)},this.pointToTracklist=function(b,c){var d,e,f,g=a.settings.tracklistLines,h=g>>1,i=a.player.currentLine-h;for(d=0;g>d;d++,i++)if(c>=this.offsets.y[d]&&c<=this.offsets.y[d+1])for(f=0;6>f;f++)if(b>=this.offsets.x[f][0]&&b<=this.offsets.x[f][8])for(e=0;8>e;e++)if(b>=this.offsets.x[f][e]&&b<=this.offsets.x[f][e+1])return new TracklistPosition(d,Math.max(i,0),f,e,b,c)}}return a}(),SmpOrnEditor=function(){function a(a){this.amp={obj:null,ctx:null},this.noise={obj:null,ctx:null},this.range={obj:null,ctx:null},this.smpeditOffset=0,this.columnWidth=0,this.halfing=0,this.centering=0,this.radix=10,this.drawHeaders=function(b){var c,d,e,f,g,h,i,j=["amp","noise","range"];for(c=0,d=j.length;d>c;c++)e=this[j[c]],f=e.ctx,g=e.obj.width,h=e.obj.height,i=h>>1,f.miterLimit=0,f.fillStyle="#fcfcfc",f.fillRect(0,0,22,h),f.fillStyle="#ccc",f.fillRect(22,0,1,h),0===c&&(this.halfing=i-=12,this.columnWidth=(g-26)/64|0,this.centering=26+(g-64*this.columnWidth)>>1,f.fillRect(22,i,g-22,1),f.fillRect(22,286,g-22,1),f.save(),f.font=$("label").first().css("font"),f.translate(12,i),f.rotate(-Math.PI/2),f.textBaseline="middle",f.fillStyle="#888",f.textAlign="right",f.fillText("RIGHT",-16,0),f.textAlign="left",f.fillText("LEFT",16,0),f.restore()),f.drawImage(b,16*c,0,16,16,4,i-8,16,16);this.createPitchShiftTable(),a.updateSampleEditor(!0)},this.createPitchShiftTable=function(){var b,c,d=$("#fxSampleShift").empty(),e=$('<div class="cell"/>'),f=$('<input type="text" class="form-control">');for(b=0;256>b;b++)c=f.clone(),e.clone().append(c).appendTo(d),c.TouchSpin({prefix:b.toWidth(3),radix:this.radix=a.settings.hexSampleFreq?16:10,initval:0,min:-2047,max:2047}).change({index:b},function(b){var c=a.settings.hexSampleFreq?16:10,d=a.player.sample[a.workingSample],e=d.data,f=b.target;e[b.data.index].shift=parseInt(f.value,c)})}}return a}(),Tracker=function(){function a(){this.activeTab=0,this.modePlay=!1,this.modeEdit=!1,this.modeEditChannel=0,this.modeEditColumn=0,this.workingPattern=0,this.workingSample=1,this.workingSampleTone=37,this.workingOrnament=1,this.ctrlOctave=2,this.ctrlSample=0,this.ctrlOrnament=0,this.ctrlRowStep=0,this.songTitle="",this.songAuthor="",this.globalKeyState={modsHandled:!1,lastPlayMode:0,length:0},this.selectionPoint=new TracklistPosition,this.selectionStarted=!1,this.selectionChannel=0,this.selectionLine=0,this.selectionLen=0,this.settings={tracklistAutosize:!0,tracklistLines:17,tracklistLineHeight:9,hexTracklines:!0,hexSampleFreq:!1,audioInterrupt:50,audioBuffers:0},this.pixelfont={obj:null,ctx:null},this.tracklist=new Tracklist(this),this.smpornedit=new SmpOrnEditor(this),this.player=new Player(new SAASound(AudioDriver.sampleRate)),AudioDriver.setAudioSource(this.player),AudioDriver.play(),this.populateGUI(),this.updatePanels();var a=this;SyncTimer.start(function(){a.modePlay&&a.player.changedLine&&(a.player.changedPosition&&a.updatePanelPosition(),a.updatePanelInfo(),a.updateTracklist(),a.player.changedPosition=!1,a.player.changedLine=!1)},20)}return a.prototype.loadDemosong=function(a){var b=this,c=this.player,d=this.settings;$.getJSON("demosongs/"+a+".json",function(a){c.clearOrnaments(),c.clearSamples(),c.clearSong(),b.songTitle=a.title,b.songAuthor=a.author;var e,f,g,h,i,j,k,l,m,n;for(h=0;32>h;h++)if(e=a.samples[h])for(n=c.sample[h],n.name=e.name,n.loop=e.loop,n.end=e.end,n.releasable=!!e.rel,i=0,j=0,g=atob(e.data);i<g.length;i+=3,j++)f=255&g.charCodeAt(i+1),n.data[j].volume.byte=255&g.charCodeAt(i),n.data[j].enable_freq=!!(128&f),n.data[j].enable_noise=!!(64&f),n.data[j].noise_value=(48&f)>>4,n.data[j].shift=7&f|255&g.charCodeAt(i+2),8&f&&(n.data[j].shift*=-1);for(h=0;16>h;h++)if(e=a.ornaments[h])for(k=c.ornament[h],k.name=e.name,k.loop=e.loop,k.end=e.end,i=0,g=atob(e.data);i<g.length;i++)k.data[i]=g.charCodeAt(i);for(h=0;h<a.patterns.length;h++)if(g=a.patterns[h])for(g=atob(g),l=c.pattern[c.addNewPattern()],l.end=255&g.charCodeAt(0),i=1,j=0;i<g.length;i+=5,j++)l.data[j].tone=127&g.charCodeAt(i),l.data[j].release=!!(128&g.charCodeAt(i)),l.data[j].smp=31&g.charCodeAt(i+1),l.data[j].orn_release=!!(128&g.charCodeAt(i+1)),l.data[j].volume.byte=255&g.charCodeAt(i+2),l.data[j].orn=15&g.charCodeAt(i+3),l.data[j].cmd=(240&g.charCodeAt(i+3))>>4,l.data[j].cmd_data=255&g.charCodeAt(i+4);for(h=0;h<a.positions.length;h++)for(e=a.positions[h],g=atob(e.ch),m=c.position[h]=new pPosition(e.length,e.speed),i=0,j=0;6>i;i++)m.ch[i].pattern=255&g.charCodeAt(j++),m.ch[i].pitch=g.charCodeAt(j++);c.setInterrupt(d.audioInterrupt=a.config.audioInterrupt),c.currentPosition=a.config.currentPosition,c.repeatPosition=a.config.repeatPosition,c.currentLine=a.config.currentLine,b.modeEditChannel=a.config.editChannel,b.ctrlOctave=a.config.ctrlOctave,b.ctrlSample=a.config.ctrlSample,b.ctrlOrnament=a.config.ctrlOrnament,b.ctrlRowStep=a.config.ctrlRowStep,b.updatePanels(),b.updateTracklist(),b.updateSampleEditor(!0)})},a}();Tracker.prototype.updatePanels=function(){$("#scOctave").val(this.ctrlOctave),$("#scAutoSmp").val(this.ctrlSample),$("#scAutoOrn").val(this.ctrlOrnament),$("#scRowStep").val(this.ctrlRowStep),$("#txHeaderTitle").val(this.songTitle),$("#txHeaderAuthor").val(this.songAuthor),this.updatePanelInfo(),this.updatePanelPattern(),this.updatePanelPosition()},Tracker.prototype.updateEditorCombo=function(a){this.tracklist.moveCurrentline(a||this.ctrlRowStep),this.updateTracklist(),this.updatePanelInfo()},Tracker.prototype.updatePanelInfo=function(){var a,b,c=this.settings.audioInterrupt,d=null,e=null,f=0,g=0,h=this.player.currentPosition,i=this.player.position.length,j=this.player.currentLine,k=-2&j,l=60*c;if(i){for(d=this.player.position[h],b=l/(d.frames[k+2]-d.frames[k])>>1,l=0;i>l;l++)e=this.player.position[l],l===h&&(g=f),f+=e.frames[e.length];g+=d.frames[j],l=f.toString().length,a="("+g.toWidth(l)+"/"+f.toWidth(l)+")",$("#stInfoPanelFrames").text(a),g/=c,f/=c,a=(g/60).toWidth(2)+":"+(g%60).toWidth(2)+" / "+(f/60).toWidth(2)+":"+(f%60).toWidth(2),$("#stInfoPanelTime").text(a)}else $("#stInfoPanelTime").text("00:00 / 00:00"),$("#stInfoPanelFrames").text("(0/0)"),b=l/this.player.currentSpeed>>2;$("#stInfoPanelBPM").text("BPM: "+b+" ("+c+" Hz)")},Tracker.prototype.updatePanelPattern=function(){var a,b=["#scPattern","#scPatternLen","#btPatternDelete","#btPatternClean","#btPatternInfo"],c=$(b[0]).prop("disabled"),d=this.workingPattern,e=this.player.pattern.length,f=0,g=0,h=!0;for(e--,e?(f=1,g=e,d=Math.max(Math.min(d,g),f)):d=0,a=1;6>=a;a++)$("#scChnPattern"+a).trigger("touchspin.updatesettings",{min:0,max:g});if(d?(h=!1,$(b[1]).val(this.player.pattern[d].end)):$(b[1]).val(64),this.workingPattern=d,$(b[0]).trigger("touchspin.updatesettings",{min:f,max:g,initval:d}).val(d),$("#txPatternUsed").val(this.player.countPatternUsage(d)),$("#txPatternTotal").val(e),h!==c)for(a=0,e=b.length;e>a;a++)$(b[a]+","+b[a]+"~span>button").prop("disabled",h)},Tracker.prototype.updatePanelPosition=function(){var a,b,c=["#scPosCurrent","#scPosLength","#scPosSpeed","#txPosTotal","#scPosRepeat"],d=$(c[0]).prop("disabled"),e=this.player.nullPosition,f=this.player.position.length,g=this.player.currentPosition,h=!0;for(f?(h=!1,$(c[0]+","+c[4]).trigger("touchspin.updatesettings",{min:1,max:f}),$(c[0]).val(g+1),$(c[3]).val(f),$(c[4]).val(this.player.repeatPosition+1),e=this.player.position[g]):($(c[0]+","+c[4]).val(0).trigger("touchspin.updatesettings",{min:0,max:0}),$(c[3]).val(0)),$(c[1]).val(e.length),$(c[2]).val(e.speed),b=0;6>b;b++)c.push(a="#scChnPattern"+(b+1)),$(a).val(e.ch[b].pattern),c.push(a="#scChnTrans"+(b+1)),$(a).val(e.ch[b].pitch);if(h!==d)for(c.splice(3,1),b=0,f=c.length;f>b;b++)$(c[b]+","+c[b]+"~span>button").prop("disabled",h);e=null},Tracker.prototype.onCmdStop=function(){this.player.stopChannel(),this.modePlay=!1,this.globalKeyState.lastPlayMode=0},Tracker.prototype.onCmdSongPlay=function(){2!==this.globalKeyState.lastPlayMode&&(this.modePlay=this.player.playPosition(!1,!0,!0))},Tracker.prototype.onCmdSongPlayStart=function(){this.modePlay=this.player.playPosition(!0,!0,!0)},Tracker.prototype.onCmdPosPlay=function(){1!==this.globalKeyState.lastPlayMode&&(this.modePlay=this.player.playPosition(!1,!1,!1))},Tracker.prototype.onCmdPosPlayStart=function(){this.modePlay=this.player.playPosition(!1,!1,!0)},Tracker.prototype.onCmdToggleLoop=function(){var a=this.player.loopMode=!this.player.loopMode,b=$("a#miToggleLoop>span"),c="glyphicon-repeat",d="glyphicon-remove-circle",e=a?c:d,f=a?"#000":"#ccc";b.removeClass(c+" "+d),b.addClass(e).css({color:f})},Tracker.prototype.onCmdToggleEditMode=function(){var a=this.modeEdit=!this.modeEdit,b=$(".tracklist-panel");a?b.addClass("edit"):b.removeClass("edit"),this.updateTracklist(!0)},Tracker.prototype.hotkeyMap=function(a,b,c){var d=this,e=c>32&&41>c,f=/keyup|test/.test(a),g=/keydown|test/.test(a);switch(b){case"globalCtrl":if(!f)return;return{79:function(){},83:function(){},89:function(){},90:function(){}}[c];case"globalFs":if(!g)return;return{27:function(){d.modePlay?d.onCmdStop():d.modeEdit&&d.onCmdToggleEditMode()},112:function(){},113:function(){$("#tab-tracker").trigger("click")},114:function(){$("#tab-smpedit").trigger("click")},115:function(){$("#tab-ornedit").trigger("click")},116:function(){d.onCmdSongPlay()},117:function(){d.onCmdSongPlayStart()},118:function(){d.onCmdPosPlay()},119:function(){d.onCmdPosPlayStart()},120:function(){},121:function(){},122:function(){d.onCmdToggleLoop()},123:function(){}}[c];case"trackerCtrl":if(!("repeat"===a&&[38,40,48,57].indexOf(c)>=0||g))return;return c>96&&103>c?c=96:c>48&&57>c&&(c=56),{38:function(){var a=d.player.currentLine;return(a=a>=16&&(240&a)===a?16:15&a)?void d.updateEditorCombo(-a):!1},40:function(){var a=d.player.position[d.player.currentPosition]||d.player.nullPosition,b=d.player.currentLine,c=a.length;b=c-16>b?16-(15&b):c-b-1,d.updateEditorCombo(b)},48:function(){d.ctrlRowStep=parseInt($("#scRowStep").trigger("touchspin.uponce").val(),10)},56:function(a){a-=48,$("#scOctave").val(a),d.ctrlOctave=a},57:function(){d.ctrlRowStep=parseInt($("#scRowStep").trigger("touchspin.downonce").val(),10)},96:function(a){a-=96,$("#scChnButton"+a).bootstrapToggle("toggle")}}[c];case"trackerCtrlShift":if(!f)return;return{37:function(){$("#scPosCurrent").trigger("touchspin.downonce")},39:function(){$("#scPosCurrent").trigger("touchspin.uponce")}}[c];case"editorShift":if(!g||!d.modeEdit||!d.player.position.length)return;return{9:function(){d.modeEditChannel>0?d.modeEditChannel--:d.modeEditChannel=5,d.updateTracklist()}}[c];case"editorKeys":if(!(g||"repeat"===a&&e))return;if(e)if(d.modePlay)d.onCmdStop();else if(!d.player.position.length||!d.modeEdit&&d.modePlay)return;return{9:function(){d.player.position.length&&d.modeEdit&&(d.modeEditChannel<5?d.modeEditChannel++:d.modeEditChannel=0,d.updateTracklist())},32:function(){d.modePlay&&d.onCmdStop(),d.player.position.length&&d.onCmdToggleEditMode()},33:function(){var a=d.settings.tracklistLines+1;d.tracklist.moveCurrentline(-(a>>1),!0),d.updateTracklist(),d.updatePanelInfo()},34:function(){var a=d.settings.tracklistLines+1;d.tracklist.moveCurrentline(a>>1,!0),d.updateTracklist(),d.updatePanelInfo()},35:function(){d.tracklist.moveCurrentline(96,!0),d.updateTracklist(),d.updatePanelInfo()},36:function(){d.tracklist.moveCurrentline(-96,!0),d.updateTracklist(),d.updatePanelInfo()},37:function(){d.modeEdit&&(d.modeEditColumn>0?d.modeEditColumn--:(d.modeEditColumn=7,d.modeEditChannel>0?d.modeEditChannel--:d.modeEditChannel=5),d.updateTracklist())},38:function(){d.updateEditorCombo(-1)},39:function(){d.modeEdit&&(d.modeEditColumn<7?d.modeEditColumn++:(d.modeEditColumn=0,d.modeEditChannel<5?d.modeEditChannel++:d.modeEditChannel=0),d.updateTracklist())},40:function(){d.updateEditorCombo(1)}}[c];case"editorEdit":if(!g)return;var h=d.player.currentLine,i=d.player.position[d.player.currentPosition]||d.player.nullPosition,j=i.ch[d.modeEditChannel].pattern,k=d.player.pattern[j],l=k.data[h];if(h<k.end)switch(c){case 8:return function(){for(var a=h,b=h+1;96>b;a++,b++)k.data[a]=k.data[b];k.data[a].tone=k.data[a].smp=k.data[a].orn=0,k.data[a].release=k.data[a].orn_release=!1,k.data[a].cmd=k.data[a].cmd_data=k.data[a].volume.byte=0,d.updateTracklist()};case 45:return function(){for(var a=96-h,b=a-1,c=94;c>=h;b--,c--)k.data[b]=k.data[c];k.data[b].tone=k.data[b].smp=k.data[b].orn=0,k.data[b].release=k.data[b].orn_release=!1,k.data[b].cmd=k.data[b].cmd_data=k.data[b].volume.byte=0,d.updateTracklist()};case 46:return function(){switch(d.modeEditColumn){default:case 0:l.tone=0,l.release=0;break;case 1:l.smp=0;break;case 2:l.orn=0,l.orn_release=0;break;case 3:case 4:l.volume.byte=0;break;case 5:l.cmd=0,l.cmd_data=0;break;case 6:l.cmd_data&=15;break;case 7:l.cmd_data&=240}d.updateEditorCombo()};default:var m={0:function(a,b){var c=d.getKeynote(a);return 0>c?!1:b?!0:(c>0?(l.release=!1,l.tone=c,d.ctrlSample&&!l.smp&&(l.smp=d.ctrlSample),d.ctrlOrnament&&!l.orn&&(l.orn=d.ctrlOrnament,l.orn_release=!1)):(l.release=!0,l.tone=0,l.smp=0,l.orn=0,l.orn_release=!1),void d.updateEditorCombo())},1:function(a,b){if(a>=48&&57>=a){if(b)return!0;l.smp=a-48}else{if(!(a>=65&&86>=a))return!1;if(b)return!0;l.smp=a-55}d.updateEditorCombo()},2:function(a,b){if(a>=48&&57>=a){if(b)return!0;l.orn_release=!1,l.orn=a-48}else if(a>=65&&70>=a){if(b)return!0;l.orn_release=!1,l.orn=a-55}else{if(88!==a&&189!==a)return!1;if(b)return!0;l.orn_release=!0,l.orn=0}d.updateEditorCombo()},3:function(a,b){if(a>=48&&57>=a){if(b)return!0;l.volume.L=a-48}else{if(!(a>=65&&70>=a))return!1;if(b)return!0;l.volume.L=a-55}d.updateEditorCombo()},4:function(a,b){if(a>=48&&57>=a){if(b)return!0;l.volume.R=a-48}else{if(!(a>=65&&70>=a))return!1;if(b)return!0;l.volume.R=a-55}d.updateEditorCombo()},5:function(a,b){if(a>=48&&57>=a){if(b)return!0;l.cmd=a-48}else{if(!(a>=65&&70>=a))return;if(b)return!0;l.cmd=a-55,15==l.cmd&&l.cmd_data&&d.player.countPositionFrames(d.player.currentPosition)}d.updateEditorCombo()},6:function(a,b){if(a>=48&&57>=a)a-=48;else{if(!(a>=65&&70>=a))return!1;a-=55}return b?!0:(l.cmd_data&=15,l.cmd_data|=a<<4,15==l.cmd&&l.cmd_data&&d.player.countPositionFrames(d.player.currentPosition),void d.updateEditorCombo())},7:function(a,b){if(a>=48&&57>=a)a-=48;else{if(!(a>=65&&70>=a))return!1;a-=55}return b?!0:(l.cmd_data&=240,l.cmd_data|=a,15==l.cmd&&l.cmd_data&&d.player.countPositionFrames(d.player.currentPosition),void d.updateEditorCombo())}}[d.modeEditColumn];return m(c,!0)?m:void 0}default:return}},Tracker.prototype.handleKeyEvent=function(a){var b=this.globalKeyState,c=a.type,d=a.target&&"text"===a.target.type,e=d&&/touchspin/.test(a.target.parentElement.className),f=a.which||a.charCode||a.keyCode,g=!!this.player.position.length;if(browser.isOpera&&219===f)f=91;else if(browser.isFirefox)switch(f){case 59:f=186;break;case 61:f=187;break;case 173:f=189}if("keydown"===c){if(f>=16&&18>=f&&(b.modsHandled=!1,2===a.location&&(f+=256)),a.repeat?c="repeat":b[f]||(b[f]=!0,b.length++),e&&!this.handleHotkeys("test",f)||!e&&d&&!b[9])return!0;this.handleHotkeys(c,f)||0===this.activeTab&&(b[13]&&1===b.length&&g&&!this.modePlay&&!b.lastPlayMode?(this.modePlay=this.player.playPosition(!1,!1,!1),b.lastPlayMode=3):b[13]&&b.length>1&&this.modePlay&&3===b.lastPlayMode&&(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0)),d&&b[9]&&(delete b[9],b.length--,a.target.blur())}else if("keyup"===c&&(b[f]&&this.handleHotkeys(c,f)&&(d=!1),!b.modsHandled&&g&&(1===b.length&&b[272]?(this.modePlay&&1===b.lastPlayMode?(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0):(this.modePlay=this.player.playPosition(!1,!1,!0),b.lastPlayMode=1),b.modsHandled=!0):1===b.length&&b[273]&&(this.modePlay&&2===b.lastPlayMode?(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0):(this.modePlay=this.player.playPosition(!1,!0,!0),b.lastPlayMode=2),b.modsHandled=!0)),0===this.activeTab&&b[13]&&this.modePlay&&3===b.lastPlayMode&&(this.modePlay=!1,this.player.stopChannel(),this.updateTracklist(),b.lastPlayMode=0),b[f]&&(delete b[f],b.length&&b.length--),b[f+256]&&(delete b[f+256],b.length&&b.length--),d))return!0;return a.preventDefault(),!1},Tracker.prototype.handleHotkeys=function(a,b){var c=this.globalKeyState,d=!1;return c[17]&&17!==b?(90===b&&c[16]&&(delete c[b],delete c[16],c.length&&c.length--,c[--b]=!0),2===c.length?82===b||116===b?(d=!0,a="test"):(d=this.hotkeyMap(a,"globalCtrl",b))||(0!==this.activeTab||(d=this.hotkeyMap(a,"trackerCtrl",b))?1===this.activeTab?d=this.hotkeyMap(a,"smpeditCtrl",b):2===this.activeTab&&(d=this.hotkeyMap(a,"orneditCtrl",b)):d=this.hotkeyMap(a,"editorCtrl",b)):3===c.length&&c[16]&&0===this.activeTab&&(d=this.hotkeyMap(a,"trackerCtrlShift",b))):c[16]&&16!==b&&2===c.length&&0===this.activeTab?d=this.hotkeyMap(a,"editorShift",b):1===c.length&&((d=this.hotkeyMap(a,"globalFs",b))||(0===this.activeTab?!(d=this.hotkeyMap(a,"editorKeys",b))&&this.player.position.length&&this.modeEdit&&(d=this.hotkeyMap(a,"editorEdit",b)):d=this.hotkeyMap(a,"smpornKeys",b))),d?("test"!==a&&(d(b),c.modsHandled=!0),!0):void 0},Tracker.prototype.getKeynote=function(a){var b=12*(this.ctrlOctave-1),c=String.fromCharCode(a),d=" ZSXDCVGBHNJMQ2W3ER5T6Y7UI9O0P".indexOf(c);return d>0?b+d:(d={49:0,65:0,192:0,189:0,222:0,188:b+13,76:b+14,190:b+15,186:b+16,191:b+17,219:b+30,187:b+31,221:b+32}[a])>=0?d:-1},Tracker.prototype.initPixelFont=function(a){var b,c,d,e=["#fff","#f00","#38c","#000","#800"],f=this.pixelfont,g=10*e.length,h=a.width;for(f.obj=document.createElement("canvas"),f.obj.width=h,f.obj.height=g,f.ctx=f.obj.getContext("2d"),b=0;g>b;b+=10)f.ctx.fillStyle=e[b/10],f.ctx.fillRect(0,b,h,10);for(c=document.createElement("canvas"),c.width=h,c.height=5,d=c.getContext("2d"),d.save(),d.clearRect(0,0,h,5),d.drawImage(a,0,0),d.fillStyle="#fff",d.globalCompositeOperation="source-in",d.fillRect(0,0,h,5),d.restore(),b=0;g>b;b+=10)f.ctx.drawImage(c,0,b);for(d.save(),d.clearRect(0,0,h,5),d.drawImage(a,0,0),d.fillStyle="#aaa",d.globalCompositeOperation="source-in",d.fillRect(0,0,h,5),d.restore(),b=5;g>b;b+=10)f.ctx.drawImage(c,0,b);f.ctx.drawImage(a,0,0),d=null,c=null},Tracker.prototype.updateTracklist=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n=this.tracklist.canvasData,o=this.tracklist.offsets,p=this.player,q=this.settings.hexTracklines?16:10,r=this.pixelfont.obj,s=this.tracklist.ctx,t=p.currentPosition,u=p.position[t]||p.nullPosition,v=this.tracklist.obj.width,w=this.settings.tracklistLineHeight,x=this.settings.tracklistLines,y=x>>1,z=p.currentLine-y,A=function(a){return 6*(d.charCodeAt(a||0)-32)};for(a&&(n.center=v-n.lineWidth>>1,n.vpad=Math.round((w-5)/2),n.trkOffset=n.center+24,o.y=[]),h=0,m=0,l=n.vpad;x>h;h++,z++,l+=w,m+=w)if(a&&(o.y[h]=m),h!==y?f=0:this.modeEdit?(f=10,s.fillStyle="#f00",s.fillRect(0,m,v,w)):(f=20,a&&(s.fillStyle="#38c",s.fillRect(0,m,v,w))),z>=0&&z<u.length)for(d=("0"+z.toString(q)).substr(-2),s.drawImage(r,A(0),f,5,5,n.center,l,5,5),s.drawImage(r,A(1),f,5,5,n.center+6,l,5,5),g=0;6>g;g++)for(b=p.pattern[u.ch[g].pattern],c=b.data[z],i=0;8>i;i++)if(k=n.trkOffset+g*n.chnWidth+n.columns[i],a&&(o.x[g][i]=k,!i&&g&&(o.x[g-1][8]=k)),e=f,!i&&(h!==y||!this.modeEdit)&&this.selectionLen&&this.selectionChannel===g&&z>=this.selectionLine&&z<=this.selectionLine+this.selectionLen?(s.fillStyle="#000",s.fillRect(k-3,m,n.selWidth,w),e=30):h===y&&this.modeEdit&&this.modeEditChannel===g&&this.modeEditColumn===i&&(s.fillStyle="#800",i?s.fillRect(k-1,m,7,w):s.fillRect(k-2,m,22,w),e=40),z>=b.end&&(e+=5),i){switch(j=-1,i){case 1:c.smp&&(j=c.smp);break;case 2:c.orn_release?j=33:c.orn&&(j=c.orn);break;case 3:c.volume.byte&&(j=c.volume.L);break;case 4:c.volume.byte&&(j=c.volume.R);break;case 5:(c.cmd||c.cmd_data)&&(j=c.cmd);break;case 6:(c.cmd||c.cmd_data)&&(j=(240&c.cmd_data)>>4);break;case 7:(c.cmd||c.cmd_data)&&(j=15&c.cmd_data)}d=0>j?"":j.toString(36),s.drawImage(r,A(),e,5,5,k,l,5,5)}else d="---",c.release?d="R--":c.tone&&(d=p.tones[c.tone].txt),s.drawImage(r,A(0),e,5,5,k,l,5,5),s.drawImage(r,A(1),e,5,5,k+6,l,5,5),s.drawImage(r,A(2),e,5,5,k+12,l,5,5);else s.fillStyle="#fff",s.fillRect(n.center,l,n.lineWidth,5);a&&(o.x[5][8]=v,o.x[0][0]=0,o.y[h]=m)},Tracker.prototype.updateSampleEditor=function(a){for(var b,c,d,e,f,g,h,i=this.smpornedit,j=this.player.sample[this.workingSample],k=i.amp.ctx,l=i.noise.ctx,m=i.range.ctx,n=k.getImageData(22,0,1,1),o=i.halfing,p=i.smpeditOffset,q=p+64,r=i.columnWidth,s=i.centering,t=r-1;q>p;p++,s+=r){for(b=p>=j.end&&!j.releasable?"#888":j.loop!=j.end&&p>=j.loop&&p<j.end?"#38c":"#000",m.strokeStyle=m.fillStyle=l.fillStyle=k.strokeStyle=k.fillStyle=b,c=j.data[p],g=c.volume.L,h=c.volume.R,e=o-12,f=o+5,d=0;15>d;d++,e-=9,f+=9)k.clearRect(s,e,t,8),k.putImageData(n,s,e+7),g>d&&k.fillRect(s,e,t,8),k.clearRect(s,f,t,8),k.putImageData(n,s,f),h>d&&k.fillRect(s,f,t,8);for(k.clearRect(s,292,t,12),k.strokeRect(s-.5,291.5,t-1,12),c.enable_freq&&k.fillRect(s+1,293,t-4,9),d=0,e=34;4>d;d++,e-=9)l.clearRect(s,e,t,8),l.putImageData(n,s,e+7),c.enable_noise&&d<=c.noise_value&&l.fillRect(s,e,t,8);m.clearRect(s,4,12,8),p>=j.end?m.fillRect(s,12,12,1):(m.fillRect(s,10,12,3),j.loop<=j.end&&p===j.end-1&&(m.beginPath(),m.moveTo(s,10),m.lineTo(s+12,10),m.lineTo(s+12,4),m.closePath(),m.fill()),j.loop<j.end&&p===j.loop&&(m.beginPath(),m.moveTo(s,10),m.lineTo(s+12,10),m.lineTo(s,4),m.closePath(),m.fill()))}a&&(g=j.end===j.loop,$("#txSampleName").val(j.name),$("#scSampleLength").val(""+j.end),$("#scSampleRepeat").trigger("touchspin.updatesettings",{min:0,max:j.end}).val(j.end-j.loop),g&&j.releasable&&(j.releasable=!1),$("#chSampleRelease").prop("checked",j.releasable),$("#chSampleRelease").prop("disabled",g).parent()[g?"addClass":"removeClass"]("disabled"),$("#fxSampleShift>.cell").each(function(a,b){c=j.data[a],a>=j.end&&!j.releasable?b.className="cell":!g&&a>=j.loop&&a<j.end?b.className="cell loop":b.className="cell on",$(b).find("input").val(parseInt(c.shift,i.radix))}),$("#sbSampleScroll").scrollLeft(0),$("#fxSampleShift").parent().scrollLeft(0))},Tracker.prototype.populateGUI=function(){for(var app=this,populatedElementsTable=[{global:"document",method:"bind",param:"contextmenu",handler:function(a){return a.preventDefault(),!1}},{global:"window",method:"resize",handler:function(){var a=app.tracklist.countTracklines();a!==app.settings.tracklistLineHeight&&(app.tracklist.setHeight(a),app.updateTracklist(!0))}},{global:"window",method:"bind",param:"keyup keydown",handler:function(a){return app.handleKeyEvent(a.originalEvent)}},{global:"window",method:"bind",param:"blur",handler:function(a){var b,c=app.globalKeyState;for(b in c)b-0&&(delete c[b],c.length--)}},{selector:'[data-toggle="tooltip"]',method:"tooltip",data:{animation:!1,container:".tooltip-target",viewport:{selector:".tooltip-target",padding:0},template:'<div class="tooltip tooltip-custom" role="tooltip"><div class="tooltip-inner"></div></div>'}},{selector:"canvas",method:"each",handler:function(a,b){var c=b.className,d=app[c];if("tracklist"===c)d.obj=b,d.ctx=b.getContext("2d"),d.setHeight();else if("smpornedit"===c){var e=b.id.replace("smpedit_",""),f=d[e];f.obj=b,f.ctx=b.getContext("2d")}}},{selector:"img.pixelfont",method:"load",handler:function(a){app.initPixelFont(a.target),app.updateTracklist(!0)}},{selector:"img.smpedit",method:"load",handler:function(a){app.smpornedit.drawHeaders(a.target)}},{selector:"#main-tabpanel a",method:"bind",param:"click",handler:function(a){app.activeTab=parseInt($(this).data().value)}},{selector:"#tracklist",method:"on",param:"mousewheel DOMMouseScroll",handler:function(a){if(app.player.position.length&&!app.modePlay){var b=a.originalEvent.wheelDelta||-a.originalEvent.deltaY||-a.originalEvent.detail;a.stopPropagation(),a.preventDefault(),a.target.focus(),0>b?app.tracklist.moveCurrentline(1):b>0&&app.tracklist.moveCurrentline(-1),app.updateTracklist(),app.updatePanelInfo()}}},{selector:"#scOctave",method:"TouchSpin",data:{initval:"2",min:1,max:8}},{selector:"#scOctave",method:"change",handler:function(){app.ctrlOctave=$(this).val()-0}},{selector:"#scAutoSmp",method:"TouchSpin",data:{initval:"0",radix:32,min:0,max:31}},{selector:"#scAutoSmp",method:"change",handler:function(){app.ctrlSample=parseInt($(this).val(),32)}},{selector:"#scAutoOrn",method:"TouchSpin",data:{initval:"0",radix:16,min:0,max:15}},{selector:"#scAutoOrn",method:"change",handler:function(){app.ctrlOrnament=parseInt($(this).val(),16)}},{selector:"#scRowStep",method:"TouchSpin",data:{initval:"0",min:0,max:8}},{selector:"#scRowStep",method:"change",handler:function(){app.ctrlRowStep=$(this).val()-0}},{selector:'#scPattern,#scPosCurrent,#scPosRepeat,input[id^="scChnPattern"]',method:"TouchSpin",data:{initval:"0",min:0,max:0}},{selector:"#scPatternLen,#scPosLength",method:"TouchSpin",data:{initval:"64",min:1,max:96}},{selector:"#scPattern",method:"change",handler:function(){return app.player.pattern.length<=1?!1:(app.workingPattern=$(this).val()-0,void app.updatePanelPattern())}},{selector:"#scPatternLen",method:"change",handler:function(){var a=app.player.pattern[app.workingPattern];return app.player.pattern.length<=1?!1:app.modePlay?($(this).val(a.end),!1):(a.end=$(this).val()-0,app.player.countPositionFrames(),app.updatePanelPattern(),app.updateTracklist(),void app.updatePanelInfo())}},{selector:"#scPosCurrent",method:"change",handler:function(){return app.player.position.length?app.modePlay?($(this).val(app.player.currentPosition+1),!1):(app.player.currentPosition=$(this).val()-1,app.player.currentLine=0,app.updatePanelInfo(),app.updatePanelPosition(),void app.updateTracklist()):!1}},{selector:"#scPosLength",method:"change",handler:function(){var a=app.player.currentPosition,b=app.player.position[a];return app.player.position.length?app.modePlay?($(this).val(b.length),!1):(b.length=$(this).val()-0,app.player.currentLine>=b.length&&(app.player.currentLine=b.length-1),app.player.countPositionFrames(a),app.updateTracklist(),void app.updatePanelInfo()):!1}},{selector:"#scPosSpeed",method:"TouchSpin",data:{initval:"6",min:1,max:31}},{selector:"#scPosSpeed",method:"change",handler:function(){var a=app.player.currentPosition,b=app.player.position[a];return app.player.position.length?app.modePlay?($(this).val(b.speed),!1):(b.speed=$(this).val()-0,app.player.countPositionFrames(a),app.updateTracklist(),void app.updatePanelInfo()):!1}},{selector:"#scPosRepeat",method:"change",handler:function(){return app.player.position.length?app.modePlay?($(this).val(app.player.repeatPosition+1),!1):void(app.player.repeatPosition=$(this).val()-1):!1}},{selector:'input[id^="scChnPattern"]',method:"change",handler:function(a){var b=a.target,c=app.player.currentPosition,d=b.id.substr(-1)-1,e=app.player.position[c],f=b.value-0,g=e.ch[d].pattern;return app.player.position.length?app.modePlay?(b.value=g,!1):(e.ch[d].pattern=f,(app.workingPattern===f||app.workingPattern===g)&&app.updatePanelPattern(),app.player.countPositionFrames(c),app.updateTracklist(),void app.updatePanelInfo()):!1}},{selector:'input[id^="scChnTrans"]',method:"each",handler:function(a,b){$(this).TouchSpin({initval:"0",min:-24,max:24}).change(function(a){var b=a.target,c=b.id.substr(-1)-1,d=app.player.position[app.player.currentPosition];return app.player.position.length?app.modePlay?(b.value=d.ch[c].pitch,!1):void(d.ch[c].pitch=b.value-0):!1})}},{selector:'input[id^="scChnButton"]',method:"each",handler:function(a,b){var c=b.id.substr(-1);$(this).bootstrapToggle({on:c,off:c,onstyle:"default",offstyle:"default",size:"mini",width:58}).change(function(a){var b=a.target;app.player.SAA1099.mute(b.value-1,!b.checked)})}},{selector:"#scSampleNumber",method:"TouchSpin",data:{initval:"1",radix:32,min:1,max:31}},{selector:"#scSampleNumber",method:"change",handler:function(){app.workingSample=parseInt($(this).val(),32),app.updateSampleEditor(!0)}},{selector:"#scSampleTone",method:"each",handler:function(a,b){var c="tx"+b.id.substr(2);$(this).TouchSpin({initval:app.workingSampleTone,min:1,max:96}).change(function(a){var b=a.target,c=b.value-0;app.workingSampleTone=c,$(this).prev().val(app.player.tones[c].txt)}).wrapAll('<div id="'+c+'"/>').removeAttr("style").prop("readonly",!0).clone(!1).removeAttr("id").insertBefore(this),$(this).trigger("change")}},{selector:"#sbSampleScroll",method:"scroll",handler:function(a){app.smpornedit.smpeditOffset=0|a.target.scrollLeft/1e3*64,app.updateSampleEditor()}},{selector:"#scSampleLength,#scSampleRepeat",method:"TouchSpin",data:{initval:"0",min:0,max:255}},{selector:"#scSampleLength",method:"change",handler:function(a){var b=app.player.sample[app.workingSample],c=parseInt(a.target.value,10)-b.end,d=b.loop+=c;b.end+=c,b.loop=b.end-d<0?0:d,app.updateSampleEditor(!0)}},{selector:"#scSampleRepeat",method:"change",handler:function(a){var b=app.player.sample[app.workingSample],c=parseInt(a.target.value,10);b.loop=b.end-c,app.updateSampleEditor(!0)}},{selector:"#chSampleRelease",method:"change",handler:function(a){var b=app.player.sample[app.workingSample];b.end!==b.loop&&(b.releasable=a.target.checked),app.updateSampleEditor(!0)}},{selector:'a[id^="miFileImportDemo"]',method:"click",handler:function(){var a=$(this).data(),b=a.filename;return b?void app.loadDemosong(b):!1}},{selector:"#miStop,#btSampleStop,#btOrnamentStop",method:"click",handler:function(){app.onCmdStop()}},{selector:"#miSongPlay",method:"click",handler:function(){app.onCmdSongPlay()}},{selector:"#miSongPlayStart",method:"click",handler:function(){app.onCmdSongPlayStart()}},{selector:"#miPosPlay",method:"click",handler:function(){app.onCmdPosPlay()}},{selector:"#miPosPlayStart",method:"click",handler:function(){app.onCmdPosPlayStart()}},{selector:"#btSamplePlay",method:"click",handler:function(){app.player.playSample(app.workingSample,0,app.workingSampleTone)}},{selector:"#btOrnamentPlay",method:"click",handler:function(){app.player.playSample(app.workingSample,app.workingOrnament,app.workingSampleTone)}},{selector:"#miToggleLoop",method:"click",handler:function(){app.onCmdToggleLoop()}}],i=0,l=populatedElementsTable.length;l>i;i++){var obj=populatedElementsTable[i],param=obj.handler||obj.data,selector=obj.selector?"'"+obj.selector+"'":obj.global;eval("$("+selector+")."+(obj.param?obj.method+"('"+obj.param+"', param)":obj.method+"(param)"))}};