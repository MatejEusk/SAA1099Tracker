/*!
 * Player: Core of player routine.
 * Copyright (c) 2012-2016 Martin Borik <mborik@users.sourceforge.net>
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom
 * the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS
 * OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF
 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
var pMode={PM_NOT:0,PM_SONG:1,PM_POSITION:2,PM_SONG_OR_POS:3,PM_SAMPLE:4,PM_LINE:8,PM_SAMP_OR_LINE:12},pTone=function(){function a(a){void 0===a&&(a=0),this.cent=0,this.oct=0,this.txt="---",this.word=a}return Object.defineProperty(a.prototype,"word",{get:function(){return 255&this.cent|(7&this.oct)<<8},set:function(a){this.cent=255&a,this.oct=(1792&a)>>8},enumerable:!0,configurable:!0}),a}(),pVolume=function(){function a(){this.L=0,this.R=0}return Object.defineProperty(a.prototype,"byte",{get:function(){return 15&this.L|(15&this.R)<<4},set:function(a){this.L=15&a,this.R=a>>4&15},enumerable:!0,configurable:!0}),a}(),pPosition=function(){function a(a,b){void 0===b&&(b=6),this.ch=[],this.speed=b,this.length=a,this.frames=[];for(var c=0;6>c;c++)this.ch[c]={pattern:0,pitch:0};for(var c=0,d=0;96>=d;d++,c+=b)this.frames[d]=c}return a.prototype.hasPattern=function(a){return this.indexOf(a)>=0},a.prototype.indexOf=function(a){for(var b=0,c=-1;0>c&&6>b;b++)this.ch[b].pattern===a&&(c=b);return c},a}(),Player=function(){function a(a){this.SAA1099=a,this.sample=[],this.ornament=[],this.playParams=[];var b=["B-","!C-","<C#","UD-","mD#","E-","F-","­F#","ÀG-","ÒG#","ãA-","óA#","ÿB-"];this.tones=[new pTone];for(var c,d,e=1,f=0,g=1;96>=e;e++,g++)d=new pTone,d.txt=b[g].substr(1)+(f+1),c=b[g].charCodeAt(0),255===c&&7>f&&(f++,g=0,c=b[g].charCodeAt(0)),d.oct=f,d.cent=c,this.tones[e]=d;this.clearSong(),this.clearSamples(),this.clearOrnaments(),this.loopMode=!0,this.stopChannel(0),this.mode=pMode.PM_NOT}return a.prototype.clearSong=function(){this.position=[],this.pattern=[],this.addNewPattern(),this.changedLine=!0,this.changedPosition=!0,this.currentPosition=0,this.repeatPosition=0,this.currentSpeed=6,this.currentLine=0,this.currentTick=0;for(var a=0;6>a;a++)this.clearPlayParams(a)},a.prototype.clearSamples=function(){for(var a=0;32>a;a++){this.sample[a]={name:"",data:[],loop:0,end:0,releasable:!1};for(var b=0;256>b;b++)this.sample[a].data[b]={volume:new pVolume,enable_freq:!1,enable_noise:!1,noise_value:0,shift:0}}},a.prototype.clearOrnaments=function(){for(var a=0;16>a;a++)this.ornament[a]={name:"",data:new Int8Array(256),loop:0,end:0}},a.prototype.clearPlayParams=function(a){this.playParams[a]={tone:0,playing:!1,sample:this.sample[0],ornament:this.ornament[0],sample_cursor:0,ornament_cursor:0,attenuation:new pVolume,slideShift:0,globalPitch:0,released:!1,command:0,commandParam:0,commandPhase:0,commandValue1:0,commandValue2:0}},a.prototype.addNewPattern=function(){var a,b=this.pattern.length,c={data:[],end:0};for(a=0;96>a;a++)c.data[a]={tone:0,release:!1,smp:0,orn:0,orn_release:!1,volume:new pVolume,cmd:0,cmd_data:0};return this.pattern.push(c),b},a.prototype.getAudio=function(a,b,c){this.SAA1099.output(a,b,c),this.prepareFrame()},a.prototype.prepareFrame=function(){if(this.mode!==pMode.PM_NOT){var b,c,d,e,f,g,h,i,j,k,l,m,n,o=new pVolume,p=0,q=0,r=0,s=0,t=0;for(d=5;d>=0;d--)if(b=this.playParams[d],n=1<<d,e=d>>1,f=d/3&1,b.playing){switch(k=b.sample.data[b.sample_cursor],o["byte"]=k.volume["byte"],c=b.ornament.data[b.ornament_cursor],g=k.noise_value|k.enable_noise<<2,h=b.command,i=(240&b.commandParam)>>4,j=15&b.commandParam,h){case 1:case 2:!b.commandPhase&&b.commandParam&&(b.commandPhase=i),b.commandPhase&&!--b.commandPhase&&(b.slideShift+=j*(1&h?1:-1));break;case 3:!b.commandPhase&&b.commandParam&&(b.commandPhase=i),b.commandValue1&&b.commandPhase&&!--b.commandPhase&&(b.commandValue2>0?(b.slideShift+=j,b.slideShift>=b.commandValue2&&(b.tone=b.commandValue1,b.slideShift=b.commandValue1=b.commandValue2=0,h=-1)):(b.slideShift-=j,b.slideShift<=b.commandValue2&&(b.tone=b.commandValue1,b.slideShift=b.commandValue1=b.commandValue2=0,h=-1)));break;case 4:b.commandParam?(i?b.commandPhase=b.commandPhase+i&63:b.commandPhase=0,b.slideShift=a.vibratable[(j<<6)+b.commandPhase]):b.slideShift=0;break;case 5:if(b.commandParam){if(i?b.commandPhase=b.commandPhase+i&63:b.commandPhase=0,p=b.commandValue2,b.commandValue2=a.vibratable[(j<<6)+b.commandPhase],p=-(b.commandValue2-p),0==p)break;b.attenuation.L+p<0?b.attenuation.L=0:b.attenuation.L+p>15?b.attenuation.L=15:b.attenuation.L+=p,b.attenuation.R+p<0?b.attenuation.R=0:b.attenuation.R+p>15?b.attenuation.R=15:b.attenuation.R+=p}break;case 6:b.commandParam&&(b.commandPhase=b.commandParam,b.commandParam=0),b.commandPhase?(c=0,b.commandPhase--):(b.ornament_cursor=0,c=b.ornament.data[b.ornament_cursor],h=-1);break;case 7:b.commandParam>0&&b.commandParam<b.ornament.end&&(c=0,b.ornament_cursor=b.commandParam),h=-1;break;case 9:b.commandParam>0&&(b.sample.releasable||b.commandParam<b.sample.end)&&(b.sample_cursor=b.commandParam,k=b.sample.data[b.sample_cursor],o["byte"]=k.volume["byte"]),h=-1;break;case 10:!b.commandPhase&&b.commandParam&&(b.commandPhase=i),b.commandPhase&&!--b.commandPhase&&(p=(7&b.commandParam)*(8&b.commandParam?-1:1),b.attenuation.L+p<0?b.attenuation.L=0:b.attenuation.L+p>15?b.attenuation.L=15:b.attenuation.L+=p,b.attenuation.R+p<0?b.attenuation.R=0:b.attenuation.R+p>15?b.attenuation.R=15:b.attenuation.R+=p);break;case 11:break;case 12:if(b.commandParam)if(15>i)switch(b.commandPhase){default:b.commandPhase=2;break;case 2:c+=i,b.commandPhase--;break;case 1:c+=j,b.commandPhase--}else 1&j&&(b.commandPhase=o.R,o.R=o.L,o.L=b.commandPhase,b.commandPhase=0);else b.commandPhase=0;break;case 14:2==i?(b.commandParam&=7,g=4^b.commandParam):(16&b.commandParam||(b.attenuation["byte"]=255),b.commandParam=(14&b.commandParam)<<1|129&b.commandParam,b.commandParam^=130,this.SAA1099.setRegData(24+f,b.commandParam),h=-1);break;default:h=-1}0>h&&(b.command=0,b.commandParam=0,b.commandPhase=0),o.L=Math.max(0,o.L-b.attenuation.L),o.R=Math.max(0,o.R-b.attenuation.R),this.SAA1099.setRegData(d,o["byte"]),b.tone?(l=this.calculateTone(b.tone,b.globalPitch,c,k.shift+b.slideShift),this.SAA1099.setRegData(8+d,l.cent),q=1&d?l.oct<<4:q|l.oct):1&d&&(q=0),this.SAA1099.setRegData(16+e,q),k.enable_freq&&(r|=n),4&g&&(s|=n,m=f<<2,t=t&240>>m|(3&g)<<m),b.sample_cursor+1>=b.sample.end?(m=d+1,b.sample.releasable&&b.released?0===++b.sample_cursor&&this.stopChannel(m):b.sample.loop===b.sample.end?this.mode&pMode.PM_SAMP_OR_LINE?this.stopChannel(m):b.sample_cursor=b.sample.end:this.mode===pMode.PM_LINE?this.stopChannel(m):b.sample_cursor=b.sample.loop):b.sample_cursor++,b.ornament_cursor+1>=b.ornament.end?b.ornament_cursor=b.ornament.loop:b.ornament_cursor++}else 1&d&&(q=0),this.SAA1099.setRegData(d,0),this.SAA1099.setRegData(8+d,0),this.SAA1099.setRegData(16+e,q),r&=255^n,s&=255^n;this.SAA1099.setRegData(20,r),this.SAA1099.setRegData(21,s),this.SAA1099.setRegData(22,t),this.mode&pMode.PM_SAMP_OR_LINE&&0===(r|s)?(this.SAA1099.setRegData(28,0),this.mode=pMode.PM_NOT):(this.SAA1099.setRegData(28,1),this.mode&pMode.PM_LINE&&this.currentTick>0?this.currentTick--:this.mode&pMode.PM_SONG_OR_POS&&this.prepareLine())}},a.prototype.prepareLine=function(a){if(this.currentTick)return this.currentTick--,!0;if(this.currentPosition>=this.position.length)return!1;(void 0===a||a)&&(this.currentLine++,this.changedLine=!0);var b,c,d,e,f=this.position[this.currentPosition];if(this.currentLine>=f.length){if(this.mode===pMode.PM_SONG){if(this.currentPosition++,this.currentPosition>=this.position.length){if(!this.loopMode)return this.currentLine--,this.stopChannel(0),!1;this.currentPosition=this.repeatPosition}this.currentLine=0,this.changedPosition=!0,f=this.position[this.currentPosition]}else{if(!this.loopMode)return this.currentLine--,this.stopChannel(0),!1;this.currentLine=0}this.currentSpeed=f.speed}for(var g=0;6>g;g++)if(b=f.ch[g],d=this.pattern[b.pattern<this.pattern.length?b.pattern:0],!(this.currentLine>=d.end)){if(c=this.playParams[g],c.globalPitch=f.ch[g].pitch,c.playing=!0,e=d.data[this.currentLine],e.cmd)if(15==e.cmd&&e.cmd_data>0){if(this.currentSpeed=e.cmd_data,this.currentSpeed>=32){var h=(240&this.currentSpeed)>>4,i=15&this.currentSpeed;2>i||h==i?this.currentSpeed=h:1&this.currentLine&&(this.currentSpeed=h|i<<4)}c.command=c.commandParam=c.commandPhase=0}else c.command=e.cmd,c.commandParam=e.cmd_data,e.cmd!=c.command&&(c.commandPhase=0);else(e.tone||e.smp)&&(c.command=c.commandParam=c.commandPhase=0);if(e.volume["byte"]&&5!=c.command&&10!=c.command&&(c.attenuation["byte"]=~e.volume["byte"]),e.release)c.sample.releasable?c.released=!0:this.clearPlayParams(g);else{if(e.tone&&3==e.cmd&&e.cmd_data){c.commandValue1&&(c.tone=c.commandValue1,c.slideShift-=c.commandValue2);var j=this.calculateTone(c.tone,0,0,c.slideShift),k=this.calculateTone(e.tone,0,0,0),l=k.word-j.word;0===l?(c.tone=e.tone,c.commandValue1=c.commandValue2=0,c.command=c.commandParam=c.commandPhase=0):(c.commandValue1=e.tone,c.commandValue2=l+c.slideShift,c.commandPhase=(240&c.commandParam)>>4)}else e.tone&&(c.tone=e.tone,c.sample_cursor=0,c.ornament_cursor=0,c.slideShift=c.commandValue1=c.commandValue2=0);e.smp&&(c.sample=this.sample[e.smp],c.sample_cursor=0),e.orn?(c.ornament=this.ornament[e.orn],c.ornament_cursor=0):e.orn_release&&(c.ornament=this.ornament[0],c.ornament_cursor=0,(6==c.command||7==c.command)&&(c.command=c.commandParam=c.commandPhase=0))}}return this.currentSpeed>32?this.currentTick=1&this.currentLine?15&this.currentSpeed:(240&this.currentSpeed)>>4:this.currentTick=this.currentSpeed,this.currentTick--,!0},a.prototype.playLine=function(){return this.mode===pMode.PM_LINE&&this.currentTick>0?!1:(this.mode=pMode.PM_LINE,this.currentTick=0,this.prepareLine(!1))},a.prototype.playPosition=function(a,b,c){return(void 0===a||a)&&(this.currentPosition=0),(void 0===c||c)&&(this.currentLine=0),void 0===b&&(b=!0),this.changedLine=!0,this.changedPosition=!0,this.currentPosition>=this.position.length?!1:(this.stopChannel(0),this.mode=b?pMode.PM_SONG:pMode.PM_POSITION,this.currentSpeed=this.position[this.currentPosition].speed,this.prepareLine(!1))},a.prototype.playSample=function(a,b,c,d){if(d){if(--d>5)return 0;if(this.playParams[d].playing)return 0}else{for(d=0;6>d&&this.playParams[d].playing;d++);if(6===d)return 0}return this.clearPlayParams(d),this.playParams[d].playing=!0,this.playParams[d].tone=++c,this.playParams[d].sample=this.sample[a],this.playParams[d].ornament=this.ornament[b],this.mode=pMode.PM_SAMPLE,++d},a.prototype.stopChannel=function(a){if(void 0===a&&(a=0),!(0>a||a>6)){if(0===a){for(;6>a;a++)this.clearPlayParams(a);return this.mode=pMode.PM_LINE,this.prepareFrame(),this.currentTick=0,void(this.changedLine=!0)}this.clearPlayParams(--a)}},a.prototype.calculateTone=function(a,b,c,d){for(var e=a+b+c;0>e;)e+=96;for(;e>=96;)e-=96;for(e=this.tones[e].word+d;0>e;)e+=2048;for(;e>=2048;)e-=2048;return new pTone(e)},a.prototype.countPatternUsage=function(a){if(a>=this.pattern.length)return 0;for(var b=0,c=0,d=this.position.length;d>c;c++)for(var e=0;6>e;e++)this.position[c].ch[e].pattern===a&&b++;return b},a.prototype.countPositionFrames=function(a){var b,c,d,e,f,g=this.position.length;if(void 0===a||0>a)for(b=0;g>b;b++)this.countPositionFrames(b);else if(g>a){for(e=this.position[a].speed,b=0,d=0;96>d;d++){for(c=0;6>c;c++)if(f=this.pattern[this.position[a].ch[c].pattern].data[d],15===f.cmd&&f.cmd_data>0&&(e=f.cmd_data,e>=32)){var h=(240&e)>>4,i=15&e;2>i||h===i?e=h:1&d&&(e=h|i<<4)}this.position[a].frames[d]=b,b+=e>32?1&d?15&e:(240&e)>>4:e}this.position[a].frames[d]=b}},a.vibratable=[0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,1,1,1,1,0,0,0,-1,-1,-1,-1,-2,-2,-2,-2,-2,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-2,-2,-2,-2,-2,-1,-1,-1,-1,0,0,0,1,1,2,2,3,3,4,4,4,4,5,5,5,5,5,5,5,5,5,4,4,4,4,3,3,2,2,1,1,0,0,0,-1,-1,-2,-2,-3,-3,-4,-4,-4,-4,-5,-5,-5,-5,-5,-5,-5,-5,-5,-4,-4,-4,-4,-3,-3,-2,-2,-1,-1,0,0,1,1,2,3,3,4,4,5,5,6,6,6,7,7,7,7,7,7,7,6,6,6,5,5,4,4,3,3,2,1,1,0,-1,-1,-2,-3,-3,-4,-4,-5,-5,-6,-6,-6,-7,-7,-7,-7,-7,-7,-7,-6,-6,-6,-5,-5,-4,-4,-3,-3,-2,-1,-1,0,1,2,3,3,4,5,6,6,7,7,8,8,9,9,9,9,9,9,9,8,8,7,7,6,6,5,4,3,3,2,1,0,-1,-2,-3,-3,-4,-5,-6,-6,-7,-7,-8,-8,-9,-9,-9,-9,-9,-9,-9,-8,-8,-7,-7,-6,-6,-5,-4,-3,-3,-2,-1,0,1,2,3,4,5,6,7,8,9,9,10,10,11,11,11,11,11,11,11,10,10,9,9,8,7,6,5,4,3,2,1,0,-1,-2,-3,-4,-5,-6,-7,-8,-9,-9,-10,-10,-11,-11,-11,-11,-11,-11,-11,-10,-10,-9,-9,-8,-7,-6,-5,-4,-3,-2,-1,0,1,3,4,5,6,7,8,9,10,11,11,12,12,13,13,13,13,13,12,12,11,11,10,9,8,7,6,5,4,3,1,0,-1,-3,-4,-5,-6,-7,-8,-9,-10,-11,-11,-12,-12,-13,-13,-13,-13,-13,-12,-12,-11,-11,-10,-9,-8,-7,-6,-5,-4,-3,-1,0,1,3,4,6,7,8,10,11,12,12,13,14,14,15,15,15,15,15,14,14,13,12,12,11,10,8,7,6,4,3,1,0,-1,-3,-4,-6,-7,-8,-10,-11,-12,-12,-13,-14,-14,-15,-15,-15,-15,-15,-14,-14,-13,-12,-12,-11,-10,-8,-7,-6,-4,-3,-1,0,2,3,5,7,8,9,11,12,13,14,15,16,16,17,17,17,17,17,16,16,15,14,13,12,11,9,8,7,5,3,2,0,-2,-3,-5,-7,-8,-9,-11,-12,-13,-14,-15,-16,-16,-17,-17,-17,-17,-17,-16,-16,-15,-14,-13,-12,-11,-9,-8,-7,-5,-3,-2,0,2,4,6,7,9,11,12,13,15,16,17,18,18,19,19,19,19,19,18,18,17,16,15,13,12,11,9,7,6,4,2,0,-2,-4,-6,-7,-9,-11,-12,-13,-15,-16,-17,-18,-18,-19,-19,-19,-19,-19,-18,-18,-17,-16,-15,-13,-12,-11,-9,-7,-6,-4,-2,0,2,4,6,8,10,12,13,15,16,17,19,19,20,21,21,21,21,21,20,19,19,17,16,15,13,12,10,8,6,4,2,0,-2,-4,-6,-8,-10,-12,-13,-15,-16,-17,-19,-19,-20,-21,-21,-21,-21,-21,-20,-19,-19,-17,-16,-15,-13,-12,-10,-8,-6,-4,-2,0,2,4,7,9,11,13,15,16,18,19,20,21,22,23,23,23,23,23,22,21,20,19,18,16,15,13,11,9,7,4,2,0,-2,-4,-7,-9,-11,-13,-15,-16,-18,-19,-20,-21,-22,-23,-23,-23,-23,-23,-22,-21,-20,-19,-18,-16,-15,-13,-11,-9,-7,-4,-2,0,2,5,7,10,12,14,16,18,19,21,22,23,24,25,25,25,25,25,24,23,22,21,19,18,16,14,12,10,7,5,2,0,-2,-5,-7,-10,-12,-14,-16,-18,-19,-21,-22,-23,-24,-25,-25,-25,-25,-25,-24,-23,-22,-21,-19,-18,-16,-14,-12,-10,-7,-5,-2,0,3,5,8,10,13,15,17,19,21,22,24,25,26,26,27,27,27,26,26,25,24,22,21,19,17,15,13,10,8,5,3,0,-3,-5,-8,-10,-13,-15,-17,-19,-21,-22,-24,-25,-26,-26,-27,-27,-27,-26,-26,-25,-24,-22,-21,-19,-17,-15,-13,-10,-8,-5,-3,0,3,6,8,11,14,16,18,21,22,24,26,27,28,28,29,29,29,28,28,27,26,24,22,21,18,16,14,11,8,6,3,0,-3,-6,-8,-11,-14,-16,-18,-21,-22,-24,-26,-27,-28,-28,-29,-29,-29,-28,-28,-27,-26,-24,-22,-21,-18,-16,-14,-11,-8,-6,-3],a}();