/*!
 * SAASound is a Phillips SAA 1099 sound chip emulator
 * Copyright (c) 2015 Martin Borik <mborik@users.sourceforge.net>
 * Based on SAASound - portable C/C++ library
 * Copyright (c) 1998-2004 Dave Hooper <stripwax@users.sourceforge.net>
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom
 * the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS
 * OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF
 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
var SAASound=function(){function a(b){this.nCurrentReg=0,this.bOutputEnabled=!1,this.bAmpMuted=[!1,!1,!1,!1,!1,!1],a.nSampleRate=b,this.Env=[new SAAEnv,new SAAEnv],this.Noise=[new SAANoise(347034121),new SAANoise(1990832414)],this.Osc=[new SAAFreq(this.Noise[0]),new SAAFreq(null,this.Env[0]),new SAAFreq,new SAAFreq(this.Noise[1]),new SAAFreq(null,this.Env[1]),new SAAFreq],this.Amp=[new SAAAmp(this.Osc[0],this.Noise[0]),new SAAAmp(this.Osc[1],this.Noise[0]),new SAAAmp(this.Osc[2],this.Noise[0],this.Env[0]),new SAAAmp(this.Osc[3],this.Noise[1]),new SAAAmp(this.Osc[4],this.Noise[1]),new SAAAmp(this.Osc[5],this.Noise[1],this.Env[1])],this.Clear()}return a.prototype.Clear=function(){this.WriteAddressData(28,2);for(var a=31;a>=0;a--)28!=a&&this.WriteAddressData(a,0);this.WriteAddressData(28,0),this.WriteAddress(0)},a.prototype.WriteData=function(a){a&=255;var b=this.nCurrentReg;switch(b){case 0:case 1:case 2:case 3:case 4:case 5:this.Amp[b].SetAmpLevel(a);break;case 8:case 9:case 10:case 11:case 12:case 13:this.Osc[7&b].SetFreqOffset(a);break;case 16:this.Osc[0].SetFreqOctave(7&a),this.Osc[1].SetFreqOctave(a>>4&7);break;case 17:this.Osc[2].SetFreqOctave(7&a),this.Osc[3].SetFreqOctave(a>>4&7);break;case 18:this.Osc[4].SetFreqOctave(7&a),this.Osc[5].SetFreqOctave(a>>4&7);break;case 20:this.Amp[0].SetToneMixer(1&a),this.Amp[1].SetToneMixer(2&a),this.Amp[2].SetToneMixer(4&a),this.Amp[3].SetToneMixer(8&a),this.Amp[4].SetToneMixer(16&a),this.Amp[5].SetToneMixer(32&a);break;case 21:this.Amp[0].SetNoiseMixer(1&a),this.Amp[1].SetNoiseMixer(2&a),this.Amp[2].SetNoiseMixer(4&a),this.Amp[3].SetNoiseMixer(8&a),this.Amp[4].SetNoiseMixer(16&a),this.Amp[5].SetNoiseMixer(32&a);break;case 22:this.Noise[0].SetSource(3&a),this.Noise[1].SetSource(a>>4&3);break;case 24:this.Env[0].SetEnvControl(a);break;case 25:this.Env[1].SetEnvControl(a);break;case 28:var c,d=!(1&a),e=!!(2&a);for(c=0;6>c;c++)this.Osc[c].Sync(e);if(this.Noise[0].Sync(e),this.Noise[1].Sync(e),this.bSync=e,d){for(c=0;6>c;c++)this.Amp[c].Mute(d);this.bOutputEnabled=!1}else{for(c=0;6>c;c++)this.Amp[c].Mute(this.bAmpMuted[c]);this.bOutputEnabled=!0}}},a.prototype.ReadAddress=function(){return this.nCurrentReg},a.prototype.WriteAddress=function(a){this.nCurrentReg=a&=31,24===a?this.Env[0].ExternalClock():25===a&&this.Env[1].ExternalClock()},a.prototype.WriteAddressData=function(a,b){this.WriteAddress(a),this.WriteData(b)},a.prototype.MuteAmp=function(a,b){0>a||a>=6||this.Amp[a].Mute(this.bAmpMuted[a]=b)},a.prototype.GenerateMono=function(a,b){for(var c,d=0;b>d;)this.Noise[0].Tick(),this.Noise[1].Tick(),c=this.Amp[0].TickAndOutputMono()+this.Amp[1].TickAndOutputMono()+this.Amp[2].TickAndOutputMono()+this.Amp[3].TickAndOutputMono()+this.Amp[4].TickAndOutputMono()+this.Amp[5].TickAndOutputMono(),a[d++]=c/12672},a.prototype.GenerateStereo=function(a,b,c){for(var d,e,f,g=0;c>g;)this.Noise[0].Tick(),this.Noise[1].Tick(),d=this.Amp[0].TickAndOutputStereo(),e=d.Left,f=d.Right,d=this.Amp[1].TickAndOutputStereo(),e+=d.Left,f+=d.Right,d=this.Amp[2].TickAndOutputStereo(),e+=d.Left,f+=d.Right,d=this.Amp[3].TickAndOutputStereo(),e+=d.Left,f+=d.Right,d=this.Amp[4].TickAndOutputStereo(),e+=d.Left,f+=d.Right,d=this.Amp[5].TickAndOutputStereo(),e+=d.Left,f+=d.Right,b[g]=f/2880,a[g++]=e/2880},a}(),SAANoise=function(){function a(a){void 0===a&&(a=286331153),this.nCounter=0,this.nAdd=128e6,this.bSync=!1,this.nSmpRate=SAASound.nSampleRate<<12,this.nSource=0,this.nRand=a}return a.prototype.Level=function(){return(1&this.nRand)<<1},a.prototype.SetSource=function(a){this.nSource=a&=3,this.nAdd=128e6>>a},a.prototype.Trigger=function(){3===this.nSource&&this.ChangeLevel()},a.prototype.Tick=function(){if(!this.bSync&&3!=this.nSource&&(this.nCounter+=this.nAdd,this.nCounter>=this.nSmpRate))for(;this.nCounter>=this.nSmpRate;)this.nCounter-=this.nSmpRate,this.ChangeLevel();return 1&this.nRand},a.prototype.Sync=function(a){a&&(this.nCounter=0),this.bSync=a},a.prototype.ChangeLevel=function(){1073741828&this.nRand&&1073741828!=(1073741828&this.nRand)?this.nRand=this.nRand<<1|1:this.nRand<<=1},a}(),SAAEnv=function(){function a(){this.cs_EnvData=[{nPhases:1,bLooping:!1,aLevels:[[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]]},{nPhases:1,bLooping:!0,aLevels:[[[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15],[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15]],[[14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14],[14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14]]]},{nPhases:1,bLooping:!1,aLevels:[[[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],[[14,14,12,12,10,10,8,8,6,6,4,4,2,2,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]]},{nPhases:1,bLooping:!0,aLevels:[[[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],[[14,14,12,12,10,10,8,8,6,6,4,4,2,2,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]]},{nPhases:2,bLooping:!1,aLevels:[[[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0]],[[0,0,2,2,4,4,6,6,8,8,10,10,12,12,14,14],[14,14,12,12,10,10,8,8,6,6,4,4,2,2,0,0]]]},{nPhases:2,bLooping:!0,aLevels:[[[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0]],[[0,0,2,2,4,4,6,6,8,8,10,10,12,12,14,14],[14,14,12,12,10,10,8,8,6,6,4,4,2,2,0,0]]]},{nPhases:1,bLooping:!1,aLevels:[[[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,2,2,4,4,6,6,8,8,10,10,12,12,14,14],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]]},{nPhases:1,bLooping:!0,aLevels:[[[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,2,2,4,4,6,6,8,8,10,10,12,12,14,14],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]]}],this.bEnabled=!1,this.bNewData=!1,this.nNextData=0,this.bOkForNewData=!1,this.SetNewEnvData()}return a.prototype.InternalClock=function(){this.bEnabled&&!this.bClockExternally&&this.Tick()},a.prototype.ExternalClock=function(){this.bEnabled&&this.bClockExternally&&this.Tick()},a.prototype.SetEnvControl=function(a){return this.nResolution=!!(16&a),this.bEnabled=!!(128&a),this.bEnabled?void(this.bOkForNewData?(this.SetNewEnvData(a),this.bNewData=!1,this.bOkForNewData=!1):(this.SetLevels(),this.bNewData=!0,this.nNextData=a)):(this.nPhase=0,this.nPhasePosition=0,this.bEnded=!0,this.bOkForNewData=!0,this.bNewData=!0,this.nNextData=a,this.SetLevels())},a.prototype.Tick=function(){return this.bEnabled?void(this.bEnded||(this.nPhasePosition+=this.nResolution?2:1,this.nPhasePosition>=16?(this.nPhase++,this.nPhasePosition-=16,this.nPhase===this.nPhases?(this.bOkForNewData=!0,this.bLooping?(this.bEnded=!1,this.nPhase=0):(this.bEnded=!0,this.nPhase=this.nPhases-1,this.nPhasePosition=15,this.bOkForNewData=!0)):this.bOkForNewData=!1):this.bOkForNewData=!1,this.bNewData&&this.bOkForNewData?(this.bNewData=!1,this.bOkForNewData=!1,this.SetNewEnvData(this.nNextData)):this.SetLevels())):(this.bEnded=!0,this.nPhase=0,this.nPhasePosition=0,void(this.bOkForNewData=!0))},a.prototype.SetLevels=function(){var a=0+this.nResolution;this.nLeftLevel=this.pEnvData.aLevels[a][this.nPhase][this.nPhasePosition],this.bStereo?this.nRightLevel=15-a-this.nLeftLevel:this.nRightLevel=this.nLeftLevel},a.prototype.SetNewEnvData=function(a){void 0===a&&(a=0),this.nPhase=0,this.nPhasePosition=0,this.pEnvData=this.cs_EnvData[a>>1&7],this.bStereo=!!(1&a),this.bClockExternally=!!(32&a),this.nPhases=this.pEnvData.nPhases,this.bLooping=this.pEnvData.bLooping,this.nResolution=!!(16&a),this.bEnabled=!!(128&a),this.bEnabled?this.bEnded=!1:(this.bEnded=!0,this.nPhase=0,this.nPhasePosition=0,this.bOkForNewData=!0),this.SetLevels()},a.prototype.LeftLevel=function(){return this.nLeftLevel},a.prototype.RightLevel=function(){return this.nRightLevel},a.prototype.IsActive=function(){return this.bEnabled},a}(),SAAFreq=function(){function a(a,b){this.nCounter=0,this.nAdd=0,this.nCurrentOffset=0,this.nCurrentOctave=0,this.nNextOffset=0,this.nNextOctave=0,this.bIgnoreOffsetData=!1,this.bNewData=!1,this.bSync=!1,this.nLevel=2,this.nSmpRate=SAASound.nSampleRate<<12,this.pcConnectedNoiseGenerator=a,this.pcConnectedEnvGenerator=b,this.nConnectedMode=a?2:b?1:0,this.SetAdd()}return a.prototype.Level=function(){return this.nLevel},a.prototype.SetFreqOffset=function(a){this.bSync?(this.bNewData=!1,this.nCurrentOffset=a,this.nCurrentOctave=this.nNextOctave,this.SetAdd()):(this.nNextOffset=a,this.bNewData=!0,this.nNextOctave==this.nCurrentOctave&&(this.bIgnoreOffsetData=!0))},a.prototype.SetFreqOctave=function(a){this.bSync?(this.bNewData=!1,this.nCurrentOctave=a,this.nCurrentOffset=this.nNextOffset,this.SetAdd()):(this.nNextOctave=a,this.bNewData=!0,this.bIgnoreOffsetData=!1)},a.prototype.UpdateOctaveOffsetData=function(){this.bNewData&&(this.nCurrentOctave=this.nNextOctave,this.bIgnoreOffsetData||(this.nCurrentOffset=this.nNextOffset,this.bNewData=!1),this.bIgnoreOffsetData=!1,this.SetAdd())},a.prototype.Tick=function(){if(!this.bSync&&(this.nCounter+=this.nAdd,this.nCounter>=this.nSmpRate)){for(;this.nCounter>=this.nSmpRate;)this.nCounter-=this.nSmpRate,this.nLevel=2-this.nLevel,1===this.nConnectedMode?this.pcConnectedEnvGenerator.InternalClock():2===this.nConnectedMode&&this.pcConnectedNoiseGenerator.Trigger();this.UpdateOctaveOffsetData()}return this.nLevel},a.prototype.Sync=function(a){this.bSync=a,a&&(this.nCounter=0,this.nLevel=2,this.nCurrentOctave=this.nNextOctave,this.nCurrentOffset=this.nNextOffset,this.SetAdd())},a.prototype.SetAdd=function(){var a=this.nCurrentOctave+13,b=511^this.nCurrentOffset;this.nAdd=(15625<<a)/b>>0},a}(),SAAAmp=function(){function a(a,b,c){this.last_level_byte=0,this.leftleveltimes16=0,this.leftleveltimes32=0,this.leftlevela0x0e=0,this.leftlevela0x0etimes2=0,this.rightleveltimes16=0,this.rightleveltimes32=0,this.rightlevela0x0e=0,this.rightlevela0x0etimes2=0,this.monoleveltimes16=0,this.monoleveltimes32=0,this.nOutputIntermediate=0,this.nMixMode=0,this.pcConnectedToneGenerator=a,this.pcConnectedNoiseGenerator=b,this.pcConnectedEnvGenerator=c,this.bUseEnvelope=!!c,this.bMute=!0}return a.prototype.SetAmpLevel=function(a){(a&=255)!==this.last_level_byte&&(this.last_level_byte=a,this.leftlevela0x0e=14&a,this.leftlevela0x0etimes2=this.leftlevela0x0e<<1,this.leftleveltimes16=(15&a)<<4,this.leftleveltimes32=this.leftleveltimes16<<1,this.rightlevela0x0e=a>>4&14,this.rightlevela0x0etimes2=this.rightlevela0x0e<<1,this.rightleveltimes16=240&a,this.rightleveltimes32=this.rightleveltimes16<<1,this.monoleveltimes16=this.leftleveltimes16+this.rightleveltimes16,this.monoleveltimes32=this.leftleveltimes32+this.rightleveltimes32)},a.prototype.SetToneMixer=function(a){a?this.nMixMode|=1:this.nMixMode&=-2},a.prototype.SetNoiseMixer=function(a){a?this.nMixMode|=2:this.nMixMode&=-3},a.prototype.Tick=function(){switch(this.nMixMode){case 0:this.pcConnectedToneGenerator.Tick(),this.nOutputIntermediate=0;break;case 1:this.nOutputIntermediate=this.pcConnectedToneGenerator.Tick();break;case 2:this.pcConnectedToneGenerator.Tick(),this.nOutputIntermediate=this.pcConnectedNoiseGenerator.Level();break;case 3:this.nOutputIntermediate=this.pcConnectedToneGenerator.Tick(),2===this.nOutputIntermediate&&this.pcConnectedNoiseGenerator.Level()&&(this.nOutputIntermediate=1)}},a.prototype.TickAndOutputMono=function(){if(this.Tick(),this.bMute)return 0;var a=0,b=this.nOutputIntermediate;return this.bUseEnvelope&&this.pcConnectedEnvGenerator.IsActive()?0===b?a=this.pcConnectedEnvGenerator.LeftLevel()*this.leftlevela0x0etimes2+this.pcConnectedEnvGenerator.RightLevel()*this.rightlevela0x0etimes2:1===b&&(a=this.pcConnectedEnvGenerator.LeftLevel()*this.leftlevela0x0e+this.pcConnectedEnvGenerator.RightLevel()*this.rightlevela0x0e):1===b?a=this.monoleveltimes16:2===b&&(a=this.monoleveltimes32),a},a.prototype.TickAndOutputStereo=function(){this.Tick();var a={Left:0,Right:0},b=this.nOutputIntermediate;return this.bMute?a:(this.bUseEnvelope&&this.pcConnectedEnvGenerator.IsActive()?0===b?(a.Left=this.pcConnectedEnvGenerator.LeftLevel()*this.leftlevela0x0etimes2,a.Right=this.pcConnectedEnvGenerator.RightLevel()*this.rightlevela0x0etimes2):1===b&&(a.Left=this.pcConnectedEnvGenerator.LeftLevel()*this.leftlevela0x0e,a.Right=this.pcConnectedEnvGenerator.RightLevel()*this.rightlevela0x0e):1===b?(a.Left=this.leftleveltimes16,a.Right=this.rightleveltimes16):2===b&&(a.Left=this.leftleveltimes32,a.Right=this.rightleveltimes32),a)},a.prototype.Mute=function(a){this.bMute=a},a}();