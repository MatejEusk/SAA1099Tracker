/*!
 * SAASound is a Phillips SAA 1099 sound chip emulator
 * Copyright (c) 2015 Martin Borik <mborik@users.sourceforge.net>
 * Based on SAASound - portable C/C++ library
 * Copyright (c) 1998-2004 Dave Hooper <stripwax@users.sourceforge.net>
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom
 * the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS
 * OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF
 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
var SAASound=function(){function a(b){this.register=0,this.enabled=!1,this.ampMuted=[!1,!1,!1,!1,!1,!1],a.sampleRate=b,this.env=[new SAAEnv,new SAAEnv],this.noise=[new SAANoise(347034121),new SAANoise(1990832414)],this.freq=[new SAAFreq(this.noise[0]),new SAAFreq(null,this.env[0]),new SAAFreq,new SAAFreq(this.noise[1]),new SAAFreq(null,this.env[1]),new SAAFreq],this.amp=[new SAAAmp(this.freq[0],this.noise[0]),new SAAAmp(this.freq[1],this.noise[0]),new SAAAmp(this.freq[2],this.noise[0],this.env[0]),new SAAAmp(this.freq[3],this.noise[1]),new SAAAmp(this.freq[4],this.noise[1]),new SAAAmp(this.freq[5],this.noise[1],this.env[1])],this.clear()}return a.prototype.clear=function(){this.setRegData(28,2);for(var a=31;a>=0;a--)28!=a&&this.setRegData(a,0);this.setRegData(28,0),this.setReg(0)},a.prototype.setData=function(a){a&=255;var b=this.register;switch(b){case 0:case 1:case 2:case 3:case 4:case 5:this.amp[b].setLevel(a);break;case 8:case 9:case 10:case 11:case 12:case 13:this.freq[7&b].setOffset(a);break;case 16:this.freq[0].setOctave(7&a),this.freq[1].setOctave(a>>4&7);break;case 17:this.freq[2].setOctave(7&a),this.freq[3].setOctave(a>>4&7);break;case 18:this.freq[4].setOctave(7&a),this.freq[5].setOctave(a>>4&7);break;case 20:this.amp[0].setFreqMixer(1&a),this.amp[1].setFreqMixer(2&a),this.amp[2].setFreqMixer(4&a),this.amp[3].setFreqMixer(8&a),this.amp[4].setFreqMixer(16&a),this.amp[5].setFreqMixer(32&a);break;case 21:this.amp[0].setNoiseMixer(1&a),this.amp[1].setNoiseMixer(2&a),this.amp[2].setNoiseMixer(4&a),this.amp[3].setNoiseMixer(8&a),this.amp[4].setNoiseMixer(16&a),this.amp[5].setNoiseMixer(32&a);break;case 22:this.noise[0].set(3&a),this.noise[1].set(a>>4&3);break;case 24:this.env[0].set(a);break;case 25:this.env[1].set(a);break;case 28:var c,d=!(1&a),e=!!(2&a);for(c=0;6>c;c++)this.freq[c].setSync(e);if(this.noise[0].setSync(e),this.noise[1].setSync(e),this.sync=e,d){for(c=0;6>c;c++)this.amp[c].mute=d;this.enabled=!1}else{for(c=0;6>c;c++)this.amp[c].mute=this.ampMuted[c];this.enabled=!0}}},a.prototype.getReg=function(){return this.register},a.prototype.setReg=function(a){this.register=a&=31,24===a?this.env[0].tickExt():25===a&&this.env[1].tickExt()},a.prototype.setRegData=function(a,b){this.setReg(a),this.setData(b)},a.prototype.mute=function(a,b){0>a||a>=6||(this.amp[a].mute=this.ampMuted[a]=b)},a.prototype.output=function(a,b,c){for(var d,e=0;c>e;e++)this.noise[0].tick(),this.noise[1].tick(),d=new Float32Array([0,0]),this.amp[0].output(d),this.amp[1].output(d),this.amp[2].output(d),this.amp[3].output(d),this.amp[4].output(d),this.amp[5].output(d),a[e]=d[0],b[e]=d[1]},a}(),SAANoise=function(){function a(a){void 0===a&&(a=286331153),this.counter=0,this.add=128e6,this.sync=!1,this.smpRate=SAASound.sampleRate<<12,this.src=0,this.rand=a}return a.prototype.set=function(a){this.src=a&=3,this.add=128e6>>a},a.prototype.trigger=function(){3===this.src&&this.rnd()},a.prototype.tick=function(){if(!this.sync&&3!=this.src&&(this.counter+=this.add,this.counter>=this.smpRate))for(;this.counter>=this.smpRate;)this.counter-=this.smpRate,this.rnd();return 1&this.rand},a.prototype.setSync=function(a){a&&(this.counter=0),this.sync=a},a.prototype.rnd=function(){1073741828&this.rand&&1073741828!=(1073741828&this.rand)?this.rand=this.rand<<1|1:this.rand<<=1,this.level=(1&this.rand)<<1},a}(),SAAEnv=function(){function a(){this.envtable=[{plen:1,loop:!1,data:[[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]]},{plen:1,loop:!0,data:[[[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15],[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15]],[[14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14],[14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14]]]},{plen:1,loop:!1,data:[[[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],[[14,14,12,12,10,10,8,8,6,6,4,4,2,2,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]]},{plen:1,loop:!0,data:[[[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],[[14,14,12,12,10,10,8,8,6,6,4,4,2,2,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]]},{plen:2,loop:!1,data:[[[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0]],[[0,0,2,2,4,4,6,6,8,8,10,10,12,12,14,14],[14,14,12,12,10,10,8,8,6,6,4,4,2,2,0,0]]]},{plen:2,loop:!0,data:[[[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0]],[[0,0,2,2,4,4,6,6,8,8,10,10,12,12,14,14],[14,14,12,12,10,10,8,8,6,6,4,4,2,2,0,0]]]},{plen:1,loop:!1,data:[[[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,2,2,4,4,6,6,8,8,10,10,12,12,14,14],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]]},{plen:1,loop:!0,data:[[[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,2,2,4,4,6,6,8,8,10,10,12,12,14,14],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]]}],this.enabled=!1,this.newData=!1,this.nextData=0,this.processData=!1,this.loadData()}return a.prototype.tickInt=function(){this.enabled&&!this.extclock&&this.tick()},a.prototype.tickExt=function(){this.enabled&&this.extclock&&this.tick()},a.prototype.set=function(a){return this.res=!!(16&a),this.enabled=!!(128&a),this.enabled?void(this.processData?(this.loadData(a),this.newData=!1,this.processData=!1):(this.setLevels(),this.newData=!0,this.nextData=a)):(this.phase=0,this.position=0,this.ended=!0,this.processData=!0,this.newData=!0,this.nextData=a,this.setLevels())},a.prototype.tick=function(){return this.enabled?void(this.ended||(this.position+=this.res?2:1,this.position>=16?(this.phase++,this.position-=16,this.phase===this.phaseLen?(this.processData=!0,this.loop?(this.ended=!1,this.phase=0):(this.ended=!0,this.phase=this.phaseLen-1,this.position=15,this.processData=!0)):this.processData=!1):this.processData=!1,this.newData&&this.processData?(this.newData=!1,this.processData=!1,this.loadData(this.nextData)):this.setLevels())):(this.ended=!0,this.phase=0,this.position=0,void(this.processData=!0))},a.prototype.setLevels=function(){var a=0+this.res;this.left=this.envdata.data[a][this.phase][this.position],this.stereo?this.right=15-a-this.left:this.right=this.left},a.prototype.loadData=function(a){void 0===a&&(a=0),this.phase=0,this.position=0,this.envdata=this.envtable[a>>1&7],this.stereo=!!(1&a),this.extclock=!!(32&a),this.phaseLen=this.envdata.plen,this.loop=this.envdata.loop,this.res=!!(16&a),this.enabled=!!(128&a),this.enabled?this.ended=!1:(this.ended=!0,this.phase=0,this.position=0,this.processData=!0),this.setLevels()},a}(),SAAFreq=function(){function a(a,b){this.counter=0,this.add=0,this.curOffset=0,this.curOctave=0,this.nextOffset=0,this.nextOctave=0,this.ignoreOffset=!1,this.newdata=!1,this.sync=!1,this.level=2,this.smpRate=SAASound.sampleRate<<12,this.noiseGen=a,this.envGen=b,this.mode=a?2:b?1:0,this.freqs=[];for(var c,d=0;8>d;d++)for(this.freqs[d]=[],c=0;256>c;c++)this.freqs[d][c]=Math.round((128e6<<d>>>0)/(511-c));this.add=this.freqs[this.curOctave][this.curOffset]}return a.prototype.setOffset=function(a){this.sync?(this.newdata=!1,this.curOffset=a,this.curOctave=this.nextOctave,this.add=this.freqs[this.curOctave][this.curOffset]):(this.nextOffset=a,this.newdata=!0,this.nextOctave==this.curOctave&&(this.ignoreOffset=!0))},a.prototype.setOctave=function(a){this.sync?(this.newdata=!1,this.curOctave=a,this.curOffset=this.nextOffset,this.add=this.freqs[this.curOctave][this.curOffset]):(this.nextOctave=a,this.newdata=!0,this.ignoreOffset=!1)},a.prototype.update=function(){this.newdata&&(this.curOctave=this.nextOctave,this.ignoreOffset||(this.curOffset=this.nextOffset,this.newdata=!1),this.ignoreOffset=!1,this.add=this.freqs[this.curOctave][this.curOffset])},a.prototype.tick=function(){if(!this.sync&&(this.counter+=this.add,this.counter>=this.smpRate)){for(;this.counter>=this.smpRate;)this.counter-=this.smpRate,this.level=2-this.level,1===this.mode?this.envGen.tickInt():2===this.mode&&this.noiseGen.trigger();this.update()}return this.level},a.prototype.setSync=function(a){this.sync=a,a&&(this.counter=0,this.level=2,this.curOctave=this.nextOctave,this.curOffset=this.nextOffset,this.add=this.freqs[this.curOctave][this.curOffset])},a}(),SAAAmp=function(){function a(a,b,c){this.lastlvl=0,this.leftx16=0,this.leftx32=0,this.lefta0E=0,this.lefta0Ex2=0,this.rightx16=0,this.rightx32=0,this.righta0E=0,this.righta0Ex2=0,this.out=0,this.mix=0,this.toneGen=a,this.noiseGen=b,this.envGen=c,this.env=!!c,this.mute=!0,this.levels=new Float32Array(512);for(var d=0;512>d;d++)this.levels[d]=d/2880}return a.prototype.setLevel=function(a){(a&=255)!==this.lastlvl&&(this.lastlvl=a,this.lefta0E=14&a,this.lefta0Ex2=this.lefta0E<<1,this.leftx16=(15&a)<<4,this.leftx32=this.leftx16<<1,this.righta0E=a>>4&14,this.righta0Ex2=this.righta0E<<1,this.rightx16=240&a,this.rightx32=this.rightx16<<1)},a.prototype.setFreqMixer=function(a){this.mix=a?1|this.mix:2&this.mix},a.prototype.setNoiseMixer=function(a){this.mix=a?2|this.mix:1&this.mix},a.prototype.tick=function(){switch(this.mix){case 0:this.toneGen.tick(),this.out=0;break;case 1:this.out=this.toneGen.tick();break;case 2:this.toneGen.tick(),this.out=this.noiseGen.level;break;case 3:this.out=this.toneGen.tick(),2===this.out&&this.noiseGen.level&&(this.out=1)}},a.prototype.output=function(a){if(this.tick(),!this.mute){var b=this.env&&this.envGen.enabled;0===this.out?b&&(a[0]+=this.levels[this.envGen.left*this.lefta0Ex2],a[1]+=this.levels[this.envGen.right*this.righta0Ex2]):1===this.out?b?(a[0]+=this.levels[this.envGen.left*this.lefta0E],a[1]+=this.levels[this.envGen.right*this.righta0E]):(a[0]+=this.levels[this.leftx16],a[1]+=this.levels[this.rightx16]):2===this.out&&(b||(a[0]+=this.levels[this.leftx32],a[1]+=this.levels[this.rightx32]))}},a}();